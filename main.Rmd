---
title: "Labor Share & Aging Population"
author: "Fabien Petit"
output:	
  github_document:	
    pandoc_args: --webtex
---

## Data

### Raw data

Data are from :

* Penn World Table 9.1
* OECD Database
* United Nations (World Population Prospects)

```{r Initialization, include = FALSE}

# Define paths
loc_result = file.path(getwd(), "result")
loc_sim = file.path(loc_result, "sim")
loc_function = file.path(getwd(), "function")
loc_final = file.path(getwd(), "data", "final")

# Load packages
packages <- c("bucky", "dplyr", "ggplot2", "ggrepel", "lmtest", "sandwich", "zoo", "RColorBrewer", "reshape2")
lapply(packages, require, character.only = TRUE)
rm(packages)

# Load functions
sapply(list.files(pattern = "[.]R$", path = loc_function, full.names = TRUE), source)

```

```{r Simulation specification, include = FALSE}

# Country set
country_set = c("France", "United States")

# Simulation periods
sim = seq(1970, 2080, 10)

# Estimation sample
est_sample = c(1970:2010)

```

```{r Load data, include = FALSE}

# Penn World Table
pwt = read.csv(file.path(loc_final, "pwt.csv"), header = TRUE) %>%
  select("Country", "Year", "emp", "avh", "rgdpna", "rnna", "lab_sh1") %>% 
  subset(Country %in% country_set & Year >= 1970)

# OECD data
oecd = read.csv(file.path(loc_final, "oecd.csv"), header = TRUE) %>% 
  select("Country", "Year", tax_rate = "tax_rev_PC_GDP", union_density = "union_density.lin_inter", union_coverage = "union_coverage.lin_inter") %>% 
  subset(Country %in% country_set & Year >= 1970)

# Demographic data
demo = read.csv(file.path(loc_final, "demo.csv"), header = TRUE) %>% 
  select("Country", "Year", "young", "old", "dep", "n", "p") %>% 
  subset(Country %in% country_set & Year >= 1970)

## Merge
df = merge(merge(pwt, oecd, all = TRUE), demo, all = TRUE)

```

```{r Data retreatment, echo = FALSE}

# Variable modifications
df = df %>%
  group_by(Country) %>% 
  mutate(L = emp * 1000,
         Y = rgdpna / avh * 1000, # AVH control
         K = rnna / avh * 1000, # AVH control
         theta = lab_sh1, # Labor share
         tau = tax_rate / 100, # Tax rate
         u = 1 - L / (young+old), # Unemployment rate
         p1 = lead(p, 40)) %>% 
  select(Country, Year, Ny = young, No = old, n, p, p1, dep, K, L, Y, theta, tau, u) %>% 
  mutate(L = L / first(L), # Normalized labor
         K = K / first(K), # Normalized capital
         Y = Y / first(Y), # Normalized output
         k = K / L, # Normalized capital-labor ratio
         Ny = L / (1-u), # Normalized young population
         No = Ny * dep) %>% # Normalized old population
  ungroup()

# Remove unused countries from Country levels
df$Country = df$Country %>% as.character %>% as.factor()

# Visualization
head(df)

# Write df
write.csv(df, file.path(loc_sim, "data.csv"), row.names = FALSE)

```

### Data for simulation

```{r Data for simulation, echo = FALSE}

init_seq = seq(1970, 2000, 10)

# Baseline data
data_base = df %>% 
  group_by(Country) %>% 
  subset(Year %in% sim) %>% 
  select(Country, Year, Ny, No, n, p, p1, K) %>% 
  mutate(Sequence = ((sim - 1970)/10) %% 4 + 1,
         Period = (sim - init_seq) / 40 + 1,
         Ny = ifelse(Year == 2010, NA, Ny),
         No = ifelse(Year == 2010, NA, No),
         K = ifelse(Year == 2010, NA, K),
         # Complete NA values for p1 in 2070 and 2080
         p1 = ifelse(Year >= 2070, p1[Year == 2060] + 
                       (Year - 2060)/10 * mean(p1/lag(p1)-1, na.rm = T), p1), 
         ## Create empty variables
         eta = NA, AK = NA, AL = NA, k1 = NA, k2 = NA, k = NA, X = NA, L = NA, w = NA, Y = NA, u = NA,
         theta = NA, tau = NA, b = NA, h = NA, S = NA) 

# Re-order variables
data_base = data_base %>% select(Country, Year, Sequence, Period, Ny, No, n, p, p1, eta, AK, AL,
                                 k1, k2, k, X, L, w, Y, u, theta, tau, b, h, S, K)
  
# Visualization
head(data_base)

```

```{r Initial Specification, include = FALSE}

data = data_base %>% 
  # No biased technical change
  mutate(AK = 1, AL = 1) %>% 
  # Population dynamics
  demo_changer(init_spe = TRUE)

```


## Parameter calibration

The discount factor $\alpha$ is set to `r round(0.99^40,3)`. The relative bargaining power of the union $\gamma$ is set to `r 0.5`. *For more details, please consult "gamma.md" file.*

```{r Parameter - Dataframe, include = FALSE}

param_base = data.frame("Country" = rep(c("France", "United States"), each = length(sim)),
                   "Year" = sim, "alpha" = (0.99)^40, "gamma" = 0.5)

```

### Production function

I estimate the elasticity of substitution between capital and labor using the methodology of **Leon-Ledesma, McAdam & Willman (2013)**. Estimation are done for France and United States between 1970 and 2010, using Penn World Table 9.1 data. *For more details, please consult "sigma.md" file.*

```{r Parameter - Production function, echo = FALSE}

# Estimation
ols_sigma = df %>% 
  group_by(Country) %>% 
  mutate(k_log = log(k),
         THETA_log_neg = - log((1-theta)/theta),
         t_diff = Year - first(Year) + 1) %>% 
  select(Country, Year, k_log, THETA_log_neg, t_diff) %>% 
  subset(Year %in% c(1970:2010)) %>% 
  ungroup() %>% 
  lm(k_log ~ Country + THETA_log_neg*Country + t_diff*Country - THETA_log_neg - t_diff, data = .)

# Result visualization
robust.summary(ols_sigma)

# Add production function parameters
param_base = param_base %>%
  mutate("phi" = rep(1 - df$theta[df$Year == 1970], each = length(sim)), 
         "sigma" = rep(1/(1+ols_sigma$coefficients[c((length(country_set)+1):(2*length(country_set)))]),
                               each = length(sim)),
         "a" = rep(ols_sigma$coefficients[c((2*length(country_set)+1):(3*length(country_set)))],
                   each = length(sim)))

# Visualization
param_base %>% subset(Year == 1970) %>% select(Country, phi, sigma, a)

```

### Preferences

The relative per-capita influence of old households $\omega$ is deduced such that the capital-to-labor ratio is matched in 1970. The preference for government health expenditure $\beta$ is deduced such that the tax rate in 1970 is matched.

```{r Parameter - Preferences, echo = FALSE}

# Compute omega and beta
param_base = df %>%
  subset(Year == 1970) %>% 
  merge(param_base) %>%
  mutate(X = (sigma + (1-phi)/phi*(1-gamma*(1-sigma))/gamma)^(-1),
         omega = phi/(1-phi)*n/p*(1+alpha*p1)/(1 + exp(-X)*(Ny - 1)),
         eta = n/p*(1+alpha*p1)/omega,
         beta = 1/(1 - tau)/phi - 1 - eta) %>% 
  select(Country, omega, beta) %>% 
  merge(param_base) %>% 
  # Reorder parameters in dataframe
  select(Country, Year, names(param_base), everything())

# Visualization
param_base %>% subset(Year == 1970) %>% select(Country, omega, beta)

```

### Scale parameter

The scale parameter $A$ is decuded using grid search to match the average labor share between 2008 and 2012.

```{r Parameter - Scale parameter, echo = FALSE}

data = data_base %>% 
  # No biased technical change
  mutate(AK = 1, AL = 1) %>% 
  # Add parameters
  merge(param_base) %>% 
  # Demography
  demo_changer(AFinder = TRUE)

# A Finder script
source("./script/sim_AFinder.R")

# Assign A scale parameter to param_base
param_base$A = data$A

```

### Summary

All parameters are constant over time.

```{r Parameter -  Summary, echo = FALSE}

# Visualization
param_base %>% subset(Year == 1970) %>% select(-Year, -a)

param = param_base

```

## Simulation

### Baseline model

```{r Simulation - BModel, include = FALSE}

# Specification
spe = "baseline"

# Initialize result dataset
final = data.frame(matrix(ncol = ncol(data)+ ncol(param) -2 + 1, nrow = 0)) %>%
  setNames(c("Specification", names(data), names(param)[-c(1,2)]))

# Prepare data for simulation
data = data_base %>% 
  # Merge with parameters
  merge(param) %>% 
  # No BTC
  mutate(AK = 1, AL = 1) %>% 
  # Demography
  demo_changer() %>% 
  # Define specification model
  mutate(Specification = spe) %>%
  # Reorder variables
  select(Specification, everything())

# Prepare result data frame to loop on
result = final

# Simulate the baseline model for each country
for(country in country_set){
    
    result = data %>%
      subset(Country == country) %>% 
      model(time = 3) %>% 
      rbind(result, .)
    
}

# Regroup result
final = result

# Write final_baseline
write.csv(final, file.path(loc_sim, paste0("final_", spe, ".csv")), row.names = FALSE)

```

```{r Graph - BModel performance, echo = FALSE}

final %>% 
  subset(Specification == "baseline") %>% 
  select(Country, Year, theta) %>% 
  merge(., 
        df %>% select(Country, Year, theta) %>% setNames(c("Country", "Year", "labsh")),
        all = TRUE
        ) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  filter(complete.cases(.)) %>% 
  subset(Year %in% c(1970:2020)) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = variable)) +
  geom_line(size = 0.5) +
  facet_wrap(Country ~ ., scales = "free") +
  scale_linetype_manual(name = "From",
                        breaks = c("labsh", "theta"),
                        labels = c("Data", "Model"),
                        values = c("dashed", "solid")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none") +
  labs(x = "Year", y = "Labor income share") +
  ggsave(file.path(loc_result, "baseline_facet.png"), width = 1920/1080*5, height = 5)

```

### Counterfactual simulation

```{r Aging effect decomposition, include = FALSE}

# Re initialize result data frame
result = result[0,]

## Aging effect decomposition : Survival rate versus Population growth
for(sr in c("TSR", "FSR")){
  for(pg in c("TPG", "FPG")){
    
    break_year = 1970
    spe = paste0("counter_", break_year, "_", pg, ".", sr, ".", "TDE", ".", "TIE")
    
    # Prepare data
    data = data_base %>% 
    # No biased technical change
    mutate(AK = 1, AL = 1) %>% 
    # Add parameters
    merge(param) %>% 
    # Demography
    demo_changer(PG = pg, SR = sr) %>% 
    # Define specification model
    mutate(Specification = spe) %>%
    # Reorder variables
    select(Specification, everything())
    
    
    # Simulate the model for each country
    for(country in country_set){
        
        result = data %>%
          subset(Country == country) %>% 
          model(time = 3) %>% 
          rbind(result, .)
        
    }
  }
}

## Aging effect decomposition : Direct effect versus Indirect effect
for(de in c("TDE", "FDE")){
  for(ie in c("TIE", "FIE")){
    
    break_year = 1970
    spe = paste0("counter_", break_year, "_", "TPG", ".", "TSR", ".", de, ".", ie)
    
    # Prepare data
    data = data_base %>% 
    # No biased technical change
    mutate(AK = 1, AL = 1) %>% 
    # Add parameters
    merge(param) %>% 
    # Demography
    demo_changer(DE = de, IE = ie) %>% 
    # Define specification model
    mutate(Specification = spe) %>%
    # Reorder variables
    select(Specification, everything())
    
    
    # Simulate the model for each country
    for(country in country_set){
        
        result = data %>%
          subset(Country == country) %>% 
          model(time = 3) %>% 
          rbind(result, .)
        
    }
  }
}

# Remove duplicates
final = distinct(result)

# Model specification details
final = final %>% mutate(PG = ifelse(grepl("TPG", Specification), "TPG", "FPG"),
                 SR = ifelse(grepl("TSR", Specification), "TSR", "FSR"),
                 DE = ifelse(grepl("TDE", Specification), "TDE", "FDE"),
                 IE = ifelse(grepl("TIE", Specification), "TIE", "FIE"),
                 break_year = as.numeric(gsub("[^0-9]", "\\1", Specification))) %>% 
  select(Specification, break_year, PG, SR, DE, IE, everything())

# Write final_counter
write.csv(final, file.path(loc_sim, paste0("final_", "counter", ".csv")), row.names = FALSE)

```

```{r Graph CModel - Prepare Data, include = FALSE}

# Reshape dataframe
decomp = final %>% 
  select(Country, Specification, Year, theta) %>% 
  rbind(., 
        df %>% 
          mutate(Specification = "data") %>%
          select(Specification, Country, Year, theta)) %>% 
  mutate(from = ifelse(Specification == "data", "data", "sim")) %>% 
  filter(complete.cases(.)) %>% 
  mutate(PG = ifelse(Specification == "data", NA, ifelse(grepl("TPG", Specification), "TPG", "FPG")),
         SR = ifelse(Specification == "data", NA, ifelse(grepl("TSR", Specification), "TSR", "FSR")),
         DE = ifelse(Specification == "data", NA, ifelse(grepl("TDE", Specification), "TDE", "FDE")),
         IE = ifelse(Specification == "data", NA, ifelse(grepl("TIE", Specification), "TIE", "FIE")),
         break_year = as.numeric(gsub("[^0-9]", "\\1", Specification))) %>% 
  select(Specification, break_year, PG, SR, DE, IE, everything())

```

```{r Graph CModel - PGSR Decomposition, echo = FALSE}

decomp %>% 
  subset(DE %in% c("TDE", NA) & IE %in% c("TIE", NA)) %>% 

  ggplot(aes(x = Year, y = theta, color = interaction(PG, SR), linetype = from)) +
  geom_line(size = 0.5) +
  facet_wrap(Country ~ ., scales = "free") +
  geom_label_repel(aes(label = round(theta, 3)),
                   data = subset(decomp, Year == 2080 & DE == "TDE" & IE == "TIE"), 
                   nudge_x = 5, na.rm = TRUE,
                   segment.color = "transparent") +
  scale_linetype_manual(name = "From",
                        breaks = c("data", "sim"),
                        labels = c("Data", "Model"),
                        values = c("solid", "dashed")) +
  scale_color_manual(name = "Specification",
                     breaks = c("TPG.TSR", "TPG.FSR",
                                "FPG.TSR", "FPG.FSR"),
                     labels = c("TPG & TSR", "FPG & TSR",
                                "TPG & FSR", "FPG & FSR"),
                     values = brewer.pal(8, "Set1")[c(4,3,2,1)],
                     na.value = "black") +
  theme_classic(base_size = 14) +
  guides(color = guide_legend(order = 0), linetype = guide_legend(order = 1)) +
  theme(legend.position = "right", legend.direction = "vertical") +
  labs(x = "Year", y = "Labor income share") +
  ggsave(file.path(loc_result, "counter_facet_PGSR.png"), width = 1920/1080*5, height = 5)

```

```{r Graph CModel - DEIE Decomposition, echo = FALSE}

decomp %>% 
  subset(PG %in% c("TPG", NA) & SR %in% c("TSR", NA)) %>% 

  ggplot(aes(x = Year, y = theta, color = interaction(DE, IE), linetype = from)) +
  geom_line(size = 0.5) +
  facet_wrap(Country ~ ., scales = "free") +
  geom_label_repel(aes(label = round(theta, 3)),
                   data = subset(decomp, Year == 2080 & PG == "TPG" & SR == "TSR"), 
                   nudge_x = 5, na.rm = TRUE,
                   segment.color = "transparent") +
  scale_linetype_manual(name = "From",
                        breaks = c("data", "sim"),
                        labels = c("Data", "Model"),
                        values = c("solid", "dashed")) +
  scale_color_manual(name = "Specification",
                     breaks = c("TDE.TIE", "TDE.FIE",
                                "FDE.TIE", "FDE.FIE"),
                     labels = c("TDE & TIE", "TDE & FIE",
                                "FDE & TIE", "FDE & FIE"),
                     values = brewer.pal(8, "Set1")[c(4,5,8,1)],
                     na.value = "black") +
  # scale_x_continuous(limits = c(NA, 2090)) +
  theme_classic(base_size = 14) +
  guides(color = guide_legend(order = 0), linetype = guide_legend(order = 1)) +
  theme(legend.position = "right", legend.direction = "vertical") +
  labs(x = "Year", y = "Labor income share") +
  ggsave(file.path(loc_result, "counter_facet_DEIE.png"), width = 1920/1080*5, height = 5)

```



















