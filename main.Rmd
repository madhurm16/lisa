---
title: "Labor Share & Aging Population"
author: "Fabien Petit"
output:	
  html_document:	
    # pandoc_args: --webtex
---

## Data

### Raw data

Data are from :

* Penn World Table 9.1
* OECD Database
* United Nations (World Population Prospects)

```{r Initialization, include = FALSE}

# Define paths
loc_result = file.path(getwd(), "result")
loc_sim = file.path(loc_result, "sim")
loc_function = file.path(getwd(), "function")
loc_final = file.path(getwd(), "data", "final")

# Load packages
packages <- c("bucky", "dplyr", "ggplot2", "ggrepel", "lmtest", "sandwich", "zoo", "RColorBrewer", "reshape2")
lapply(packages, require, character.only = TRUE)
rm(packages)

# Load functions
sapply(list.files(pattern = "[.]R$", path = loc_function, full.names = TRUE), source)

```

```{r Simulation specification, include = FALSE}

# Country set
country_set = c("France", "United States")

# Simulation periods
sim = seq(1970, 2080, 10)

# Estimation sample
est_sample = c(1970:2010)

```

```{r Load data, include = FALSE}

# Penn World Table
pwt = read.csv(file.path(loc_final, "pwt.csv"), header = TRUE) %>%
  select("Country", "Year", "emp", "avh", "rgdpna", "rnna", "lab_sh1") %>% 
  subset(Country %in% country_set & Year >= 1970)

# OECD data
oecd = read.csv(file.path(loc_final, "oecd.csv"), header = TRUE) %>% 
  select("Country", "Year", tax_rate = "tax_rev_PC_GDP", union_density = "union_density.lin_inter", union_coverage = "union_coverage.lin_inter") %>% 
  subset(Country %in% country_set & Year >= 1970)

# Demographic data
demo = read.csv(file.path(loc_final, "demo.csv"), header = TRUE) %>% 
  select("Country", "Year", "young", "old", "dep", "n", "p") %>% 
  subset(Country %in% country_set & Year >= 1970)

## Merge
df = merge(merge(pwt, oecd, all = TRUE), demo, all = TRUE)

```

```{r Data retreatment, echo = FALSE}

# Variable modifications
df = df %>%
  group_by(Country) %>% 
  mutate(L = emp * 1000,
         Y = rgdpna / avh * 1000, # AVH control
         K = rnna / avh * 1000, # AVH control
         theta = lab_sh1, # Labor share
         tau = tax_rate / 100, # Tax rate
         u = 1 - L / (young+old), # Unemployment rate
         p1 = lead(p, 40)) %>% 
  select(Country, Year, Ny = young, No = old, n, p, p1, dep, K, L, Y, theta, tau, u) %>% 
  mutate(L = L / first(L), # Normalized labor
         K = K / first(K), # Normalized capital
         Y = Y / first(Y), # Normalized output
         k = K / L, # Normalized capital-labor ratio
         Ny = L / (1-u), # Normalized young population
         No = Ny * dep) %>% # Normalized old population
  ungroup()

# Remove unused countries from Country levels
df$Country = df$Country %>% as.character %>% as.factor()

# Visualization
head(df)

# Write df
write.csv(df, file.path(loc_sim, "data.csv"), row.names = FALSE)

```

### Data for simulation

```{r Data for simulation, echo = FALSE}

init_seq = seq(1970, 2000, 10)

# Baseline data
data_base = df %>% 
  group_by(Country) %>% 
  subset(Year %in% sim) %>% 
  select(Country, Year, Ny, No, n, p, p1, K) %>% 
  mutate(Sequence = ((sim - 1970)/10) %% 4 + 1,
         Period = (sim - init_seq) / 40 + 1,
         Ny = ifelse(Year == 2010, NA, Ny),
         No = ifelse(Year == 2010, NA, No),
         K = ifelse(Year == 2010, NA, K),
         # Complete NA values for p1 in 2070 and 2080
         p1 = ifelse(Year >= 2070, p1[Year == 2060] + 
                       (Year - 2060)/10 * mean(p1/lag(p1)-1, na.rm = T), p1), 
         ## Create empty variables
         eta = NA, AK = NA, AL = NA, k1 = NA, k2 = NA, k = NA, X = NA, L = NA, w = NA,
         r = NA, Y = NA, u = NA, theta = NA, tau = NA, b = NA, h = NA, S = NA) 

# Re-order variables
data_base = data_base %>% select(Country, Year, Sequence, Period, Ny, No, n, p, p1, eta, AK, AL,
                                 k1, k2, k, X, L, w, r, Y, u, theta, tau, b, h, S, K)
  
# Visualization
head(data_base)

```

```{r Initial Specification, include = FALSE}

data = data_base %>% 
  # No biased technical change
  mutate(AK = 1, AL = 1) %>% 
  # Population dynamics
  demo_changer(init_spe = TRUE)

```


## Parameter calibration

The discount factor *alpha* is set to `r round(0.99^40,3)`. The relative bargaining power of the union *gamma* is set to `r 0.5`. *For more details, please consult "gamma.md" file.*

```{r Parameter - Dataframe, include = FALSE}

param_base = data.frame("Country" = rep(c("France", "United States"), each = length(sim)),
                   "Year" = sim, "alpha" = (0.99)^40, "gamma" = 0.5)

```

### Production function

I estimate the elasticity of substitution between capital and labor using the methodology of **Leon-Ledesma, McAdam & Willman (2013)**. Estimation are done for France and United States between 1970 and 2010, using Penn World Table 9.1 data. *For more details, please consult "sigma.md" file.*

```{r Parameter - Production function, echo = FALSE}

# Estimation
ols_sigma = df %>% 
  group_by(Country) %>% 
  mutate(k_log = log(k),
         THETA_log_neg = - log((1-theta)/theta),
         t_diff = Year - first(Year) + 1) %>% 
  select(Country, Year, k_log, THETA_log_neg, t_diff) %>% 
  subset(Year %in% c(1970:2010)) %>% 
  ungroup() %>% 
  lm(k_log ~ Country + THETA_log_neg*Country + t_diff*Country - THETA_log_neg - t_diff, data = .)

# Result visualization
robust.summary(ols_sigma)

# Add production function parameters
param_base = param_base %>%
  mutate("phi" = rep(1 - df$theta[df$Year == 1970], each = length(sim)), 
         "sigma" = rep(1/(1+ols_sigma$coefficients[c((length(country_set)+1):(2*length(country_set)))]),
                               each = length(sim)),
         "a" = rep(ols_sigma$coefficients[c((2*length(country_set)+1):(3*length(country_set)))],
                   each = length(sim)))

# Visualization
param_base %>% subset(Year == 1970) %>% select(Country, phi, sigma, a)

```

### Preferences

The relative per-capita influence of old households *omega* is deduced such that the capital-to-labor ratio is matched in 1970. The preference for government health expenditure *beta* is deduced such that the tax rate in 1970 is matched.

```{r Parameter - Preferences, echo = FALSE}

# Compute omega and beta
param_base = df %>%
  subset(Year == 1970) %>% 
  merge(param_base) %>%
  mutate(X = (sigma + (1-phi)/phi*(1-gamma*(1-sigma))/gamma)^(-1),
         omega = phi/(1-phi)*n/p*(1+alpha*p1)/(1 + exp(-X)*(Ny - 1)),
         eta = n/p*(1+alpha*p1)/omega,
         beta = 1/(1 - tau)/phi - 1 - eta) %>% 
  select(Country, omega, beta) %>% 
  merge(param_base) %>% 
  # Reorder parameters in dataframe
  select(Country, Year, names(param_base), everything())

# Visualization
param_base %>% subset(Year == 1970) %>% select(Country, omega, beta)

```

### Scale parameter

The scale parameter *A* is decuded using grid search to match the average labor share between 2008 and 2012.

```{r Parameter - Scale parameter, echo = FALSE}

data = data_base %>% 
  # No biased technical change
  mutate(AK = 1, AL = 1) %>% 
  # Add parameters
  merge(param_base) %>% 
  # Demography
  demo_changer(AFinder = TRUE)

# A Finder script
source("./script/sim_AFinder.R")

# Assign A scale parameter to param_base
param_base$A = data$A

```

### Summary

All parameters are constant over time.

```{r Parameter -  Summary, echo = FALSE}

# Visualization
param_base %>% subset(Year == 1970) %>% select(-Year, -a)

param = param_base

```

## Simulation

```{r Graph - Parameters, include = FALSE}

breaks_10_years = seq(1970, 2080, 10)
labs_20_years = as.vector(rbind(seq(1970, 2080, 20), rep("", length(breaks_10_years)/2)))

```

### Baseline model

```{r Simulation - BModel, include = FALSE}

# Specification
spe = "baseline"

# Initialize result dataset
final = data.frame(matrix(ncol = ncol(data)+ ncol(param) -2 + 1, nrow = 0)) %>%
  setNames(c("Specification", names(data), names(param)[-c(1,2)]))

# Prepare data for simulation
data = data_base %>% 
  # Merge with parameters
  merge(param) %>% 
  # No BTC
  mutate(AK = 1, AL = 1) %>% 
  # Demography
  demo_changer() %>% 
  # Define specification model
  mutate(Specification = spe) %>%
  # Reorder variables
  select(Specification, everything())

# Prepare result data frame to loop on
result = final

# Simulate the baseline model for each country
for(country in country_set){
    
    result = data %>%
      subset(Country == country) %>% 
      model(time = 3) %>% 
      rbind(result, .)
    
}

# Regroup result
final = result

# Write final_baseline
write.csv(final, file.path(loc_sim, paste0("final_", spe, ".csv")), row.names = FALSE)

```

```{r Graph - BModel Labor Share - Plot 1970-2020, echo = FALSE}

final %>% 
  subset(Specification == "baseline") %>% 
  select(Country, Year, theta) %>% 
  merge(., 
        df %>% select(Country, Year, theta) %>% setNames(c("Country", "Year", "labsh")),
        all = TRUE
        ) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  filter(complete.cases(.)) %>% 
  subset(Year %in% c(1970:2020)) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = variable)) +
  geom_line(size = 0.5) +
  facet_wrap(Country ~ ., scales = "free") +
  scale_linetype_manual(name = "From",
                        breaks = c("labsh", "theta"),
                        labels = c("Data", "Model"),
                        values = c("dashed", "solid")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none") +
  labs(x = "Year", y = "Labor income share") +
  ggsave(file.path(loc_result, "baseline7020_facet.png"), width = 1920/1080*5, height = 5)

```

```{r Graph - BModel Labor Share - Plot 1970-2080, echo = FALSE}

final %>% 
  subset(Specification == "baseline") %>% 
  select(Country, Year, theta) %>% 
  merge(., 
        df %>% select(Country, Year, theta) %>% setNames(c("Country", "Year", "labsh")),
        all = TRUE
        ) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  filter(complete.cases(.)) %>% 
  subset(Year %in% c(1970:2080)) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = variable)) +
  geom_line(size = 0.5) +
  facet_wrap(Country ~ ., scales = "free") +
  scale_linetype_manual(name = "From",
                        breaks = c("labsh", "theta"),
                        labels = c("Data", "Model"),
                        values = c("dashed", "solid")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none") +
  labs(x = "Year", y = "Labor income share") +
  ggsave(file.path(loc_result, "baseline7080_facet.png"), width = 1920/1080*5, height = 5)

```


```{r Graph - BModel Performance - Preparation, include = FALSE}
perf = final %>% 
  subset(Specification == "baseline") %>% 
  select(Country, Year, theta) %>% 
  merge(., 
        df %>% select(Country, Year, theta) %>% setNames(c("Country", "Year", "labsh")),
        all = TRUE
        ) %>% 
  interpol_group() %>% 
  filter(complete.cases(.)) %>% 
  mutate(Year1 = Year - 1970 + 1,
         Year2 = Year1^2,
         Year3 = Year1^3,
         # Year4 = Year1^4,
         # Year5 = Year1^5,
         labsh.fitted = lm(data = .,
                           formula = labsh 
                           ~ Year1*Country 
                           + Year2*Country
                           + Year3*Country 
                           # + Year4*Country 
                           # + Year5*Country 
                           - Country) %>%
           fitted.values() %>% unname())
```


```{r Graph - BModel Performance - Plot, echo = FALSE}
perf %>% 
  select(Country, Year, theta, labsh, labsh.fitted) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, color = variable)) +
  geom_line() +
  facet_wrap(Country ~ .) +
  scale_color_manual(name = "",
                     breaks = c("theta", "labsh", "labsh.fitted"),
                     labels = c("Model", "Data", "Smoothed data"),
                     values = c(brewer.pal(8, "Set1")[1],
                                "black",
                                brewer.pal(8, "Set1")[2]),
                     na.value = "black") +
  theme_classic(base_size = 14) +
  guides(color = guide_legend(order = 0), linetype = guide_legend(order = 1)) +
  theme(legend.position = "bottom", legend.direction = "horizontal") +
  labs(x = "Year", y = "Labor income share")
  


```

```{r Graph - BModel Variables, echo = FALSE}

## Variable deviation 1970 to 2080
final %>% 
  group_by(Country) %>% 
  mutate(dep = p / n,
         YL = Y / L,
         outside = b / (1-tau),
         # Deviations from initial SS
         dep_dev = dep/dep[Year == 1970] -1,
         eta_dev = eta/eta[Year == 1970] -1,
         outside_dev = outside/outside[Year == 1970] -1,
         w_dev = w/w[Year == 1970] -1,
         L_dev = L/L[Year == 1970] -1,
         YL_dev = YL/YL[Year == 1970] -1) %>% 
  select(Country, Year, contains("_dev")) %>% 
  subset(Year %in% c(1970:2080)) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, color = variable)) +
  geom_line() +
  facet_wrap(Country ~ ., scales = "free") +
  scale_color_manual(name = "Variables",
                     breaks = c("dep_dev", "eta_dev", "outside_dev", "w_dev", "L_dev", "YL_dev"),
                     labels = c("Dependency ratio", "Young political power", "Outside option", "Wage",
                                "Labor", "Production per worker"),
                     values = brewer.pal(8, "Set1")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "right", legend.direction = "vertical") +
  labs(x = "Year", y = "Deviation from the initial steady state (1970)")

## Variable deviation 1970 to 2010
final %>% 
  group_by(Country) %>% 
  mutate(dep = p / n,
         YL = Y / L,
         outside = b / (1-tau),
         # Deviations from initial SS
         dep_dev = dep/dep[Year == 1970] -1,
         eta_dev = eta/eta[Year == 1970] -1,
         outside_dev = outside/outside[Year == 1970] -1,
         w_dev = w/w[Year == 1970] -1,
         L_dev = L/L[Year == 1970] -1,
         YL_dev = YL/YL[Year == 1970] -1) %>% 
  select(Country, Year, contains("_dev")) %>% 
  subset(Year %in% c(1970:2010)) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, color = variable)) +
  geom_line() +
  facet_wrap(Country ~ ., scales = "free") +
  scale_color_manual(name = "Variables",
                     breaks = c("dep_dev", "eta_dev", "outside_dev", "w_dev", "L_dev", "YL_dev"),
                     labels = c("Dependency ratio", "Young political power", "Outside option", "Wage",
                                "Labor", "Production per worker"),
                     values = brewer.pal(8, "Set1")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "right", legend.direction = "vertical") +
  labs(x = "Year", y = "Deviation from the initial steady state (1970)")


## Variable deviation 2010 to 2050
final %>% 
  group_by(Country) %>% 
  mutate(dep = p / n,
         YL = Y / L,
         outside = b / (1-tau),
         # Deviations from initial SS
         dep_dev = dep/dep[Year == 2010] -1,
         eta_dev = eta/eta[Year == 2010] -1,
         outside_dev = outside/outside[Year == 2010] -1,
         w_dev = w/w[Year == 2010] -1,
         L_dev = L/L[Year == 2010] -1,
         YL_dev = YL/YL[Year == 2010] -1) %>% 
  select(Country, Year, contains("_dev")) %>% 
  subset(Year %in% c(2010:2050)) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, color = variable)) +
  geom_line() +
  facet_wrap(Country ~ ., scales = "free") +
  scale_color_manual(name = "Variables",
                     breaks = c("dep_dev", "eta_dev", "outside_dev", "w_dev", "L_dev", "YL_dev"),
                     labels = c("Dependency ratio", "Young political power", "Outside option", "Wage",
                                "Labor", "Production per worker"),
                     values = brewer.pal(8, "Set1")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "right", legend.direction = "vertical") +
  labs(x = "Year", y = "Deviation from the initial steady state (2010)")


```


### Counterfactual simulation

```{r Aging effect decomposition, include = FALSE}

# Re initialize result data frame
result = result[0,]

## Aging effect decomposition : Survival rate versus Population growth
for(sr in c("TSR", "FSR")){
  for(pg in c("TPG", "FPG")){
    
    break_year = 1970
    spe = paste0("counter_", break_year, "_", pg, ".", sr, ".", "TDE", ".", "TIE")
    
    # Prepare data
    data = data_base %>% 
    # No biased technical change
    mutate(AK = 1, AL = 1) %>% 
    # Add parameters
    merge(param) %>% 
    # Demography
    demo_changer(PG = pg, SR = sr) %>% 
    # Define specification model
    mutate(Specification = spe) %>%
    # Reorder variables
    select(Specification, everything())
    
    
    # Simulate the model for each country
    for(country in country_set){
        
        result = data %>%
          subset(Country == country) %>% 
          model(time = 3) %>% 
          rbind(result, .)
        
    }
  }
}

## Aging effect decomposition : Direct effect versus Indirect effect
for(de in c("TDE", "FDE")){
  for(ie in c("TIE", "FIE")){
    
    break_year = 1970
    spe = paste0("counter_", break_year, "_", "TPG", ".", "TSR", ".", de, ".", ie)
    
    # Prepare data
    data = data_base %>% 
    # No biased technical change
    mutate(AK = 1, AL = 1) %>% 
    # Add parameters
    merge(param) %>% 
    # Demography
    demo_changer(DE = de, IE = ie) %>% 
    # Define specification model
    mutate(Specification = spe) %>%
    # Reorder variables
    select(Specification, everything())
    
    
    # Simulate the model for each country
    for(country in country_set){
        
        result = data %>%
          subset(Country == country) %>% 
          model(time = 3) %>% 
          rbind(result, .)
        
    }
  }
}

# Remove duplicates
final = distinct(result)

# Model specification details
final = final %>% mutate(PG = ifelse(grepl("TPG", Specification), "TPG", "FPG"),
                 SR = ifelse(grepl("TSR", Specification), "TSR", "FSR"),
                 DE = ifelse(grepl("TDE", Specification), "TDE", "FDE"),
                 IE = ifelse(grepl("TIE", Specification), "TIE", "FIE"),
                 break_year = as.numeric(gsub("[^0-9]", "\\1", Specification))) %>% 
  select(Specification, break_year, PG, SR, DE, IE, everything())

# Write final_counter
write.csv(final, file.path(loc_sim, paste0("final_", "counter", ".csv")), row.names = FALSE)

```

```{r Graph CModel - Prepare Data, include = FALSE}

# Reshape dataframe
decomp = final %>% 
  select(Country, Specification, Year, theta) %>% 
  rbind(., 
        df %>% 
          mutate(Specification = "data") %>%
          select(Specification, Country, Year, theta)) %>% 
  mutate(from = ifelse(Specification == "data", "data", "sim")) %>% 
  filter(complete.cases(.)) %>% 
  mutate(PG = ifelse(Specification == "data", NA, ifelse(grepl("TPG", Specification), "TPG", "FPG")),
         SR = ifelse(Specification == "data", NA, ifelse(grepl("TSR", Specification), "TSR", "FSR")),
         DE = ifelse(Specification == "data", NA, ifelse(grepl("TDE", Specification), "TDE", "FDE")),
         IE = ifelse(Specification == "data", NA, ifelse(grepl("TIE", Specification), "TIE", "FIE")),
         break_year = as.numeric(gsub("[^0-9]", "\\1", Specification))) %>% 
  select(Specification, break_year, PG, SR, DE, IE, everything())

```

```{r Graph CModel - PGSR Counterfactual, echo = FALSE}

decomp %>% 
  subset(DE %in% c("TDE", NA) & IE %in% c("TIE", NA)) %>% 

  ggplot(aes(x = Year, y = theta, color = interaction(PG, SR), linetype = from)) +
  geom_line(size = 0.5) +
  facet_wrap(Country ~ ., scales = "free") +
  geom_label_repel(aes(label = round(theta, 3)),
                   data = subset(decomp, Year == 2080 & DE == "TDE" & IE == "TIE"), 
                   nudge_x = 5, na.rm = TRUE,
                   segment.color = "transparent") +
  scale_linetype_manual(name = "From",
                        breaks = c("data", "sim"),
                        labels = c("Data", "Model"),
                        values = c("solid", "dashed")) +
  scale_color_manual(name = "Specification",
                     breaks = c("TPG.TSR", "TPG.FSR",
                                "FPG.TSR", "FPG.FSR"),
                     labels = c("TPG & TSR", "FPG & TSR",
                                "TPG & FSR", "FPG & FSR"),
                     values = brewer.pal(8, "Set1")[c(4,3,2,1)],
                     na.value = "black") +
  theme_classic(base_size = 14) +
  guides(color = guide_legend(order = 0), linetype = guide_legend(order = 1)) +
  theme(legend.position = "right", legend.direction = "vertical") +
  labs(x = "Year", y = "Labor income share") +
  ggsave(file.path(loc_result, "counter_facet_PGSR.png"), width = 1920/1080*5, height = 5)

```

```{r Graph CModel - DEIE Counterfactual, echo = FALSE}

decomp %>% 
  subset(PG %in% c("TPG", NA) & SR %in% c("TSR", NA)) %>% 

  ggplot(aes(x = Year, y = theta, color = interaction(DE, IE), linetype = from)) +
  geom_line(size = 0.5) +
  facet_wrap(Country ~ ., scales = "free") +
  geom_label_repel(aes(label = round(theta, 3)),
                   data = subset(decomp, Year == 2080 & PG == "TPG" & SR == "TSR"), 
                   nudge_x = 5, na.rm = TRUE,
                   segment.color = "transparent") +
  scale_linetype_manual(name = "From",
                        breaks = c("data", "sim"),
                        labels = c("Data", "Model"),
                        values = c("solid", "dashed")) +
  scale_color_manual(name = "Specification",
                     breaks = c("TDE.TIE", "TDE.FIE",
                                "FDE.TIE", "FDE.FIE"),
                     labels = c("TDE & TIE", "TDE & FIE",
                                "FDE & TIE", "FDE & FIE"),
                     values = brewer.pal(8, "Set1")[c(4,5,8,1)],
                     na.value = "black") +
  # scale_x_continuous(limits = c(NA, 2090)) +
  theme_classic(base_size = 14) +
  guides(color = guide_legend(order = 0), linetype = guide_legend(order = 1)) +
  theme(legend.position = "right", legend.direction = "vertical") +
  labs(x = "Year", y = "Labor income share") +
  ggsave(file.path(loc_result, "counter_facet_DEIE.png"), width = 1920/1080*5, height = 5)

```
```{r Computation CModel - Decomposition, echo = FALSE}

decomp2 = final %>% 
  select(Country, Specification, Year, theta) %>% 
  mutate(PG = ifelse(Specification == "data", NA, ifelse(grepl("TPG", Specification), "TPG", "FPG")),
         SR = ifelse(Specification == "data", NA, ifelse(grepl("TSR", Specification), "TSR", "FSR")),
         DE = ifelse(Specification == "data", NA, ifelse(grepl("TDE", Specification), "TDE", "FDE")),
         IE = ifelse(Specification == "data", NA, ifelse(grepl("TIE", Specification), "TIE", "FIE")),
         Spe_PGSR = interaction(PG, SR),
         Spe_DEIE = interaction(DE, IE)) %>% 
  select(Country, Year, Spe_PGSR, Spe_DEIE, theta) %>% 
  dcast(Country + Year ~ Spe_PGSR + Spe_DEIE, value.var = "theta") %>% 
  setNames(c("Country", "Year",
             "FPG.FSR", "TPG.FSR", "FPG.TSR", 
             "FDE.FIE", "TDE.FIE", "FDE.TIE",
             "benchmark")) %>% 
  mutate(FPG.TSR = (benchmark - FPG.TSR)*100,
         TPG.FSR = (benchmark - TPG.FSR)*100,
         FPG.TSR.share = abs(FPG.TSR)/(abs(FPG.TSR) + abs(TPG.FSR)),
         TPG.FSR.share = abs(TPG.FSR)/(abs(FPG.TSR) + abs(TPG.FSR)),
         position_PGSR = (FPG.TSR + TPG.FSR),
         FDE.TIE = (benchmark - FDE.TIE)*100,
         TDE.FIE = (benchmark - TDE.FIE)*100,
         FDE.TIE.share = abs(FDE.TIE)/(abs(FDE.TIE) + abs(TDE.FIE)),
         TDE.FIE.share = abs(TDE.FIE)/(abs(FDE.TIE) + abs(TDE.FIE)),
         position_DEIE = (FDE.TIE + TDE.FIE)) %>% 
  melt(id.vars = c("Country", "Year", "position_PGSR", "position_DEIE"))

```


```{r Graph CModel - PGSR Decomposition, echo = FALSE}

decomp2 %>% 
  subset(variable %in% c("TPG.FSR", "FPG.TSR")) %>% 
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable),
           color = "black", size = .7, alpha = .5) +
  geom_line(aes(y = position_PGSR),
            color = brewer.pal(8, "Set1")[1], size = 1) +
  geom_hline(yintercept = 0, size = 1) +
  facet_wrap(Country ~ ., scales = "free") +
  # scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  scale_fill_manual(name = "",
                    breaks = c("TPG.FSR", "FPG.TSR"),
                    labels = c("Survival rate", "Population growth"),
                    values = brewer.pal(8, "Set1")[c(2,3)] %>% 
                      setNames(c("TPG.FSR", "FPG.TSR")),
                    na.value = "black") +
  theme_classic(base_size = 14) +
  # theme(legend.direction = "vertical", legend.box = "horizontal", 
  #      legend.position = c(1,1), legend.justification = c(1, 1)) +
  labs(x = "Year", y = "Difference with counterfactual (in pp.)")
  
```


```{r Graph CModel - DEIE Decomposition, echo = FALSE}

decomp2 %>% 
  subset(variable %in% c("TDE.FIE", "FDE.TIE")) %>% 
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable),
           color = "black", size = .7, alpha = .5) +
  geom_line(aes(y = position_DEIE),
            color = brewer.pal(8, "Set1")[1], size = 1) +
  facet_wrap(Country ~ ., scales = "free") +
  geom_hline(yintercept = 0, size = 1) +
  # scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  scale_fill_manual(name = "",
                    breaks = c("FDE.TIE", "TDE.FIE"),
                    labels = c("Direct effect", "Indirect effect"),
                    values = brewer.pal(8, "Set1")[c(5,8)] %>% 
                      setNames(c("FDE.TIE", "TDE.FIE")),
                    na.value = "black") +
  theme_classic(base_size = 14) +
  # theme(legend.direction = "vertical", legend.box = "horizontal", 
  #       legend.position = c(0.01,1), legend.justification = c(0, 1)) +
  labs(x = "Year", y = "Difference with counterfactual (in pp.)")
  
```

```{r Computation CModel - Explanation Power, echo = FALSE}

# Compute the share of each effect/channel for two sub_periods 1980-2010 & 2020-2050
decomp_mean.period = decomp2 %>% 
  select(-contains("position")) %>% 
  dcast(Country + Year ~ variable) %>% 
  mutate(Period = ifelse(Year %in% c(1980:2010), "P1",
                         ifelse(Year %in% c(2020:2050), "P2", "P3"))) %>% 
  subset(Period != "P3") %>% 
  group_by(Country, Period) %>% 
  summarise_at(vars(FPG.TSR.share:TDE.FIE.share), mean, na.rm = TRUE)

## Assign values for text
# France 1980-2010
FR8010_FPG = decomp_mean.period %>% subset(Country == "France" & Period == "P1") %>% 
  pull("FPG.TSR.share") %>% round(2) *100
FR8010_FSR = decomp_mean.period %>% subset(Country == "France" & Period == "P1") %>%
  pull("TPG.FSR.share") %>% round(2) *100
FR8010_FDE = decomp_mean.period %>% subset(Country == "France" & Period == "P1") %>%
  pull("FDE.TIE.share") %>% round(2) *100
FR8010_FIE = decomp_mean.period %>% subset(Country == "France" & Period == "P1") %>%
  pull("TDE.FIE.share") %>% round(2) *100
# France 2020-2050
FR2050_FPG = decomp_mean.period %>% subset(Country == "France" & Period == "P2") %>% 
  pull("FPG.TSR.share") %>% round(2) *100
FR2050_FSR = decomp_mean.period %>% subset(Country == "France" & Period == "P2") %>%
  pull("TPG.FSR.share") %>% round(2) *100
FR2050_FDE = decomp_mean.period %>% subset(Country == "France" & Period == "P2") %>%
  pull("FDE.TIE.share") %>% round(2) *100
FR2050_FIE = decomp_mean.period %>% subset(Country == "France" & Period == "P2") %>%
  pull("TDE.FIE.share") %>% round(2) *100

# Visualization
decomp_mean.period

```

In France, between 1980 and 2010, population growth variations account, on average, for `r FR8010_FPG` % of the labor share variations with respect to the counterfactual. Thus, the survival rate variations account for `r FR8010_FSR` %.
The main propagation channel over this period is the direct one (`r FR8010_FDE` %) compared to the indirect one (`r FR8010_FIE` %).

Between 2020 and 2050, the impact of population growth variations on the labor share with respect to the counterfactual should decrease a bit (`r FR2050_FPG` %). Therefore, Survival rate variations should have a larger impact (`r FR2050_FSR` %) due to the fact that population growth should remain relatively constant at the end of the century.
However, the indirect effect should become the main channel (`r FR2050_FDE` %) compared to the direct one (`r FR2050_FIE` %).

```{r Graph CModel - Explanation Power, echo = FALSE}

decomp_mean.period %>% 
  melt(id.vars = c("Country", "Period")) %>% 
  mutate(value = value*100) %>% 
  
  ggplot(aes(x = Period, y = value, fill = variable)) +
  geom_bar(stat = "identity", position = position_dodge(),
           color = "black", size = .7, alpha = .5) +
  facet_wrap(Country ~ ., scales = "fixed") +
  scale_x_discrete(breaks = c("P1", "P2"), labels = c("1980-2010", "2020-2050")) +
  scale_fill_manual(name = "",
                    breaks = c("FPG.TSR.share", "TPG.FSR.share", "FDE.TIE.share", "TDE.FIE.share"),
                    labels = c("Population growth", "Survival rate", "Direct effect", "Indirect effect"),
                    values = brewer.pal(8, "Set1")[c(3,2,5,8)] %>% 
                      setNames(c("FPG.TSR.share", "TPG.FSR.share", "FDE.TIE.share", "TDE.FIE.share")),
                    na.value = "black") +
  theme_classic(base_size = 14) +
  labs(x = "", y = "Percent")

```
































