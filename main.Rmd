---
title: "Labor Share & Aging Population"
author: "Fabien Petit"
output:	
  html_document:	
    # pandoc_args: --webtex
---

## Data

### Raw data

Data are from :

* Penn World Table 9.1
* OECD Database
* United Nations (World Population Prospects)

```{r Initialization, include = FALSE}

# Define paths
loc_result = file.path(getwd(), "result")
loc_sim = file.path(loc_result, "sim")
loc_function = file.path(getwd(), "function")
loc_final = file.path(getwd(), "data", "final")

# Load packages
packages <- c("bucky", "dplyr", "ggplot2", "ggrepel", "lmtest", "sandwich", "zoo", "RColorBrewer", "reshape2")
lapply(packages, require, character.only = TRUE)
rm(packages)

# Load functions
sapply(list.files(pattern = "[.]R$", path = loc_function, full.names = TRUE), source)

```

```{r Simulation specification, include = FALSE}

# Country set
country_set = c("France", "United States")

# Simulation periods
sim = seq(1970, 2080, 10)

# Estimation sample
est_sample = c(1970:2010)

```

```{r Load data, include = FALSE}

# Penn World Table
pwt = read.csv(file.path(loc_final, "pwt.csv"), header = TRUE) %>%
  select("Country", "Year", "emp", "avh", "rgdpna", "rnna", "lab_sh1", "lab_sh2") %>% 
  subset(Country %in% country_set & Year >= 1970)

# OECD data
oecd = read.csv(file.path(loc_final, "oecd.csv"), header = TRUE) %>% 
  select("Country", "Year", tax_rate = "tax_rev_PC_GDP", union_density = "union_density.lin_inter", union_coverage = "union_coverage.lin_inter") %>% 
  subset(Country %in% country_set & Year >= 1970)

# Demographic data
demo = read.csv(file.path(loc_final, "demo.csv"), header = TRUE) %>% 
  select("Country", "Year", "young", "young_1564", "old", "dep", "n", "p") %>% 
  subset(Country %in% country_set)

## Merge
df = merge(merge(pwt, oecd, all = TRUE), demo, all = TRUE) %>% 
  subset(Year >= 1970)

```

```{r Data retreatment, echo = FALSE}

# Variable modifications
df = df %>%
  group_by(Country) %>% 
  mutate(L = emp * 1000,
         Y = rgdpna / avh * 1000, # AVH control
         K = rnna / avh * 1000, # AVH control
         theta = lab_sh1, # Labor share
         tau = tax_rate / 100, # Tax rate
         u = 1 - L / (young_1564), # Unemployment rate
         p1 = lead(p, 40)) %>% 
  select(Country, Year, Ny = young, No = old, n, p, p1, dep, K, L, Y, theta, tau, u) %>% 
  mutate(L = L / first(L), # Normalized labor
         K = K / first(K), # Normalized capital
         Y = Y / first(Y), # Normalized output
         k = K / L, # Normalized capital-labor ratio
         Ny = L / (1-u), # Normalized young population
         No = Ny * dep) %>% # Normalized old population
  ungroup()

# Remove unused countries from Country levels
df$Country = df$Country %>% as.character %>% as.factor()

# Visualization
head(df)

# Write df
write.csv(df, file.path(loc_sim, "data.csv"), row.names = FALSE)

```

### Data for simulation

```{r Data for simulation, echo = FALSE}

init_seq = seq(1970, 2000, 10)

# Baseline data
data_base = df %>% 
  group_by(Country) %>% 
  subset(Year %in% sim) %>% 
  select(Country, Year, Ny, No, n, p, p1, K) %>% 
  mutate(Sequence = ((sim - 1970)/10) %% 4 + 1,
         Period = (sim - init_seq) / 40 + 1,
         Ny = ifelse(Year == 2010, NA, Ny),
         No = ifelse(Year == 2010, NA, No),
         K = ifelse(Year == 2010, NA, K),
         # Complete NA values for p1 in 2070 and 2080
         p1 = ifelse(Year >= 2070, p1[Year == 2060] + 
                       (Year - 2060)/10 * mean(p1/lag(p1)-1, na.rm = T), p1), 
         ## Create empty variables
         eta = NA, AK = NA, AL = NA, k1 = NA, k2 = NA, k = NA, X = NA, L = NA, w = NA,
         r = NA, Y = NA, u = NA, theta = NA, tau = NA, b = NA, h = NA, S = NA) 

# Re-order variables
data_base = data_base %>% select(Country, Year, Sequence, Period, Ny, No, n, p, p1, eta, AK, AL,
                                 k1, k2, k, X, L, w, r, Y, u, theta, tau, b, h, S, K)
  
# Visualization
head(data_base)

```

```{r Initial Specification, include = FALSE}

data = data_base %>% 
  # No biased technical change
  mutate(AK = 1, AL = 1) %>% 
  # Population dynamics
  demo_changer(init_spe = TRUE)

```


## Parameter calibration

The discount factor *alpha* is set to `r round(0.99^40,3)`. The relative bargaining power of the union *gamma* is set to `r 0.5`. *For more details, please consult "gamma.md" file.*

```{r Parameter - Dataframe, include = FALSE}

param_base = data.frame("Country" = rep(c("France", "United States"), each = length(sim)),
                   "Year" = sim, "alpha" = (0.99)^40, "gamma" = 0.5)

```

### Production function

I estimate the elasticity of substitution between capital and labor using the first order conditions from the profit maximization. Estimation are done for France and United States between 1970 and 2010, using Penn World Table 9.1 data. *For more details, please consult "sigma.md" file.*

```{r Parameter - Production function - DataFrame, echo = FALSE}

# Dataframe for estimation
est_sigma = df %>% 
  group_by(Country) %>% 
  mutate(k_log = log(k),
         THETA_log = log(theta/(1-theta)),
         t_diff = Year - first(Year)) %>% 
  select(Country, Year, k_log, THETA_log, t_diff) %>% 
  subset(Year %in% c(1970:2010)) %>% 
  ungroup()

```

#### France

```{r Parameter - Production function - France, echo = FALSE}

### Regression : one sigma for the whole period
  ols.france_all = est_sigma %>% 
    subset(Country == "France") %>% 
    lm(THETA_log ~ k_log + t_diff, data = .)
  # Report sigma
    sigma.fr_all = 1/(1 + ols.france_all$coefficients[2]) %>% unname()

### Regression : sigma before the change in the regime (1985)
  ols.france_before = est_sigma %>% 
    subset(Country == "France" & Year <= 1985) %>% 
    lm(THETA_log ~ k_log, data = .)
# Report sigma
  # Significant
    # sigma.fr_before = 1/(1 + ols.france_before$coefficients[2]) %>% unname()
  # Not significant => sigma.fr_before = 1
    sigma.fr_before = 1

### Regression : sigma after the change in the regime (1985)
  ols.france_after = est_sigma %>%
    subset(Country == "France" & Year > 1985) %>% 
    lm(THETA_log ~ k_log, data = .)
  # Report sigma
    sigma.fr_after = 1/(1 + ols.france_after$coefficients[2]) %>% unname()
    
### Report all sigmas
  print(paste0("One for all : ", round(sigma.fr_all,3)))
  print(paste0("Before 1985 : ", round(sigma.fr_before,3)))
  print(paste0("After 1985 : ", round(sigma.fr_after,3)))

```

#### United States

```{r Parameter - Production function - United-States, echo = FALSE}

### Regression : one sigma for the whole period
  ols.us_all = est_sigma %>% 
    subset(Country == "United States") %>% 
    lm(THETA_log ~ k_log, data = .)
  # Report Sigma
  sigma.us_all = 1/(1 + ols.us_all$coefficients[2]) %>% unname()
  print(paste0("One for all : ", round(sigma.us_all,3)))

```

#### Summary

```{r Parameter - Production function - Summary, echo = FALSE}

# Add production function parameters
param_base = param_base %>%
  mutate("phi" = rep(1 - df$theta[df$Year == 1970], each = length(sim)), 
         "sigma" = ifelse(Country == "France", sigma.fr_all, sigma.us_all),
         "a" = NA)

# Visualization
param_base %>% subset(Year == 1970) %>% select(Country, phi, sigma, a)

```

### Preferences

The relative per-capita influence of old households *omega* is deduced such that the capital-to-labor ratio is matched in 1970. The preference for government health expenditure *beta* is deduced such that the tax rate in 1970 is matched.


```{r Parameter - Preferences, echo = FALSE}

# Compute omega and beta
omega_beta = df %>%
  merge(param_base) %>%
  mutate(X = (sigma + (1-phi)/phi*(1-gamma*(1-sigma))/gamma*k^((1-sigma)/sigma))^(-1),
         eta = (1-phi)/phi*k^((1-sigma)/sigma) * ((Ny/K*k-1)*exp(-X) + 1),
         omega.raw = n/p*(1+alpha*p1)/eta,
         beta.raw = 1/(1 - tau)/(1-theta) - 1 - eta)

```

```{r Parameter - Omega/Beta analysis, echo = FALSE}

omega_beta %>% 
  select(Country, Year, omega.raw, beta.raw) %>%
  setNames(c("Country", "Year", "omega", "beta")) %>% 
  subset(Year <= 2010) %>%
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, color = Country)) +
  geom_line() +
  facet_wrap(variable ~ ., scale = "free", labeller = label_parsed) +
  theme_classic()

```


```{r Parameter - Preferences, echo = FALSE}

# Compute different values for omega/beta
param_base = omega_beta %>% 
  group_by(Country) %>% 
  mutate(omega.avg = mean(omega.raw, na.rm = TRUE),
         beta.avg = mean(beta.raw, na.rm = TRUE),
         omega.init = first(omega.raw),
         beta.init = first(beta.raw)) %>% 
  select(Country, Year, starts_with("omega"), starts_with("beta")) %>% 
  merge(param_base, .)

# Visualization
param_base %>% subset(Year == 1970) %>% select(Country, starts_with("omega"), starts_with("beta"))

```

```{r Parameter - Preferences - Select omega/beta, echo = FALSE}

# Choose beta and omega
param_base = param_base %>%
  group_by(Country) %>%
  mutate(omega = omega.init,
         beta = beta.init) %>%
  select(Country, Year, alpha, gamma, phi, sigma, a, omega, beta)


```


### Scale parameter

The scale parameter *A* is decuded using grid search to match the average labor share between 2008 and 2012.

```{r Parameter - Scale parameter, echo = FALSE}

data = data_base %>% 
  # No biased technical change
  mutate(AK = 1, AL = 1) %>% 
  # Add parameters
  merge(param_base) %>% 
  # Demography
  demo_changer(AFinder = TRUE)

# A Finder script
source("./script/sim_AFinder.R")

# Assign A scale parameter to param_base
param_base$A = data$A

```

### Summary

All parameters are constant over time.

```{r Parameter -  Summary, echo = FALSE}

# Visualization
param_base %>% subset(Year == 1970) %>% select(-Year, -a) 

# Assign values
param = param_base 

```

## Simulation

```{r Graph - Parameters, include = FALSE}

breaks_10_years = seq(1970, 2080, 10)
labs_20_years = as.vector(rbind(seq(1970, 2080, 20), rep("", length(breaks_10_years)/2)))
scale_graph = 1920/1080

```

### Demography : break years

```{r Breakers, echo = FALSE}


breakers = demo %>% 
  ## Compute demographic data for 1960
  subset(Year == 1960) %>% 
  mutate(Sequence = NA, Period = NA, Ny = NA, No = NA, p1 = NA) %>% 
  select(Country, Year, Sequence, Period, Ny, No, n, p, p1) %>% 
  rbind(., data_base %>% 
          select(Country, Year, Sequence, Period, Ny, No, n, p, p1) %>% 
          subset(Year == 2000) %>% 
          ungroup()) %>% 
  group_by(Country) %>% 
  mutate(p1 = ifelse(Year == 1960, dplyr::lead(p), p1),
         Ny = ifelse(Year == 1960, dplyr::lead(Ny)/dplyr::lead(n), Ny),
         No = ifelse(Year == 1960, p/n*Ny, No),
         Sequence = ifelse(Year == 1960, 4, Sequence),
         Period = ifelse(Year == 1960, 0, Period)) %>% 
  subset(Year == 1960) %>% 
  ungroup() %>% 
  ## Demographic data for 1960 : done
  rbind(., data_base %>% 
          select(Country, Year, Sequence, Period, Ny, No, n, p, p1) %>% 
          ungroup()) %>% 
  arrange(Country) %>% 
  merge(., param_base %>% select(Country, alpha, omega) %>% unique()) %>% 
  group_by(Country, Sequence) %>% 
  mutate(eta = n/p*(1+alpha*p1)/omega,
         Ny = ifelse(Period == 2, lag(Ny,1)*n, Ny),
         No = ifelse(Period == 2, lag(Ny,1)*p, No),
         Ny = ifelse(Period == 3, lag(Ny,1)*n, Ny),
         No = ifelse(Period == 3, lag(Ny,1)*p, No),) %>% 
  select(-alpha, -omega) %>% 
  ungroup()

# Visualization
breakers

```

### Baseline model

```{r Simulation - BModel, include = FALSE}

# Specification
spe = "baseline"

# Initialize result dataset
final = data.frame(matrix(ncol = ncol(data)+ ncol(param) -2 + 1, nrow = 0)) %>%
  setNames(c("Specification", names(data), names(param)[-c(1,2)]))

# Prepare data for simulation
data = data_base %>% 
  # Merge with parameters
  merge(param) %>% 
  # No BTC
  mutate(AK = 1, AL = 1) %>% 
  # Demography
  demo_changer() %>% 
  # Define specification model
  mutate(Specification = spe) %>%
  # Reorder variables
  select(Specification, everything())

# Prepare result data frame to loop on
result = final

# Simulate the baseline model for each country
for(country in country_set){
    
    result = data %>%
      subset(Country == country) %>% 
      model(time = 3) %>% 
      rbind(result, .)
    
}

# Regroup result
baseline = result

# Write final_baseline
write.csv(baseline, file.path(loc_sim, paste0("final_", spe, ".csv")), row.names = FALSE)

```

#### Performance

```{r Graph - BModel - Performance, echo = FALSE}

# Prepare data and regression
perf = baseline %>% 
  subset(Specification == "baseline") %>% 
  select(Country, Year, theta) %>% 
  merge(., 
        df %>% select(Country, Year, theta) %>% setNames(c("Country", "Year", "labsh")),
        all = TRUE
        ) %>% 
  interpol_group() %>% 
  filter(complete.cases(.)) %>% 
  mutate(Year1 = Year - 1970 + 1,
         Year2 = Year1^2,
         Year3 = Year1^3,
         # Year4 = Year1^4,
         # Year5 = Year1^5,
         labsh.fitted = lm(data = .,
                           formula = labsh 
                           ~ Year1*Country 
                           + Year2*Country
                           + Year3*Country 
                           # + Year4*Country 
                           # + Year5*Country 
                           - Country) %>%
           fitted.values() %>% unname())

# Plot
perf %>% 
  select(Country, Year, theta, labsh, labsh.fitted) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, color = variable)) +
  geom_line() +
  facet_wrap(Country ~ .) +
  scale_color_manual(name = "",
                     breaks = c("theta", "labsh", "labsh.fitted"),
                     labels = c("Model", "Data", "Smoothed data"),
                     values = c(brewer.pal(8, "Set1")[1],
                                "black",
                                brewer.pal(8, "Set1")[2]),
                     na.value = "black") +
  theme_classic(base_size = 14) +
  guides(color = guide_legend(order = 0), linetype = guide_legend(order = 1)) +
  theme(legend.position = c(0.99, 0.99),
        legend.justification = c("right", "top"),
        legend.direction = "vertical",
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "Year", y = "Labor income share")

# Performance regression France
perf %>% 
  subset(Country == "France") %>% 
  lm(labsh.fitted ~ theta, data = .) %>% 
  summary()

# Performance regression United-States
perf %>% 
  subset(Country == "United States") %>% 
  lm(labsh.fitted ~ theta, data = .) %>% 
  summary()
  


```

### Fill the gap : France 1980

```{r FGapModel - Parameter, echo = FALSE}
# Change param for France
param = param %>% 
  mutate(sigma = ifelse(Country == "France",
                        ifelse(Year <= 1980, sigma.fr_before, sigma.fr_after), sigma))

# Change A
data = data_base %>%
  # No biased technical change
  mutate(AK = 1, AL = 1) %>%
  # Add parameters
  merge(param) %>%
  # Remove the previous A
  select(-A) %>%
  # Demography
  demo_changer(AFinder = TRUE)

# A Finder script
source("./script/sim_AFinder.R")

# Assign A scale parameter to param_base
param$A = data$A

# Visualization : New A
param %>% subset(Year == 1970) %>% select(Country, A)

```


```{r FGapModel - Simulation, echo = FALSE}

# Specification
spe = "fillgap"

# Initialize result dataset
fillgap = data.frame(matrix(ncol = ncol(data)+ ncol(param) -2 + 1, nrow = 0)) %>%
  setNames(c("Specification", names(data), names(param)[-c(1,2)]))

# Prepare data for simulation
data = data_base %>% 
  # Merge with parameters
  merge(param) %>% 
  # No BTC
  mutate(AK = 1, AL = 1) %>% 
  # Demography
  demo_changer() %>% 
  # Define specification model
  mutate(Specification = spe) %>%
  # Reorder variables
  select(Specification, everything())

# Simulate the fillthegap model for France
fillgap = data %>%
  subset(Country == "France") %>%
  model(time = 3)

# Write fillgap
write.csv(fillgap, file.path(loc_sim, paste0("final_", spe, ".csv")), row.names = FALSE)

```

```{r Graph - FGapModel - LS 1970-2010, echo = FALSE}

baseline %>% 
  subset(Specification == "baseline") %>% 
  select(Country, Year, theta) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  mutate(variable = ifelse(Country == "France", "base.fr", "base.us")) %>% 
  rbind(.,
        fillgap %>% select(Country, Year, theta) %>% setNames(c("Country", "Year", "fill.fr")) %>% 
          melt(id.vars = c("Country", "Year"))) %>% 
  rbind(.,
        df %>% select(Country, Year, theta) %>% setNames(c("Country", "Year", "data")) %>% 
          melt(id.vars = c("Country", "Year"))
        ) %>% 
  filter(complete.cases(.)) %>% 
  mutate(fill = ifelse(variable == "fill.fr", "fill", "other")) %>% 
  subset(Year %in% c(1970:2010)) %>% 
  # Trick to put data line under others
  mutate(variable = as.character(variable),
         variable = ifelse(variable == "data", "a.data", variable),
         variable = as.factor(variable)) %>% 
  
  ggplot(aes(x = Year, y = value, color = variable, linetype = fill)) +
  geom_line() +
  facet_wrap(Country ~ ., scales = "fixed") +
  scale_color_manual(breaks = c("base.fr", "base.us", "a.data", "fill.fr"),
                    values = c(brewer.pal(8, "Set1")[c(1,2)], "black", brewer.pal(8, "Set1")[1]) %>% 
                      setNames(c("base.fr", "base.us", "a.data", "fill.fr"))) +
  scale_linetype_manual(breaks = c("fill", "other"),
                        values = c("dashed", "solid")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") +
  ggsave(file.path(loc_result, "baseline7010_facet.png"),
         width = scale_graph*5, height = scale_graph*5/2)

```

```{r Graph - FGapModel - LS 1970-2080, echo = FALSE}

baseline %>% 
  subset(Specification == "baseline") %>% 
  select(Country, Year, theta) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  mutate(variable = ifelse(Country == "France", "base.fr", "base.us")) %>% 
  rbind(.,
        fillgap %>% select(Country, Year, theta) %>% setNames(c("Country", "Year", "fill.fr")) %>% 
          melt(id.vars = c("Country", "Year"))) %>% 
  rbind(.,
        df %>% select(Country, Year, theta) %>% setNames(c("Country", "Year", "data")) %>% 
          melt(id.vars = c("Country", "Year"))
        ) %>% 
  filter(complete.cases(.)) %>% 
  mutate(fill = ifelse(variable == "fill.fr", "fill", "other")) %>% 
  subset(Year %in% c(1970:2080)) %>%
  # Trick to put data line under others
  mutate(variable = as.character(variable),
         variable = ifelse(variable == "data", "a.data", variable),
         variable = as.factor(variable)) %>% 
  
  ggplot(aes(x = Year, y = value, color = variable, linetype = fill)) +
  geom_line() +
  facet_wrap(Country ~ ., scales = "fixed") +
  scale_color_manual(breaks = c("base.fr", "base.us", "data", "fill.fr"),
                    values = c(brewer.pal(8, "Set1")[c(1,2)], "black", brewer.pal(8, "Set1")[1]) %>% 
                      setNames(c("base.fr", "base.us", "a.data", "fill.fr"))) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  scale_linetype_manual(breaks = c("fill", "other"),
                        values = c("dashed", "solid")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") +
  ggsave(file.path(loc_result, "baseline7080_facet.png"),
         width = scale_graph*5, height = scale_graph*5/2)

```


### Variables dynamics

```{r Graph - Loc, echo = FALSE}

loc_dev = file.path(loc_result, "deviation")

# Computation average growth rate of p on 10 years per country
baseline %>% select(Country, Year, p) %>% subset(Year >= 2010) %>% group_by(Country) %>% mutate(p = p/dplyr::lag(p) -1)%>% summarize(mean(p, na.rm = T))

```

#### Demography

```{r Graph - FGapModel - Demo 70-10, echo = FALSE}

baseline %>%
  # subset(Country == "France") %>% 
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>% 
  group_by(from) %>% 
  mutate(
    # Deviation from the 1970 steady state
         "n" = n/n[Year == 1970] -1,
         "p" = p/p[Year == 1970] -1,
         "p[+1]" = p1/p1[Year == 1970] -1,
         "eta" = eta/eta[Year == 1970] -1) %>% 
  ungroup() %>% 
  select(Specification, Country , Year, c("n", "p", "p[+1]", "eta")) %>% 
  subset(Year %in% c(1970:2010)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  subset(Specification == "baseline") %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_x_continuous(labels = c("1970", "", "1990", "", "2010")) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", legend.direction = "vertical",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") +
  ggsave(file.path(loc_dev, "dev_demo_7010.png"), width = scale_graph*5, height = scale_graph*5/3)
  
```

```{r Graph - FGapModel - Demo 10-80, echo = FALSE}

baseline %>%
  # subset(Country == "France") %>% 
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>% 
  group_by(from) %>% 
  mutate(
    # Deviation from the 2010 steady state
         "n" = n/n[Year == 2010] -1,
         "p" = p/p[Year == 2010] -1,
         "p[+1]" = p1/p1[Year == 2010] -1,
         "eta" = eta/eta[Year == 2010] -1) %>% 
  ungroup() %>% 
  select(Specification, Country , Year, c("n", "p", "p[+1]", "eta")) %>% 
  subset(Year %in% c(2010:2080)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  subset(Specification == "baseline") %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_x_continuous(breaks = seq(2010,2080,10), 
                     labels = c("2010","", "2030", "", "2050", "", "2070", "")) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", legend.direction = "vertical",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") +
  ggsave(file.path(loc_dev, "dev_demo_1080.png"), width = scale_graph*5, height = scale_graph*5/3)
  
```


##### Public

```{r Graph - FGapModel - Public 70-10, echo = FALSE}

baseline %>%
  # subset(Country == "France") %>% 
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>% 
  group_by(from) %>% 
  mutate(`b share` = b*u*Ny/tau/Y,
         `h share` = h*No/tau/Y,
         bh = b/h,
    # Deviation from the 1970 steady state
         "eta" = eta/eta[Year == 1970] -1,
         "tau" = tau/tau[Year == 1970] -1,
         "b" = b/b[Year == 1970]-1,
         "h" = h/h[Year == 1970]-1,
         "`b share`" = `b share`/`b share`[Year == 1970]-1,
         "`h share`" = `h share`/`h share`[Year == 1970]-1,
         "b/h" = bh/bh[Year == 1970]-1) %>% 
  ungroup() %>% 
  select(Specification, Country , Year, c("eta", "tau", "`b share`")) %>% 
  subset(Year %in% c(1970:2010)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_x_continuous(labels = c("1970", "", "1990", "", "2010")) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", legend.direction = "vertical",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") +
  ggsave(file.path(loc_dev, "dev_public_7010.png"), width = scale_graph*5, height = scale_graph*5/3)
  
```

```{r Graph - FGapModel - Public 10-80, echo = FALSE}

baseline %>%
  # subset(Country == "France") %>% 
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>% 
  group_by(from) %>% 
  mutate(`b share` = b*u*Ny/tau/Y,
         `h share` = h*No/tau/Y,
          bh = b/h,
    # Deviation from the 2010 steady state
         "eta" = eta/eta[Year == 2010] -1,
         "tau" = tau/tau[Year == 2010] -1,
         "b" = b/b[Year == 2010]-1,
         "h" = h/h[Year == 2010]-1,
         "`b share`" = `b share`/`b share`[Year == 2010]-1,
         "`h share`" = `h share`/`h share`[Year == 2010]-1,
         "b/h" = bh/bh[Year == 2010]-1) %>% 
  ungroup() %>% 
  select(Specification, Country , Year, c("eta", "tau", "`b share`")) %>% 
  subset(Year %in% c(2010:2080)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_x_continuous(breaks = seq(2010,2080,10), 
                     labels = c("2010","", "2030", "", "2050", "", "2070", "")) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", legend.direction = "vertical",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") +
  ggsave(file.path(loc_dev, "dev_public_1080.png"), width = scale_graph*5, height = scale_graph*5/3)
  
```

##### Outside

```{r Graph - FGapModel - Outside 70-10, echo = FALSE}

baseline %>%
  # subset(Country == "France") %>% 
  rbind(fillgap) %>% 
  
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>% 
  mutate(net = 1-tau,
         outside = b/(1-tau),
         # Deviation from the 1970 steady state
         "b" = b/b[Year == 1970] -1,
         "1-tau" = net/net[Year == 1970] -1,
         "b/(1-tau)" = outside/outside[Year == 1970] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year, c("b", "1-tau", "b/(1-tau)")) %>% 
  subset(Year %in% c(1970:2010)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_x_continuous(labels = c("1970", "", "1990", "", "2010")) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", legend.direction = "vertical",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") +
  ggsave(file.path(loc_dev, "dev_outside_7010.png"), width = scale_graph*5, height = scale_graph*5/3)
  
```


```{r Graph - FGapModel - Outside 10-80, echo = FALSE}

baseline %>%
  # subset(Country == "France") %>% 
  rbind(fillgap) %>% 
  
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>% 
  mutate(net = 1-tau,
         outside = b/(1-tau),
         # Deviation from the 1970 steady state
         "b" = b/b[Year == 2010] -1,
         "1-tau" = net/net[Year == 2010] -1,
         "b/(1-tau)" = outside/outside[Year == 2010] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year, c("b", "1-tau", "b/(1-tau)")) %>% 
  subset(Year %in% c(2010:2080)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_x_continuous(breaks = seq(2010,2080,10), 
                     labels = c("2010","", "2030", "", "2050", "", "2070", "")) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", legend.direction = "vertical",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") +
  ggsave(file.path(loc_dev, "dev_outside_1080.png"), width = scale_graph*5, height = scale_graph*5/3)
  

```

##### Bargaining

```{r Graph - FGapModel - Bargaining 70-10, echo = FALSE}

baseline %>%
  # subset(Country == "France") %>% 
  rbind(fillgap) %>% 
  
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>% 
  mutate(outside = b/(1-tau),
         # Deviation from the 1970 steady state
         "b/(1-tau)" = outside/outside[Year == 1970] -1,
         "w" = w/w[Year == 1970] -1,
         "X" = X/X[Year == 1970] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year, c("b/(1-tau)", "w", "X")) %>% 
  subset(Year %in% c(1970:2010)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_x_continuous(labels = c("1970", "", "1990", "", "2010")) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", legend.direction = "vertical",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") +
  ggsave(file.path(loc_dev, "dev_bargain_7010.png"), width = scale_graph*5, height = scale_graph*5/3)
  
```

```{r Graph - FGapModel - Bargaining 10-50, echo = FALSE}

baseline %>%
  # subset(Country == "France") %>% 
  rbind(fillgap) %>% 
  
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>% 
  mutate(outside = b/(1-tau),
         # Deviation from the 2010 steady state
         "eta" = eta/eta[Year == 2010] -1,
         "b/(1-tau)" = outside/outside[Year == 2010] -1,
         "w" = w/w[Year == 2010] -1,
         "X" = X/X[Year == 2010] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year, c("b/(1-tau)", "w", "X")) %>% 
  subset(Year %in% c(2010:2080)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_x_continuous(breaks = seq(2010,2080,10), 
                     labels = c("2010","", "2030", "", "2050", "", "2070", "")) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", legend.direction = "vertical",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") +
  ggsave(file.path(loc_dev, "dev_bargain_1080.png"), width = scale_graph*5, height = scale_graph*5/3)
  
```

##### Production

```{r Graph - FGapModel - Production 70-10, echo = FALSE}

baseline %>%
  # subset(Country == "France") %>% 
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>%  
  mutate(
         # Deviation from the 1970 steady state
         "K" = K/K[Year == 1970] -1,
         "L" = L/L[Year == 1970] -1,
         "Y" = Y/Y[Year == 1970] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year, c("K", "L", "Y")) %>% 
  subset(Year %in% c(1970:2010)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  scale_x_continuous(labels = c("1970", "", "1990", "", "2010")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", legend.direction = "vertical",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") +
  ggsave(file.path(loc_dev, "dev_prod_7010.png"), width = scale_graph*5, height = scale_graph*5/3)

```


```{r Graph - FGapModel - Production 10-80, echo = FALSE}

baseline %>%
  # subset(Country == "France") %>% 
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>%  
  mutate(
         # Deviation from the 2010 steady state
         "K" = K/K[Year == 2010] -1,
         "L" = L/L[Year == 2010] -1,
         "Y" = Y/Y[Year == 2010] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year, c("K", "L", "Y")) %>% 
  subset(Year %in% c(2010:2080)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  scale_x_continuous(breaks = seq(2010,2080,10), 
                     labels = c("2010","", "2030", "", "2050", "", "2070", "")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", legend.direction = "vertical",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") +
  ggsave(file.path(loc_dev, "dev_prod_1080.png"), width = scale_graph*5, height = scale_graph*5/3)

```

##### Unemployment


```{r Graph - FGapModel - Unemployment 70-10, echo = FALSE}

baseline %>%
  # subset(Country == "France") %>% 
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>%  
  mutate(
         # Deviation from the 1970 steady state
         "N^y" = Ny/Ny[Year == 1970] -1,
         "L" = L/L[Year == 1970] -1,
         "u" = u/u[Year == 1970] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year, c("N^y", "L", "u")) %>% 
  subset(Year %in% c(1970:2010)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  scale_x_continuous(labels = c("1970", "", "1990", "", "2010")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", legend.direction = "vertical",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") +
  ggsave(file.path(loc_dev, "dev_unemp_7010.png"), width = scale_graph*5, height = scale_graph*5/3)

```


```{r Graph - FGapModel - Unemployment 10-80, echo = FALSE}

baseline %>%
  # subset(Country == "France") %>% 
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>%  
  mutate(
         # Deviation from the 2010 steady state
         "N^y" = Ny/Ny[Year == 2010] -1,
         "L" = L/L[Year == 2010] -1,
         "u" = u/u[Year == 2010] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year, c("N^y", "L", "u")) %>% 
  subset(Year %in% c(2010:2080)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  scale_x_continuous(breaks = seq(2010,2080,10), 
                     labels = c("2010","", "2030", "", "2050", "", "2070", "")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", legend.direction = "vertical",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") +
  ggsave(file.path(loc_dev, "dev_unemp_1080.png"), width = scale_graph*5, height = scale_graph*5/3)

```

##### Labor share

```{r Graph - FGapModel - LS 70-10, echo = FALSE}

baseline %>%
  # subset(Country == "France") %>% 
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>%  
  mutate("YL" = Y/L,
         # Deviation from the 1970 steady state
         "w" = w/w[Year == 1970] -1,
         "u" = u/u[Year == 1970] -1,
         "Y/L" = YL/YL[Year == 1970] -1,
         "theta" = theta/theta[Year == 1970] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year, c("w", "Y/L", "theta")) %>% 
  subset(Year %in% c(1970:2010)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  scale_x_continuous(labels = c("1970", "", "1990", "", "2010")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", legend.direction = "vertical",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") +
  ggsave(file.path(loc_dev, "dev_laborshare_7010.png"), width = scale_graph*5, height = scale_graph*5/3)

```

```{r Graph - FGapModel - LS 10-80, echo = FALSE}

baseline %>%
  # subset(Country == "France") %>% 
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>%  
  mutate("YL" = Y/L,
         # Deviation from the 2010 steady state
         "w" = w/w[Year == 2010] -1,
         "u" = u/u[Year == 2010] -1,
         "Y/L" = YL/YL[Year == 2010] -1,
         "theta" = theta/theta[Year == 2010] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year, c("w", "Y/L", "theta")) %>% 
  subset(Year %in% c(2010:2080)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  scale_x_continuous(breaks = seq(2010,2080,10), 
                     labels = c("2010","", "2030", "", "2050", "", "2070", "")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", legend.direction = "vertical",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") +
  ggsave(file.path(loc_dev, "dev_laborshare_1080.png"), width = scale_graph*5, height = scale_graph*5/3)

```

### Welfare analysis

I only consider France in the fillgap specification, so the one with a break in the regime of the elasticity of substitution. I also consider the baseline specification for the United-States.

```{r Welfare - Computation, echo = FALSE}

# Data selection
welfare = baseline %>%
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>%
  subset(from != "baseline.France") %>% 
  mutate(Country_Seq = interaction(Country, Sequence)) %>% 
  select(Country_Seq, everything(), -from) %>% 
  group_by(Country_Seq)

# Computation
welfare = welfare %>% 
  ## Individual consumptions
  mutate("c[1,t]^e" = 1/(1+alpha*p1)*(1-tau)*w,
         "c[1,t]^u" = 1/(1+alpha*p1)*b,
         "c[2,t]^e" = alpha*p/(1+alpha*p)*(1-tau)*r/p*(1-dplyr::lag(tau))*dplyr::lag(w),
         "c[2,t]^u" = alpha*p/(1+alpha*p)*(1-tau)*r/p*dplyr::lag(b),
         "c[2,t+1]^e" = alpha*p1/(1+alpha*p1)*(1-dplyr::lead(tau))*dplyr::lead(r)/p1*(1-tau)*w,
         "c[2,t+1]^u" = alpha*p1/(1+alpha*p1)*(1-dplyr::lead(tau))*dplyr::lead(r)/p1*b,
  ## Utility
         # Utility for a individual of type i born at time t
         "U[t]^e" = log(`c[1,t]^e`) + 
           alpha*p1*(log(`c[2,t+1]^e`) + beta * log(dplyr::lead(h))),
         "U[t]^u" = log(`c[1,t]^u`) + 
           alpha*p1*(log(`c[2,t+1]^u`) + beta * log(dplyr::lead(h))),
         # Utility of a young household (born at time t) at time t (do not consider old age)
         "U[t]^{y,e}" = log(`c[1,t]^e`),
         "U[t]^{y,u}" = log(`c[1,t]^u`),
         # Utility of an old household (born at time t-1) at time t (cancel the effect of p)
         "U[t]^{o,e}" = log(`c[2,t]^e`) + beta * log(h),
         "U[t]^{o,u}" = log(`c[2,t]^u`) + beta * log(h),
         # Average utility - Young and old
         "U[t]^y" = (1-u)*`U[t]^{y,e}` + u*`U[t]^{y,u}`,
         "U[t]^o" = (1-dplyr::lag(u))*`U[t]^{o,e}` + dplyr::lag(u)*`U[t]^{o,u}`,
         # Average utility - All
         "U[t]" = (1-u)*`U[t]^e`+u*`U[t]^u`,
         # Welfare at time t
         "W[t]" = Ny*`U[t]^y` + No*`U[t]^o`,
         # Average welfare at time t
         "W[t]^{avg}" = `W[t]`/(Ny+No),
  ## Aggregated consumption
         "C[1,t]" = 1/(1+alpha*p1)*1/(1+beta+eta)*Y,
         "C[2,t]" = alpha*p/(1+alpha*p)*1/(1+beta+eta)*Y,
         "H[t]" = No*h,
  ## Average
         "c[1,t]^{avg}" = `C[1,t]`/Ny,
         "c[2,t]^{avg}" = `C[2,t]`/No,
  ## Average utility
         "U[t]^{y,avg}" = log(`c[1,t]^{avg}`),
         "U[t]^{o,avg}" = log(`c[2,t]^{avg}`) + log(h),
         )

```

```{r Welfare - Plot, echo = FALSE}

# Utilities of the 4 type of agents at time t
welfare %>% 
  ungroup() %>% 
  select(Country, Year, "U[t]^{y,e}", "U[t]^{y,u}", "U[t]^{o,e}", "U[t]^{o,u}",
         "U[t]^y", "U[t]^o",
         "U[t]^e", "U[t]^u", "U[t]"
         ) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, color = variable)) +
  geom_line() +
  facet_wrap(Country ~ ., scale = "free") +
  theme_classic()

```
```{r}

# Full Utility of employed versus unemployed born at time t
welfare %>% 
  ungroup() %>% 
  select(Country, Year, "U[t]^e", "U[t]^u") %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, color = variable)) +
  geom_line() +
  facet_wrap(Country ~ ., scale = "free") +
  theme_classic()

```
```{r}

# Average utility of young and old at time t
welfare %>% 
  ungroup() %>% 
  select(Country, Year, "U[t]^y", "U[t]^o") %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, color = variable)) +
  geom_line() +
  facet_wrap(Country ~ ., scale = "free") +
  theme_classic()

```

```{r}

# Global average utility
welfare %>% 
  ungroup() %>% 
  select(Country, Year, "U[t]") %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, color = variable)) +
  geom_line() +
  facet_wrap(Country ~ ., scale = "free") +
  theme_classic()

```
```{r Welfare}

# Welfare
welfare %>% 
  ungroup() %>% 
  select(Country, Year, "W[t]", "W[t]^{avg}") %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, color = variable)) +
  geom_line() +
  facet_wrap(Country ~ ., scale = "free") +
  theme_classic()

```

```{r Avg utility per age}

welfare %>% 
  ungroup() %>% 
  select(Country, Year, "c[1,t]^{avg}", "c[2,t]^{avg}") %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, color = variable)) +
  geom_line() +
  facet_wrap(Country ~ ., scale = "free") +
  theme_classic()

```


### Redistribution

```{r}

# Data selection
redis = baseline %>%
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>%
  subset(from != "baseline.France") %>% 
  select(-from) %>% 
  group_by(Country) %>% 
  
  mutate(wL = w*L,
         rK = r*K,
         # Step 2
         wL_net = (1-tau)*wL,
         rK_net = (1-tau)*rK,
         gov_rev = tau*Y,
         # Step 3
         unemp_ben = b*u*Ny,
         health_spen = h*No,
         # Step 4
         C1 = 1/(1+alpha*p1)*(wL_net+unemp_ben),
         Saving = alpha*p1/(1+alpha*p1)*(wL_net+unemp_ben),
         C2 = rK_net,
         # Incomes
         inc_y = wL_net + unemp_ben,
         inc_o = rK_net,
         # Labor share
         theta = wL/Y
         ) %>% 
  select(Country, Year, wL, rK, wL_net, rK_net, gov_rev, unemp_ben, health_spen,
         C1, Saving, C2, inc_y, inc_o, Y, theta, eta) %>% 
  ungroup()



```

```{r}

redis %>% 
  mutate(wL_bis = wL) %>% 
  select(Country, Year, rK, wL, wL_bis) %>% 
  melt(id.vars = c("Country", "Year", "wL_bis")) %>% 
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable),
           alpha = .7) +
  geom_line(aes(y = wL_bis), linetype = "dashed") +
  facet_wrap(Country ~ .) +
  scale_fill_manual(name = "",
                    breaks = c("rK", "wL"),
                    labels = c("Capital income", "Labor income"),
                    values = brewer.pal(8, "Set1")[c(1,2)],
                    na.value = "black") +
  theme_classic()

redis %>% 
  mutate(wL = wL/Y,
         rK = rK/Y) %>% 
  select(Country, Year, rK, wL, theta) %>% 
  melt(id.vars = c("Country", "Year", "theta")) %>% 
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable),
           alpha = 1) +
  geom_line(aes(y = theta), linetype = "dashed") +
  facet_wrap(Country ~ .) +
  scale_fill_manual(name = "",
                    breaks = c("rK", "wL"),
                    labels = c("Capital income", "Labor income"),
                    values = brewer.pal(11, "Set3")[c(4,5)],
                    na.value = "black") +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_classic() +
  labs(x = "", y = "Share of GDP") +
  theme(legend.position = "bottom") +
  ggsave("stacked_test1.png", width = 1920/1080*5, height = 5)

```

```{r}


redis %>% 
  select(Country, Year, rK_net, gov_rev, wL_net, wL) %>% 
  melt(id.vars = c("Country", "Year", "wL")) %>% 
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable),
           alpha = .7) +
  geom_line(aes(y = wL), linetype = "dashed") +
  facet_wrap(Country ~ .) +
  scale_fill_manual(name = "",
                    breaks = c("rK_net", "gov_rev", "wL_net"),
                    labels = c("Net capital income", "Government revenue",
                               "Net labor income"),
                    values = brewer.pal(8, "Set1")[c(1,3,2)],
                    na.value = "black") +
  theme_classic()

redis %>% 
  mutate(wL_net = wL_net/Y,
         gov_rev = gov_rev/Y,
         rK_net = rK_net/Y) %>% 
  select(Country, Year, rK_net, gov_rev, wL_net, theta) %>% 
  melt(id.vars = c("Country", "Year", "theta")) %>% 
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable),
           alpha = 1) +
  geom_line(aes(y = theta), linetype = "dashed") +
  facet_wrap(Country ~ .) +
  scale_fill_manual(name = "",
                    breaks = c("rK_net", "gov_rev", "wL_net"),
                    labels = c("Net capital income", "Government revenue",
                               "Net labor income"),
                    values = brewer.pal(11, "Set3")[c(4,7,5)],
                    na.value = "black") +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_classic() +
  labs(x = "", y = "Share of GDP") +
  theme(legend.position = "bottom") +
  ggsave("stacked_test2.png", width = 1920/1080*5, height = 5)

```

```{r}


redis %>% 
  select(Country, Year, rK_net, health_spen, unemp_ben, wL_net, wL) %>% 
  melt(id.vars = c("Country", "Year", "wL")) %>% 
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable)) +
  geom_line(aes(y = wL), linetype = "dashed") +
  facet_wrap(Country ~ .) +
  theme_classic()

redis %>% 
  mutate(wL_net = wL_net/Y,
         unemp_ben = unemp_ben/Y,
         health_spen = health_spen/Y,
         rK_net = rK_net/Y) %>% 
  select(Country, Year, rK_net, health_spen, unemp_ben, wL_net, theta) %>% 
  melt(id.vars = c("Country", "Year", "theta")) %>% 
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable),
           alpha = 1) +
  geom_line(aes(y = theta), linetype = "dashed") +
  facet_wrap(Country ~ .) +
  scale_fill_manual(name = "",
                    breaks = c("rK_net", "health_spen", "unemp_ben", "wL_net"),
                    labels = c("Net capital income", "Health spend.",
                               "Unemployment spend.", "Net labor income"),
                    values = brewer.pal(11, "Set3")[c(4,6,3,5)],
                    na.value = "black") +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_classic(base_size = 14) +
  labs(x = "", y = "Share of GDP") +
  theme(legend.position = "bottom",
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  ggsave(file.path(loc_result, "inc_gdp_shr.png"),
         width = scale_graph*5, height = scale_graph*5/2)

```

```{r}

redis %>% 
  select(Country, Year, C2, health_spen, Saving, C1, wL) %>% 
  melt(id.vars = c("Country", "Year", "wL")) %>% 
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable)) +
  geom_line(aes(y = wL), linetype = "dashed") +
  facet_wrap(Country ~ .) +
  theme_classic()

redis %>% 
  mutate(C2 = C2/Y,
         health_spen = health_spen/Y,
         Saving = Saving/Y,
         C1 = C1/Y) %>% 
  select(Country, Year, C2, health_spen, Saving, C1, theta) %>% 
  melt(id.vars = c("Country", "Year", "theta")) %>% 
  subset(Year <= 2050) %>% 
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable),
           alpha = 1) +
  geom_line(aes(y = theta), linetype = "dashed") +
  facet_wrap(Country ~ .) +
  scale_fill_manual(name = "",
                    breaks = c("C2", "health_spen", "Saving", "C1"),
                    labels = c("Old HH. cons.", "Health spending",
                               "Savings", "Young HH. cons."),
                    values = brewer.pal(11, "Set3")[c(4,6,8,10)],
                    na.value = "black") +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_classic() +
  labs(x = "", y = "Share of GDP") +
  theme(legend.position = "bottom") +
  ggsave("stacked_test4.png", width = 1920/1080*5, height = 5)


```

```{r Raw vs Net labor share, echo = FALSE}

redis %>% 
  mutate(
    net_ls = (wL_net + unemp_ben)/(Y - health_spen)) %>% 
  select(Country, Year, theta, net_ls) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = variable, color = Country)) +
  geom_line() +
  facet_wrap(Country ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  scale_linetype_manual(name = "Labor share", breaks = c("theta", "net_ls"),
                          labels = c("Raw", "Net"), values = c("solid", "dashed"),
                        guide = FALSE) +
  scale_color_manual(name = "", values = brewer.pal(8,"Set1"),
                     guide = FALSE) +
  theme_classic(base_size = 14) +
  labs(x = "", y = "") +
  theme(legend.position = "none") +
  ggsave(file.path(loc_result, "raw_vs_net_labshr.png"), width = scale_graph*5, height = scale_graph*5/2)
  

```

```{r Raw vs Net labor share - dev, echo = FALSE}

redis %>% 
  group_by(Country) %>% 
  mutate(
    net_ls = (wL_net + unemp_ben)/(Y),
    theta = theta/theta[Year == 1970] -1,
    net_ls = net_ls/net_ls[Year == 1970] -1,
    ) %>% 
  select(Country, Year, theta, net_ls) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = variable, color = Country)) +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  facet_wrap(Country ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  scale_linetype_manual(name = "Labor share", breaks = c("theta", "net_ls"),
                          labels = c("Raw", "Net"), values = c("solid", "dashed")) +
  scale_color_manual(name = "", values = brewer.pal(8,"Set1"),
                     guide = FALSE) +
  theme_classic(base_size = 14) +
  labs(x = "", y = "") +
  theme(legend.position = "bottom")

```

```{r Factor ratio vs Income ratio, echo = FALSE}

redis %>% 
  select(Country, Year, inc_y, inc_o, wL, rK, health_spen, eta) %>% 
  mutate(inc_ratio = inc_y/inc_o,
         inc_ratio_with_h = inc_y/(inc_o + health_spen),
         lab_to_cap_ratio = wL/rK) %>% 
  select(Country, Year, lab_to_cap_ratio, inc_ratio, inc_ratio_with_h) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = variable, color = Country)) +
  geom_line() +
  facet_wrap(Country ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  scale_linetype_manual(name = "", breaks = c("lab_to_cap_ratio", "inc_ratio",
                                              "inc_ratio_with_h"),
                          labels = c("Labor-to-capital income ratio",
                                     "Young-to-old income ratio",
                                     "Young-to-old income ratio (with health spending)"),
                        values = c("solid", "dashed", "dotted")) +
  scale_color_manual(name = "", values = brewer.pal(8,"Set1"), guide = FALSE) +
  theme_classic(base_size = 14) +
  labs(x = "", y = "") +
  theme(legend.position = "none") +
  ggsave(file.path(loc_result, "raw_vs_net_inc_ratio.png"),
         width = scale_graph*5, height = scale_graph*5/2)

```

```{r Factor ratio vs Income ratio - dev, echo = FALSE}

redis %>% 
  select(Country, Year, inc_y, inc_o, wL, rK, health_spen, eta) %>% 
  group_by(Country) %>% 
  mutate(inc_ratio = inc_y/inc_o,
         #inc_ratio_with_h = inc_y/(inc_o + health_spen),
         lab_to_cap_ratio = wL/rK,
         # Deviations
         inc_ratio = inc_ratio/inc_ratio[Year == 1970] -1,
         #inc_ratio_with_h = inc_ratio_with_h/inc_ratio_with_h[Year == 1970] -1,
         lab_to_cap_ratio = lab_to_cap_ratio/lab_to_cap_ratio[Year == 1970] -1,) %>% 
  select(Country, Year, lab_to_cap_ratio, inc_ratio) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = variable, color = Country)) +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  facet_wrap(Country ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  scale_linetype_manual(name = "", breaks = c("lab_to_cap_ratio",
                                              "inc_ratio"),
                          labels = c("Labor-to-capital income ratio",
                                     "Young-to-old income ratio"),
                        values = c("solid", "dashed", "dotted")) +
  scale_color_manual(name = "", values = brewer.pal(8,"Set1"), guide = FALSE) +
  theme_classic(base_size = 14) +
  labs(x = "", y = "") +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
    ggsave(file.path(loc_result, "raw_vs_net_inc_ratio_dev.png"),
         width = scale_graph*5, height = scale_graph*5/2)

```

### Counterfactual and Decomposition


#### Simulation

```{r Aging effect decomposition - 1970 break_year, include = FALSE}

# Re initialize result data frame
result = result[0,]

# Define break_year
break_year = 1970

## Aging effect decomposition : Survival rate versus Population growth
  for(sr in c("TSR", "FSR")){
    for(pg in c("TPG", "FPG")){
      
      spe = paste0("counter_", break_year, "_", pg, ".", sr, ".", "TDE", ".", "TIE")
      
      # Prepare data
      data = data_base %>% 
      # No biased technical change
      mutate(AK = 1, AL = 1) %>% 
      # Add parameters
      merge(param) %>% 
      # Demography
      demo_changer(break_year = break_year, p1_equals_p_fix = FALSE, PG = pg, SR = sr) %>% 
      # Define specification model
      mutate(Specification = spe) %>%
      # Reorder variables
      select(Specification, everything())
      
      
      # Simulate the model for each country
      for(country in country_set){
          
          result = data %>%
            subset(Country == country) %>% 
            model(time = 3) %>% 
            rbind(result, .)
          
      }
    }
  }

## Aging effect decomposition : Direct effect versus Indirect effect
  for(de in c("TDE", "FDE")){
    for(ie in c("TIE", "FIE")){
      
      spe = paste0("counter_", break_year, "_", "TPG", ".", "TSR", ".", de, ".", ie)
      
      # Prepare data
      data = data_base %>% 
      # No biased technical change
      mutate(AK = 1, AL = 1) %>% 
      # Add parameters
      merge(param) %>% 
      # Demography
      demo_changer(break_year = break_year, p1_equals_p_fix = FALSE, DE = de, IE = ie) %>% 
      # Define specification model
      mutate(Specification = spe) %>%
      # Reorder variables
      select(Specification, everything())
      
      
      # Simulate the model for each country
      for(country in country_set){
          
          result = data %>%
            subset(Country == country) %>% 
            model(time = 3) %>% 
            rbind(result, .)
          
      }
    }
  }

# Remove duplicates
final = distinct(result)

# Model specification details
final = final %>% mutate(PG = ifelse(grepl("TPG", Specification), "TPG", "FPG"),
                 SR = ifelse(grepl("TSR", Specification), "TSR", "FSR"),
                 DE = ifelse(grepl("TDE", Specification), "TDE", "FDE"),
                 IE = ifelse(grepl("TIE", Specification), "TIE", "FIE"),
                 break_year = as.numeric(gsub("[^0-9]", "\\1", Specification))) %>% 
  select(Specification, break_year, PG, SR, DE, IE, everything())

# Write final_counter
write.csv(final, file.path(loc_sim, paste0("final_", "counter", ".csv")), row.names = FALSE)

```

##### Counterfactual

```{r Graph CModel - Prepare Data, include = FALSE}

# Reshape dataframe
decomp = final %>% 
  select(Country, Specification, Year, theta) %>% 
  rbind(., 
        df %>% 
          mutate(Specification = paste0("data_", break_year)) %>%
          select(Specification, Country, Year, theta))  %>% 
  mutate(from = ifelse(!grepl("data", Specification), "sim", "data")) %>%
  filter(complete.cases(.)) %>% 
  mutate(PG = ifelse(from == "data", NA, ifelse(grepl("TPG", Specification), "TPG", "FPG")),
         SR = ifelse(from == "data", NA, ifelse(grepl("TSR", Specification), "TSR", "FSR")),
         DE = ifelse(from == "data", NA, ifelse(grepl("TDE", Specification), "TDE", "FDE")),
         IE = ifelse(from == "data", NA, ifelse(grepl("TIE", Specification), "TIE", "FIE")),
         break_year = as.numeric(gsub("[^0-9]", "\\1", Specification))) %>% 
  select(Specification, break_year, PG, SR, DE, IE, everything())

```

```{r Graph CModel - Demography, echo = FALSE}

final %>% 
  select(Country, Specification, Year, n, p, eta) %>%
  filter(complete.cases(.)) %>% 
  mutate(PG = ifelse(grepl("TPG", Specification), "TPG", "FPG"),
         SR = ifelse(grepl("TSR", Specification), "TSR", "FSR"),
         DE = ifelse(grepl("TDE", Specification), "TDE", "FDE"),
         IE = ifelse(grepl("TIE", Specification), "TIE", "FIE"),
         break_year = as.numeric(gsub("[^0-9]", "\\1", Specification))) %>% 
  select(Specification, break_year, PG, SR, DE, IE, everything()) %>% 
  subset(DE %in% c("TDE", NA) & IE %in% c("TIE", NA)) %>%
  subset(break_year == break_year) %>% 
  mutate(PGSR = as.character(interaction(PG, SR)),
         PGSR = as.factor(PGSR)) %>% 
  select(PGSR, Country, Year, everything(), - PG, - SR, - DE, - IE, - break_year, -Specification) %>% 
  melt(id.vars = c("Country", "PGSR", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, color = PGSR)) +
  geom_line(linetype = "solid") +
  facet_grid(Country ~ variable, scale = "free") +
  scale_color_manual(name = "",
                     breaks = c("TPG.TSR", "TPG.FSR", "FPG.TSR", "FPG.FSR"),
                     labels = c("Benchmark", expression(p[1970]),
                                expression(n[1970]), expression(p[1970]*", "*n[1970])),
                     values = c(brewer.pal(8, "Set1")[c(1:4)]) %>% 
                       setNames(c("TPG.TSR", "TPG.FSR", "FPG.TSR", "FPG.FSR"))) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "")

```


```{r Graph CModel - PGSR Counterfactual - Global Picture, echo = FALSE}

decomp %>% 
  subset(DE %in% c("TDE", NA) & IE %in% c("TIE", NA)) %>%
  subset(break_year == break_year) %>% 
  mutate(PGSR = as.character(interaction(PG, SR)),
         PGSR = ifelse(from == "data", "data", PGSR),
         PGSR = as.factor(PGSR)) %>% 
  
  ggplot(aes(x = Year, y = theta, color = PGSR, linetype = PGSR)) +
  facet_wrap(Country ~ .) +
  geom_line() +
  # geom_label_repel(aes(label = round(theta, 3)),
  #                  data = subset(decomp, Year == 2080 & DE == "TDE" & IE == "TIE" &
  #                                  break_year == 1970), 
  #                  nudge_x = 0, na.rm = TRUE,
  #                  segment.color = "transparent") +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  scale_linetype_manual(name = "",
                        breaks = c("data","TPG.TSR", "TPG.FSR",
                                "FPG.TSR", "FPG.FSR"),
                        labels = c("Data", "Benchmark", expression(p[1970]),
                                expression(n[1970]), expression(p[1970]*", "*n[1970])),
                        values = c(rep("dashed", 4), "solid") %>% 
                       setNames(c("TPG.TSR", "TPG.FSR", "FPG.TSR", "FPG.FSR", "data"))) +
  scale_color_manual(name = "",
                     breaks = c("data","TPG.TSR", "TPG.FSR",
                                "FPG.TSR", "FPG.FSR"),
                     labels = c("Data", "Benchmark", expression(p[1970]),
                                expression(n[1970]), expression(p[1970]*", "*n[1970])),
                     values = c(brewer.pal(8, "Set1")[c(1:4)],"black") %>% 
                       setNames(c("TPG.TSR", "TPG.FSR", "FPG.TSR", "FPG.FSR", "data"))) +
  theme_classic(base_size = 14) +
  theme(legend.position = c(0.99, 0.99),
        legend.justification = c("right", "top"),
        legend.direction = "vertical",
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") +
  ggsave(file.path(loc_result, "counter_PGSR.png"),
         width = scale_graph*5, height = scale_graph*5/2)


```

```{r Graph CModel - PGSR Counterfactual - Global Picture, echo = FALSE}

decomp %>% 
  subset(PG %in% c("TPG", NA) & SR %in% c("TSR", NA)) %>%
  subset(break_year == break_year) %>% 
  mutate(DEIE = as.character(interaction(DE, IE)),
         DEIE = ifelse(from == "data", "data", DEIE),
         DEIE = as.factor(DEIE)) %>% 
  
  ggplot(aes(x = Year, y = theta, color = DEIE, linetype = DEIE)) +
  facet_wrap(Country ~ .) +
  geom_line() +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  scale_linetype_manual(name = "",
                     breaks = c("data","TDE.TIE", "FDE.TIE", "TDE.FIE", "FDE.FIE"),
                     labels = c("Data", "Benchmark", 
                                expression(p[1970]*", "*n[1970]),
                                expression(eta[1970]),
                                expression(p[1970]*", "*n[1970]*", "*eta[1970])),
                        values = c(rep("dashed", 4), "solid") %>% 
                       setNames(c("TDE.TIE", "TDE.FIE", "FDE.TIE", "FDE.FIE", "data"))) +
  scale_color_manual(name = "",
                     breaks = c("data","TDE.TIE", "FDE.TIE", "TDE.FIE", "FDE.FIE"),
                     labels = c("Data", "Benchmark", 
                                expression(p[1970]*", "*n[1970]),
                                expression(eta[1970]),
                                expression(p[1970]*", "*n[1970]*", "*eta[1970])),
                     values = c(brewer.pal(8, "Set1")[c(1,5,8,4)],"black") %>% 
                       setNames(c("TDE.TIE", "TDE.FIE", "FDE.TIE", "FDE.FIE", "data"))) +
  theme_classic(base_size = 14) +
  theme(legend.position = c(0.99, 0.99),
        legend.justification = c("right", "top"),
        legend.direction = "vertical",
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") +
  ggsave(file.path(loc_result, "counter_DEIE.png"),
         width = scale_graph*5, height = scale_graph*5/2)


```

#### Decomposition


```{r Computation CModel - Decomposition, echo = FALSE}

decomp2 = final %>% 
  select(Country, Specification, Year, theta) %>% 
  mutate(PG = ifelse(Specification == "data", NA,
                     ifelse(grepl("TPG", Specification), "TPG", "FPG")),
         SR = ifelse(Specification == "data", NA, 
                     ifelse(grepl("TSR", Specification), "TSR", "FSR")),
         DE = ifelse(Specification == "data", NA, 
                     ifelse(grepl("TDE", Specification), "TDE", "FDE")),
         IE = ifelse(Specification == "data", NA, 
                     ifelse(grepl("TIE", Specification), "TIE", "FIE")),
         break_year = as.numeric(gsub("[^0-9]", "\\1", Specification)),
         Spe_PGSR = interaction(PG, SR),
         Spe_DEIE = interaction(DE, IE)) %>% 
  select(Country, Year, break_year, Spe_PGSR, Spe_DEIE, theta) %>% 
  dcast(Country + Year + break_year ~ Spe_PGSR + Spe_DEIE, value.var = "theta") %>% 
  setNames(c("Country", "Year", "break_year",
             "FPG.FSR", "TPG.FSR", "FPG.TSR", 
             "FDE.FIE", "TDE.FIE", "FDE.TIE",
             "benchmark")) %>% 
  mutate(FPG.TSR = (benchmark - FPG.TSR)*100,
         TPG.FSR = (benchmark - TPG.FSR)*100,
         FPG.FSR = (benchmark - FPG.FSR)*100,
         FPG.FSR = FPG.FSR - FPG.TSR - TPG.FSR,
         position_PGSR = (FPG.TSR + TPG.FSR + FPG.FSR),
         FPG.TSR.share = abs(FPG.TSR)/(abs(FPG.TSR) + abs(TPG.FSR) + abs(FPG.FSR)),
         TPG.FSR.share = abs(TPG.FSR)/(abs(FPG.TSR) + abs(TPG.FSR) + abs(FPG.FSR)),
         FPG.FSR.share = abs(FPG.FSR)/(abs(FPG.TSR) + abs(TPG.FSR) + abs(FPG.FSR)),
         FDE.TIE = (benchmark - FDE.TIE)*100,
         TDE.FIE = (benchmark - TDE.FIE)*100,
         FDE.FIE = (benchmark - FDE.FIE)*100,
         FDE.FIE = FDE.FIE - FDE.TIE - TDE.FIE,
         position_DEIE = (FDE.TIE + TDE.FIE + FDE.FIE),
         FDE.TIE.share = abs(FDE.TIE)/(abs(FDE.TIE) + abs(TDE.FIE) + abs(FDE.FIE)),
         TDE.FIE.share = abs(TDE.FIE)/(abs(FDE.TIE) + abs(TDE.FIE) + abs(FDE.FIE)),
         FDE.FIE.share = abs(FDE.FIE)/(abs(FDE.TIE) + abs(TDE.FIE) + abs(FDE.FIE))) %>% 
  melt(id.vars = c("Country", "Year", "break_year", "position_PGSR", "position_DEIE"))

```


```{r Graph CModel - PGSR Decomposition, echo = FALSE}

decomp2 %>% 
  subset(break_year == break_year) %>% 
  subset(variable %in% c("FPG.TSR", "TPG.FSR", "FPG.FSR")) %>% 
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable), color = "black", alpha = .5) +
  geom_hline(yintercept = 0) +
  geom_line(aes(y = position_PGSR), color = brewer.pal(8, "Set1")[1]) +
  facet_wrap(Country ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  # scale_y_continuous(limits = c(-4,6)) +
  scale_fill_manual(name = "",
                    breaks = c("TPG.FSR", "FPG.TSR", "FPG.FSR"),
                    labels = c("Survival rate effect", "Population growth effect",
                               "Interaction effect"),
                    values = brewer.pal(8, "Set1")[c(2,3,4)] %>% 
                      setNames(c("TPG.FSR","FPG.TSR", "FPG.FSR"))) +
  theme_classic(base_size = 14) +
  theme(legend.direction = "horizontal", legend.box = "horizontal",
        legend.position = "bottom",
        axis.title.x = element_blank()) +
  labs(x = "", y = "Difference with counterfactual (in pp.)") +
  ggsave(file.path(loc_result, "decomp_PGSR.png"),
         width = scale_graph*5, height = scale_graph*5/2)
  
```


```{r Graph CModel - DEIE Decomposition, echo = FALSE}

decomp2 %>% 
  subset(variable %in% c("FDE.TIE", "TDE.FIE", "FDE.FIE")) %>% 
  subset(break_year == break_year) %>% 
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable), color = "black", alpha = .5) +
  geom_hline(yintercept = 0) +
  geom_line(aes(y = position_DEIE), color = brewer.pal(8, "Set1")[1]) +
  facet_wrap(Country ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  # scale_y_continuous(limits = c(-4,6)) +
  scale_fill_manual(name = "",
                    breaks = c("FDE.TIE", "TDE.FIE", "FDE.FIE"),
                    labels = c("Direct cohort effect", "Indirect cohort effect",
                               "Interaction effect"),
                    values = brewer.pal(8, "Set1")[c(8,5,4)] %>% 
                      setNames(c("FDE.TIE", "TDE.FIE", "FDE.FIE"))) +
  theme_classic(base_size = 14) +
  theme(legend.direction = "horizontal", legend.box = "horizontal",
        legend.position = "bottom",
        axis.title.x = element_blank()) +
  labs(x = "", y = "Difference with counterfactual (in pp.)") +
  ggsave(file.path(loc_result, "decomp_DEIE.png"),
         width = scale_graph*5, height = scale_graph*5/2)
  
```

```{r Computation CModel - Explanation Power, echo = FALSE}

# Compute the share of each effect/channel for two sub_periods 1980-2010 & 2020-2050
decomp_mean.period = decomp2 %>% 
  select(-contains("position")) %>% 
  dcast(Country + Year + break_year ~ variable) %>% 
  mutate(Country_break = interaction(break_year, Country, sep = " - "),
         Period = ifelse(Year %in% c(1970:2010), "P1",
                         ifelse(Year %in% c(2020:2050), "P2", "P3"))) %>% 
  subset(Period != "P3") %>% 
  group_by(Country_break, Period) %>% 
  select(Country_break, Period, TPG.FSR.share, FPG.TSR.share, FPG.FSR.share,
         FDE.TIE.share, TDE.FIE.share, FDE.FIE.share) %>% 
  summarise_at(vars(TPG.FSR.share:FDE.FIE.share), mean, na.rm = TRUE)

# ## Assign values for text
# # France 1980-2010
# FR8010_FPG = decomp_mean.period %>% subset(Country == "France" & Period == "P1") %>% 
#   pull("FPG.TSR.share") %>% round(2) *100
# FR8010_FSR = decomp_mean.period %>% subset(Country == "France" & Period == "P1") %>%
#   pull("TPG.FSR.share") %>% round(2) *100
# FR8010_FDE = decomp_mean.period %>% subset(Country == "France" & Period == "P1") %>%
#   pull("FDE.TIE.share") %>% round(2) *100
# FR8010_FIE = decomp_mean.period %>% subset(Country == "France" & Period == "P1") %>%
#   pull("TDE.FIE.share") %>% round(2) *100
# # France 2020-2050
# FR2050_FPG = decomp_mean.period %>% subset(Country == "France" & Period == "P2") %>% 
#   pull("FPG.TSR.share") %>% round(2) *100
# FR2050_FSR = decomp_mean.period %>% subset(Country == "France" & Period == "P2") %>%
#   pull("TPG.FSR.share") %>% round(2) *100
# FR2050_FDE = decomp_mean.period %>% subset(Country == "France" & Period == "P2") %>%
#   pull("FDE.TIE.share") %>% round(2) *100
# FR2050_FIE = decomp_mean.period %>% subset(Country == "France" & Period == "P2") %>%
#   pull("TDE.FIE.share") %>% round(2) *100

# Visualization
decomp_mean.period

```

<!-- In France, between 1980 and 2010, population growth variations account, on average, for `r FR8010_FPG` % of the labor share variations with respect to the counterfactual. Thus, the survival rate variations account for `r FR8010_FSR` %. -->
<!-- The main propagation channel over this period is the direct one (`r FR8010_FDE` %) compared to the indirect one (`r FR8010_FIE` %). -->

<!-- Between 2020 and 2050, the impact of population growth variations on the labor share with respect to the counterfactual should decrease a bit (`r FR2050_FPG` %). Therefore, Survival rate variations should have a larger impact (`r FR2050_FSR` %) due to the fact that population growth should remain relatively constant at the end of the century. -->
<!-- However, the indirect effect should become the main channel (`r FR2050_FDE` %) compared to the direct one (`r FR2050_FIE` %). -->

```{r Graph CModel - Explanation Power, echo = FALSE}

decomp_mean.period %>% 
  melt(id.vars = c("Country_break", "Period")) %>% 
  mutate(value = value*100) %>% 
  subset(Country_break %in% c("1970 - France", "1970 - United States")) %>% 
  mutate(Country = ifelse(Country_break == "1970 - France", "France", "United States"),
         effect = factor(ifelse(variable %>% grepl(pattern = "PG", .),
                                "first", "second")),
         Period = ifelse(Period == "P1", "1980-2010", "2020-2050")) %>% 
  
  ggplot(aes(x = effect, y = value, fill = variable)) +
  geom_bar(stat = "identity", position = position_dodge(),
           color = "black", alpha = .5) +
  facet_grid(Period ~ Country) +
  scale_x_discrete(breaks = c("first", "second"),
                   labels = c("Determinants", "Channels")) +
  scale_fill_manual(name = "",
                    breaks = c("TPG.FSR.share", "FPG.TSR.share",
                               "FDE.TIE.share", "TDE.FIE.share", "FDE.FIE.share"),
                    labels = c("Survival rate", "Population growth",
                               "Direct cohort", "Indirect cohort", "Interaction"),
                    values = brewer.pal(8, "Set1")[c(2,3,4,8,5,4)] %>% 
                      setNames(c("TPG.FSR.share", "FPG.TSR.share", "FPG.FSR.share",
                                 "FDE.TIE.share", "TDE.FIE.share", "FDE.FIE.share"))) +
  theme_classic(base_size = 14) +
  theme(legend.position = "bottom",
        axis.title.x = element_blank()) +
  labs(x = "", y = "Percent") +
  ggsave(file.path(loc_result, "decomp.png"), width = scale_graph*5, height = scale_graph*5/2)

```


### Retirement age

#### Specification 1 

```{r Retirement age - 2020 break_year - Specification 1, include = FALSE}

# Re initialize result data frame
result = result[0,]

# Define break_year
break_year = 2020
# Define first years after the reform
first_years = seq(break_year+10, (break_year+40), by = 10)

# Size of the shock (in %)
shock = -1/10

# Specification
ret_spe = 1
spe = paste0("ret_age_", break_year, "_spe", ret_spe)

# Prepare data
data = data_base %>% 
  # No biased technical change
  mutate(AK = 1, AL = 1) %>% 
  # Add parameters
  merge(param) %>% 
  # Demography
  demo_changer(break_year = break_year, p1_equals_p_fix = FALSE) %>% 
  # Define specification model
  mutate(Specification = spe) %>%
  # Reorder variables
  select(Specification, everything()) %>% 
  
  ## Modification of demographic data
  
  group_by(Country, Sequence) %>% 
  mutate(# Scale for the affected periods
         from_No.to.Ny = 1-shock,
         
         # New p, p1 and n
         p.new = ifelse(Year > break_year, p*(1+shock), p),
         p1.new = ifelse(Year > break_year, p1*(1+shock), p1),
         n.new = ifelse(Year %in% first_years, n*from_No.to.Ny, n),
         
         # Compute Ny and No for the affected periods
         Ny.new = ifelse(Year %in% first_years, Ny*from_No.to.Ny, NA),
         No.new = ifelse(Year %in% first_years, No*p.new/p, NA),
         
         # Compute Ny and No for last sequence/periods
         Ny.new = ifelse(Year > max(first_years), lag(Ny.new,1)*n, Ny.new),
         No.new = ifelse(Year > max(first_years), lag(Ny.new,1)*p.new, No.new),
         
         # Recompute eta
         eta.new = n.new/p.new*(1+alpha*p1.new)/omega,
         
         # Replace values
         Ny = ifelse(is.na(Ny.new), Ny, Ny.new),
         No = ifelse(is.na(No.new), No, No.new),
         n = n.new,
         p = p.new,
         p1 = p1.new,
         eta = eta.new,
         
         ) %>% 
  select(Specification, Country, Year, Sequence, Period, Ny, No, n, p, p1, 
         eta, everything(), -contains("new"), -from_No.to.Ny, ) %>%
  ungroup()

# Simulate the model for each country
for(country in country_set){
  result = data %>%
  subset(Country == country) %>% 
  model(time = 3) %>% 
  rbind(result, .)
}


# Remove duplicates
ret_age = distinct(result)

# Write ret_age
#write.csv(ret_age, file.path(loc_sim, "ret_age.csv"), row.names = FALSE)

```

```{r Retirement age - 2020 break_year - Specification 1 - Plot}

fillgap %>%
  rbind(., baseline %>% subset(Country == "United States")) %>% 
  mutate(Specification = "base2") %>% 
  select(Specification, Country, Year, theta) %>% 
  melt(id.vars = c("Specification" ,"Country", "Year")) %>% 
  rbind(.,
        df %>% 
          mutate(Specification = "data") %>%
          select(Specification, Country, Year, theta) %>%
          setNames(c("Specification","Country", "Year", "data")) %>% 
          melt(id.vars = c("Specification", "Country", "Year"))
        ) %>%
  filter(complete.cases(.)) %>% 
  subset(Year %in% c(1970:2080)) %>%
  # Trick to put data line under others
  mutate(variable = as.character(variable),
         variable = ifelse(variable == "data", "a.data", variable),
         variable = as.factor(variable)) %>% 
  
  
  rbind(., ret_age %>% 
          select(Specification, Country, Year, theta) %>% 
          subset(Specification == spe) %>% 
          melt(id.vars = c("Specification" ,"Country", "Year"))) %>% 
  
  ggplot(aes(x = Year, y = value, color = interaction(variable, Country),
             linetype = Specification)) +
  geom_line() +
  facet_wrap(Country ~ ., scales = "fixed") +
  scale_color_manual(breaks = c("a.data.France", "a.data.United States",
                                "theta.France", "theta.United States"),
                    values = c("black", "black",brewer.pal(8, "Set1")[c(1,2)]) %>% 
                      setNames(c("a.data.France", "a.data.United States",
                                "theta.France", "theta.United States"))) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  scale_linetype_manual(breaks = c("data", "base2", spe),
                        values = c("solid", "solid", "dashed")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") 
#+
  #ggsave(file.path(loc_result, "baseline7080_facet2.png"),
  #      width = scale_graph*5, height = scale_graph*5/2)



```

#### Specification 2

```{r Retirement age - 2020 break_year - Specification 2, include = FALSE}

# Re initialize result data frame
result = result[0,]

# Define break_year
break_year = 2020
# Define first years after the reform
first_years = seq(break_year+10, (break_year+40), by = 10)

# Specification
ret_spe = 2
spe = paste0("ret_age_", break_year, "_spe", ret_spe)

# Prepare data
data = data_base %>% 
  # No biased technical change
  mutate(AK = 1, AL = 1) %>% 
  # Add parameters
  merge(param) %>% 
  # Demography
  demo_changer(break_year = break_year, p1_equals_p_fix = FALSE) %>% 
  # Define specification model
  mutate(Specification = spe) %>%
  # Reorder variables
  select(Specification, everything()) %>% 
  # Merge witj break year
  merge(., data_base %>% 
          subset(Year == break_year) %>%
          select(Country, p_fix = p), by = "Country") %>% 
  
  ## Modification of demographic data
  
  group_by(Country, Sequence) %>% 
  mutate(# Scale for the affected periods
         shock = (p_fix-p)/p,
         from_No.to.Ny = 1-shock,
         
         # New p, p1 and n
         p.new = ifelse(Year > break_year, p_fix, p),
         p1.new = ifelse(Year > break_year, p_fix, p1),
         n.new = ifelse(Year %in% first_years, n*from_No.to.Ny, n),
         
         # Compute Ny and No for the affected periods
         Ny.new = ifelse(Year %in% first_years, Ny*from_No.to.Ny, NA),
         No.new = ifelse(Year %in% first_years, No*p.new/p, NA),
         
         # Compute Ny and No for last sequence/periods
         Ny.new = ifelse(Year > max(first_years), lag(Ny.new,1)*n, Ny.new),
         No.new = ifelse(Year > max(first_years), lag(Ny.new,1)*p.new, No.new),
         
         # Recompute eta
         eta.new = n.new/p.new*(1+alpha*p1.new)/omega,
         
         # Replace values
         Ny = ifelse(is.na(Ny.new), Ny, Ny.new),
         No = ifelse(is.na(No.new), No, No.new),
         n = n.new,
         p = p.new,
         p1 = p1.new,
         eta = eta.new,
         
         ) %>% 
  select(Specification, Country, Year, Sequence, Period, Ny, No, n, p, p1, 
         eta, everything(), -contains("new"), -from_No.to.Ny, -shock, -p_fix ) %>%
  ungroup()

# Simulate the model for each country
for(country in country_set){
  result = data %>%
  subset(Country == country) %>% 
  model(time = 3) %>% 
  rbind(result, .)
}


# Remove duplicates
ret_age = rbind(ret_age, distinct(result))

# Write ret_age
#write.csv(ret_age, file.path(loc_sim, "ret_age.csv"), row.names = FALSE)

```

```{r Retirement age - 2020 break_year - Specification 2 - Plot}

fillgap %>%
  rbind(., baseline %>% subset(Country == "United States")) %>% 
  mutate(Specification = "base2") %>% 
  select(Specification, Country, Year, theta) %>% 
  melt(id.vars = c("Specification" ,"Country", "Year")) %>% 
  rbind(.,
        df %>% 
          mutate(Specification = "data") %>%
          select(Specification, Country, Year, theta) %>%
          setNames(c("Specification","Country", "Year", "data")) %>% 
          melt(id.vars = c("Specification", "Country", "Year"))
        ) %>%
  filter(complete.cases(.)) %>% 
  subset(Year %in% c(1970:2080)) %>%
  # Trick to put data line under others
  mutate(variable = as.character(variable),
         variable = ifelse(variable == "data", "a.data", variable),
         variable = as.factor(variable)) %>% 
  
  
  rbind(., ret_age %>% 
          select(Specification, Country, Year, theta) %>% 
          subset(Specification == spe) %>% 
          melt(id.vars = c("Specification" ,"Country", "Year"))) %>% 
  
  ggplot(aes(x = Year, y = value, color = interaction(variable, Country),
             linetype = Specification)) +
  geom_line() +
  facet_wrap(Country ~ ., scales = "fixed") +
  scale_color_manual(breaks = c("a.data.France", "a.data.United States",
                                "theta.France", "theta.United States"),
                    values = c("black", "black",brewer.pal(8, "Set1")[c(1,2)]) %>% 
                      setNames(c("a.data.France", "a.data.United States",
                                "theta.France", "theta.United States"))) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  scale_linetype_manual(breaks = c("data", "base2", spe),
                        values = c("solid", "solid", "dashed")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") 
#+
  #ggsave(file.path(loc_result, "baseline7080_facet2.png"),
  #      width = scale_graph*5, height = scale_graph*5/2)



```

#### Specification 3

```{r Retirement age - 2020 break_year - Specification 3, include = FALSE}

# Re initialize result data frame
result = result[0,]

# Define break_year
break_year = 2020
# Define first years after the reform
first_years = seq(break_year+10, (break_year+40), by = 10)

# Fraction
frac = 0.5

# Specification
ret_spe = 3
spe = paste0("ret_age_", break_year, "_spe", ret_spe)

# Prepare data
data  = data_base %>% 
  # No biased technical change
  mutate(AK = 1, AL = 1) %>% 
  # Add parameters
  merge(param) %>% 
  # Demography
  demo_changer(break_year = break_year, p1_equals_p_fix = FALSE) %>% 
  # Define specification model
  mutate(Specification = spe) %>%
  # Reorder variables
  select(Specification, everything()) %>% 
  # Merge witj break year
  merge(., data_base %>% 
          subset(Year == break_year) %>%
          select(Country, p_fix = p), by = "Country") %>% 
  
  ## Modification of demographic data
  
  group_by(Country, Sequence) %>% 
  mutate(
         p1_to_p_dist = p1 - p,
         # New p and p1
         p.new = ifelse(Year > break_year, frac*(p-p_fix) + p_fix, p),
         p1.new = ifelse(Year > break_year & Period < 3, dplyr::lead(p.new,1),
                         ifelse(Period == 3, p.new + p1_to_p_dist*frac, p1)),
         # Scale for the affected periods
         shock = (p.new - p)/p,
         from_No.to.Ny = 1-shock,
         # New n
         n.new = ifelse(Year %in% first_years, n*from_No.to.Ny, n),
         
         # Compute Ny and No for the affected periods
         Ny.new = ifelse(Year %in% first_years, Ny*from_No.to.Ny, NA),
         No.new = ifelse(Year %in% first_years, No*p.new/p, NA),
         
         # Compute Ny and No for last sequence/periods
         Ny.new = ifelse(Year > max(first_years), lag(Ny.new,1)*n, Ny.new),
         No.new = ifelse(Year > max(first_years), lag(Ny.new,1)*p.new, No.new),
         
         # Recompute eta
         eta.new = n.new/p.new*(1+alpha*p1.new)/omega,
         
         # Replace values
         Ny = ifelse(is.na(Ny.new), Ny, Ny.new),
         No = ifelse(is.na(No.new), No, No.new),
         n = n.new,
         p = p.new,
         p1 = p1.new,
         eta = eta.new,
         
         ) %>% 
  select(Specification, Country, Year, Sequence, Period, Ny, No, n, p, p1, 
         eta, everything(), -contains("new"), -from_No.to.Ny,
         -shock, -p_fix, -p1_to_p_dist ) %>%
  ungroup()

# Simulate the model for each country
for(country in country_set){
  result = data %>%
  subset(Country == country) %>% 
  model(time = 3) %>% 
  rbind(result, .)
}


# Remove duplicates
ret_age = rbind(ret_age, distinct(result))

# Write ret_age
#write.csv(ret_age, file.path(loc_sim, "ret_age.csv"), row.names = FALSE)

```

```{r Retirement age - 2020 break_year - Specification 3 - Plot}

fillgap %>%
  rbind(., baseline %>% subset(Country == "United States")) %>% 
  mutate(Specification = "base2") %>% 
  select(Specification, Country, Year, theta) %>% 
  melt(id.vars = c("Specification" ,"Country", "Year")) %>% 
  rbind(.,
        df %>% 
          mutate(Specification = "data") %>%
          select(Specification, Country, Year, theta) %>%
          setNames(c("Specification","Country", "Year", "data")) %>% 
          melt(id.vars = c("Specification", "Country", "Year"))
        ) %>%
  filter(complete.cases(.)) %>% 
  subset(Year %in% c(1970:2080)) %>%
  # Trick to put data line under others
  mutate(variable = as.character(variable),
         variable = ifelse(variable == "data", "a.data", variable),
         variable = as.factor(variable)) %>% 
  
  
  rbind(., ret_age %>% 
          select(Specification, Country, Year, theta) %>% 
          subset(Specification == spe) %>% 
          melt(id.vars = c("Specification" ,"Country", "Year"))) %>% 
  
  ggplot(aes(x = Year, y = value, color = interaction(variable, Country),
             linetype = Specification)) +
  geom_line() +
  facet_wrap(Country ~ ., scales = "fixed") +
  scale_color_manual(breaks = c("a.data.France", "a.data.United States",
                                "theta.France", "theta.United States"),
                    values = c("black", "black",brewer.pal(8, "Set1")[c(1,2)]) %>% 
                      setNames(c("a.data.France", "a.data.United States",
                                "theta.France", "theta.United States"))) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  scale_linetype_manual(breaks = c("data", "base2", spe),
                        values = c("solid", "solid", "dashed")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") 
#+
  #ggsave(file.path(loc_result, "baseline7080_facet2.png"),
  #      width = scale_graph*5, height = scale_graph*5/2)



```

#### Summary RetAge


```{r Graph - All ret_age}

fillgap %>%
  rbind(., baseline %>% subset(Country == "United States")) %>% 
  mutate(Specification = "base2") %>% 
  select(Specification, Country, Year, theta) %>% 
  melt(id.vars = c("Specification" ,"Country", "Year")) %>% 
  rbind(.,
        df %>% 
          mutate(Specification = "data") %>%
          select(Specification, Country, Year, theta) %>%
          setNames(c("Specification","Country", "Year", "data")) %>% 
          melt(id.vars = c("Specification", "Country", "Year"))
        ) %>%
  filter(complete.cases(.)) %>% 
  subset(Year %in% c(1970:2080)) %>%
  # Trick to put data line under others
  mutate(variable = as.character(variable),
         variable = ifelse(variable == "data", "a.data", variable),
         variable = as.factor(variable)) %>% 
  
  
  rbind(., ret_age %>% 
          select(Specification, Country, Year, theta) %>%
          melt(id.vars = c("Specification" ,"Country", "Year"))) %>% 
  
  ggplot(aes(x = Year, y = value, color = interaction(variable, Country),
             linetype = Specification)) +
  geom_line() +
  facet_wrap(Country ~ ., scales = "fixed") +
  scale_color_manual(breaks = c("a.data.France", "a.data.United States",
                                "theta.France", "theta.United States"),
                    values = c("black", "black",brewer.pal(8, "Set1")[c(1,2)]) %>% 
                      setNames(c("a.data.France", "a.data.United States",
                                "theta.France", "theta.United States"))) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  scale_linetype_manual(breaks = c("data", "base2", "ret_age_2020_spe1",
                                   "ret_age_2020_spe1", "ret_age_2020_spe1"),
                        values = c("solid", "solid", "dashed", "dotted", "dotdash")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") 

```

```{r}

fillgap %>%
  rbind(., baseline %>% subset(Country == "United States")) %>% 
  mutate(Specification = "base2") %>% 
  select(Specification, Country, Year, p, p1) %>% 
  melt(id.vars = c("Specification" ,"Country", "Year")) %>% 
  subset(Year %in% c(1970:2080)) %>%
  
  rbind(., ret_age %>% 
          select(Specification, Country, Year, p, p1) %>%
          melt(id.vars = c("Specification" ,"Country", "Year"))) %>% 
  subset(Year >= 2020) %>% 
  
  ggplot(aes(x = Year, y = value, color = Specification, linetype = variable)) +
  geom_line() +
  facet_wrap(Country ~ ., scales = "fixed") +
  scale_color_manual(breaks = c("base2", "ret_age_2020_spe1", "ret_age_2020_spe2",
                                "ret_age_2020_spe3"),
                     labels = c("Benchmark", "Shift -10%",
                                "Constant", "Half growth"),
                    values = c("black", brewer.pal(8, "Set1")[c(1:3)]) %>% 
                      setNames(c("base2", "ret_age_2020_spe1", "ret_age_2020_spe2",
                                "ret_age_2020_spe3")),
                    name = "") +
  scale_x_continuous(breaks = seq(2020, 2080, 10),
                     labels = c("2020", "", "2040", "", "2060", "", "2080")) +
  scale_linetype_manual(breaks = c("p", "p1"),
                     labels = c(expression(p[t]), expression(p[t+1])),
                        values = c("solid", "dashed") %>% 
                          setNames(c("p", "p1")),
                        name = "") +
  theme_classic(base_size = 14) +
  theme(legend.position = c(0.85,0.99),
        legend.justification = c("right", "top"),
        legend.direction = "vertical",
        legend.box = "horizontal",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.text.align = 0) +
  labs(x = "Year", y = "Labor share") +
  ggsave(file.path(loc_result, "ret_age_p.png"), width = scale_graph*5, height = scale_graph*5/2)


```



```{r Graph - All ret_age}

fillgap %>%
  rbind(., baseline %>% subset(Country == "United States")) %>% 
  mutate(Specification = "base2") %>% 
  select(Specification, Country, Year, theta) %>% 
  melt(id.vars = c("Specification" ,"Country", "Year")) %>% 
  subset(Year %in% c(1970:2080)) %>%
  
  rbind(., ret_age %>% 
          select(Specification, Country, Year, theta) %>%
          melt(id.vars = c("Specification" ,"Country", "Year"))) %>% 
  subset(Year >= 2020) %>% 
  
  ggplot(aes(x = Year, y = value, color = Specification, linetype = Specification)) +
  geom_line() +
  facet_wrap(Country ~ ., scales = "fixed") +
  scale_color_manual(breaks = c("base2", "ret_age_2020_spe1", "ret_age_2020_spe2",
                                "ret_age_2020_spe3"),
                     labels = c("Benchmark", "Shift -10%",
                                "Constant", "Half growth"),
                    values = c("black", brewer.pal(8, "Set1")[c(1:3)]) %>% 
                      setNames(c("base2", "ret_age_2020_spe1", "ret_age_2020_spe2",
                                "ret_age_2020_spe3")),
                    name = "") +
  scale_x_continuous(breaks = seq(2020, 2080, 10),
                     labels = c("2020", "", "2040", "", "2060", "", "2080")) +
  scale_linetype_manual(breaks = c("base2", "ret_age_2020_spe1", "ret_age_2020_spe2",
                                "ret_age_2020_spe3"),
                     labels = c("Benchmark", "Shift -10%",
                                "Constant", "Half growth"),
                        values = c("solid", "dashed", "dashed", "dashed") %>% 
                          setNames(c("base2", "ret_age_2020_spe1", "ret_age_2020_spe2",
                                "ret_age_2020_spe3")),
                        name = "") +
  theme_classic(base_size = 14) +
  theme(legend.position = c(0.99, 0.99),
        legend.justification = c("right", "top"),
        legend.direction = "vertical",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "Year", y = "Labor share") +
  ggsave(file.path(loc_result, "ret_age.png"), width = scale_graph*5, height = scale_graph*5/2)

```















