---
title: "Inter-generational conflict and the declining labor share"
output: github_document
---

```{r init, include = FALSE}
# Load init script
source("_script/init.R")
# knitr options
knitr::opts_chunk$set(warning = FALSE) # echo = FALSE
# options(kableExtra.html.bsTable = T)

# Function
source(file.path(loc_function, "demo_changer.R"))
source(file.path(loc_function, "model.R"))
# Function to round in solver
ceiling_digit = function(x, level=1) round(x+ 5*10^(-level-1), level)
flooring_digit = function(x, level=1) round(x - 5*10^(-level-1), level)

# Country set
CountrySet = c("France", "United States")
```

# Empirics

## Data

```{r data-load}
# Penn World Table
pwt = read.csv(file.path(loc_data, "_final", "pwt.csv"))
# OECD data
oecd = read.csv(file.path(loc_data, "_final", "oecd.csv"))
# Demographic data
demo = read.csv(file.path(loc_data, "_final", "demo.csv"))
# ESA United Nations
esaun = read.csv(file.path(loc_data, "_final", "esaun.csv"))
# Load CWED data
cwed = read.csv(file.path(loc_data, "_final", "cwed.csv"))
## Merge
df = merge(pwt, oecd, all = TRUE) %>% merge(demo, all = TRUE) %>% 
  merge(esaun, all = TRUE) %>% merge(cwed, all = TRUE) %>% 
  subset(Year >= 1970)
```

## Stylized facts

### Labor share

```{r}
df %>% 
  subset(Year %in% c(1970:2017)) %>% 
  select(Country, Year, lab_sh1, i_lab_sh1) %>% 
  subset(Country %in% c("Australia", # "Canada",  
                        "France", "Japan", "United States")) %>%
  mutate(lab_sh1 = ifelse(i_lab_sh1 == 1, lab_sh1, NA)) %>% 
  select(-i_lab_sh1) %>% 
  
  ggplot(aes(x = Year, y = lab_sh1)) +
  geom_line(aes(color = Country)) +
  scale_color_brewer(palette = "Set1") +
  labs(x = element_blank(), y = element_blank(), title = "Labor share") +
  theme_bw() +
  ggsave(file.path(loc_graphic, "emp-ls-color.png"), width = 7, height = 7/1.5)
```

```{r}
## Penn World Table : all adjustment methods for the labor share
df %>% 
  subset(Year %in% c(1970:2017)) %>% 
  select(Country, Year, lab_sh1, i_lab_sh1, lab_sh2, i_lab_sh2,
         lab_sh3, i_lab_sh3, lab_sh4, i_lab_sh4, labor_share) %>% 
  subset(Country %in% c("Australia", "France", "Japan", "United States")) %>%
  mutate(lab_sh1 = ifelse(i_lab_sh1 == 1, lab_sh1, NA),
         lab_sh2 = ifelse(i_lab_sh2 == 1, lab_sh2, NA),
         lab_sh3 = ifelse(i_lab_sh3 == 1, lab_sh3, NA),
         lab_sh4 = ifelse(i_lab_sh4 == 1, lab_sh4, NA),) %>% 
  select(-i_lab_sh1, -i_lab_sh2, -i_lab_sh3, -i_lab_sh4) %>%
  setDT %>% 
  melt(id.vars = c("Country", "Year"), variable.name = "adjustment") %>% 
  subset(Country == "France") %>% 
  mutate(oecd = if_else(adjustment == "labor_share", "OECD", "PWT") %>% 
           factor(levels = c("PWT", "OECD"))) %>% 
  mutate(adjustment = factor(adjustment,
    labels = c("Mixed income", "Part mixed income",
               "Average wage", "Agriculture", "OECD"))) %>% 
  
  ggplot(aes(x = Year, y = value)) +
  geom_line(aes(color = adjustment, linetype = oecd)) +
  scale_color_manual(values = c(brewer.pal(8, "Set1")[c(1:4)], "black")) +
  labs(x = element_blank(), y = element_blank(), title = "Labor share",
       color = "Adjustment method", linetype = "Data") +
  theme_bw() +
  theme(legend.position = "right") +
  ggsave(file.path(loc_graphic, "emp-ls-FR-color.png"), width = 7, height = 7/1.5)

```


### Dep ratio

```{r}
df %>% 
  subset(Year %in% c(1970:2080)) %>% 
  select(Country, Year, dep_65) %>% 
  subset(Country %in% c("Australia", "France", "Japan", "United States")) %>%
  
  ggplot(aes(x = Year, y = dep_65, color = Country)) +
  geom_line() +
  scale_color_brewer(palette = "Set1") +
  scale_x_continuous(breaks = seq(1970, 2080, 20)) +
  labs(x = element_blank(), y = element_blank(), 
       title = "Old-age-dependency ratio") +
  theme_bw() +
  ggsave(file.path(loc_graphic, "emp-dep-color.png"), width = 7, height = 7/1.5)
```

### Both

```{r}
df %>% 
  subset(Year %in% c(1970:2010)) %>% 
  select(Country, Year, lab_sh1, i_lab_sh1, dep) %>% 
  subset(Country %in% c("Australia", "Belgium", "Canada", "Denmark", 
                        "France", "Germany", "Japan", "United States",
                        "Netherlands", "United Kingdom")) %>%
  mutate(lab_sh1 = ifelse(i_lab_sh1 == 1, lab_sh1, NA)) %>% 
  # subset(i_lab_sh1 == 1) %>% 
  select(-i_lab_sh1) %>% 
  mutate(lab_sh1 = lab_sh1*100, dep = dep*100) %>% 
  setDT %>% melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, color = Country)) +
  # geom_point() +
  geom_line() +
  facet_wrap(variable ~ ., scales = "free",
             labeller = labeller(variable = c(lab_sh1 = "Labor share (in %)", dep = "Old-age dependency ratio (in %)"))) +
  labs(x = "Year", y = element_blank()) +
  theme_bw() +
  theme(legend.position = "bottom") +
  ggsave(file.path(loc_graphic, "emp-lsdep-color.png"), width = 7, 
         height = 7/1.5)
```

```{r}
df %>% 
subset(Year %in% c(1970:2010)) %>% 
  select(Country, Year, lab_sh1, i_lab_sh1, dep) %>% 
  subset(Country %in% c("Australia", "Belgium", "Canada", "Denmark", "France", "Germany", 
                        "Japan", "United States", "Netherlands", "United Kingdom")) %>%
  subset(i_lab_sh1 == 1) %>% 
  mutate(lab_sh1 = lab_sh1*100) %>% 
  
  ggplot(aes(x = dep, y = lab_sh1)) +
  geom_point(aes(color = Country)) +
  geom_smooth(method = "lm", formula = y ~ x) +
  labs(x = "Old-age-dependency ratio", y = element_blank(), title = "Labor share (in %)") +
  theme_bw()
```

```{r}
df %>% 
  subset(Year %in% c(1970:2010)) %>% 
  select(Country, Year, rnna, avh, emp, dep) %>% 
  subset(Country %in% c("Australia", "Belgium", "Canada", "Denmark", "France", "Germany", 
                        "Japan", "United States", "Netherlands", "United Kingdom")) %>%
  mutate(k = log(rnna/avh/emp)) %>% 
  
  ggplot(aes(x = dep, y = k)) +
  geom_point(aes(color = Country)) +
  geom_smooth(method = "lm", formula = y ~ x) +
  labs(x = "Old-age-dependency ratio", y = element_blank(), title = "Capital-per-worker (in %)") +
  theme_bw()
```

```{r}
df %>% 
  subset(Year %in% c(1970:2010)) %>% 
  select(Country, Year, ls = lab_sh1, US100, UC1000, US100.lin_inter, UC1000.lin_inter, dep) %>% 
  subset(Country %in% c("France", "United States")) %>%
  mutate(urep = US100*100) %>% 
  
  ggplot(aes(x = dep, y = urep, color = Country)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x) +
  labs(x = "Old-age dependency ratio", y = element_blank(), title = "Unemployment replacement rate (in %)") +
  theme_bw()
```


## Demo and LS

```{r}
df %>% 
  subset(Year %in% c(1970:2010)) %>% 
  select(Country, Year, tax_rev_PC_GDP, rnna, avh, ls = lab_sh1, dep) %>% 
  subset(Country %in% c("Australia", "Belgium", "Canada", "Denmark", "France", "Germany", 
                        "Japan", "United States", "Netherlands", "United Kingdom")) %>%
  mutate(tau = tax_rev_PC_GDP, net_rate = 1-tau, k = log(rnna/avh), ks = 1-ls) %>% 
  
  ggplot(aes(x = ks, y = net_rate, color = Country)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x) +
  # labs(x = "Old-age dependency ratio", y = element_blank(), title = "Net rate (in %)") +
  theme_bw()
```


# Theoretical framework

## Max. capital-labor elasticity of substitution

```{r theory-xsigma}
## FUNCTION xSigma
# Define function
sigma = function(urep){-log(urep)^(-1)}
# Interval between 0 and 0.8 for feasible values of the unemployment replacement rate
interval = seq(0.001, 0.8, by = 0.001)

# Compute sigma values
xSigma = data.frame("Function", interval, sigma(interval)) %>% 
  setNames(c("Country", "interval", "sigma_values"))

## CWED Data
# Find minimum
cwed2 = cwed %>% 
  select(Country, Year, US100) %>% 
  group_by(Country) %>% 
  # Find minimum
  mutate_at(vars("US100"), list(min = ~ min(., na.rm = TRUE)),) %>% 
  subset(US100 == min) %>% slice(1) %>% 
  select(Country, Year, US100_min = min) %>% 
  mutate(
    sigma_max = sigma(US100_min) %>% round(3)
  )
# CountrySet
cwed3 = cwed2 %>% subset(Country %in% CountrySet)
```

```{r graph-xsigma}
# Plot xSigma
xSigma %>% 
  
  ggplot(aes(x = interval, y = sigma_values)) +
  geom_line() +
  theme_bw() +
  labs(x = "Unemployment replacement rate", 
       y = "Max. capital-labor elasticity of substitution") +
  ggsave(file.path(loc_graphic, "theory-xsigma.png"), width = 7, height = 7/2)
```


```{r tab-xsigma}
# Save table in TeX format
cwed3 %>% 
  select(Country, Year, "$x_t$" = US100_min, "$\\sigma$" = sigma_max) %>% 
  kable(format = "latex", booktabs = TRUE, linesep = "", escape = FALSE) %>% 
  row_spec(0, bold=TRUE) %>% 
  writeLines(., con = "_tabular/theory-xsigma.tex")

# Print table in html format
cwed3 %>% 
  select(Country, Year, "$x_t$" = US100_min, "$\\sigma$" = sigma_max) %>% 
  kable(align = "c") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = FALSE) %>% 
  row_spec(0, bold=TRUE) 
```

# Quantitative analysis

```{r quant-init}
# Simulation periods
sim = seq(1970, 2080, 10)
# Estimation sample
est_sample = c(1970:2010)

# Graphic parameters
breaks_10_years = seq(1970, 2080, 10)
labs_20_years = as.vector(rbind(seq(1970, 2080, 20), rep("", length(breaks_10_years)/2)))
scale_graph = 1920/1080
```

## Data

```{r data-merge}
# Penn World Table
pwt0 = pwt %>%
  select("Country", "Year", "emp", "avh", "rgdpna", "rnna", "lab_sh1", "lab_sh2") %>% 
  subset(Country %in% CountrySet & Year >= 1970)

# OECD data
oecd0 = oecd %>% 
  select("Country", "Year", tax_rate = "tax_rev_PC_GDP",
         union_density = "union_density.lin_inter",
         union_coverage = "union_coverage.lin_inter") %>% 
  subset(Country %in% CountrySet & Year >= 1970)

# Demographic data
demo0 = demo %>% 
  select("Country", "Year", "young", "young_1564", "old", "dep", "n", "p") %>% 
  subset(Country %in% CountrySet)

## Merge
df0 = merge(pwt0, oecd0, all = TRUE) %>% merge(demo0, all = TRUE) %>% 
  subset(Year >= 1970)
```

```{r data-variables}
# Variable modifications
df1 = df0 %>%
  group_by(Country) %>% 
  mutate(L = emp * 1000,
         Y = rgdpna / avh * 1000, # AVH control
         K = rnna / avh * 1000, # AVH control
         theta = lab_sh1, # Labor share
         tau = tax_rate / 100, # Tax rate
         u = 1 - L/young_1564, # Unemployment rate
         p1 = lead(p, 40)) %>% 
  select(Country, Year, Ny = young, No = old, n, p, p1, dep, K, L, Y, theta, tau, u) %>% 
  # Normalized labor, capital
  mutate_at(vars("L", "K"), ~ {./first(.)}) %>% 
  # Normalized capital-labor ratio, young and old population
  mutate(k = K/L, Ny = L/(1-u), No = Ny*dep) %>% 
  ungroup() %>% 
  # Remove unused countries from Country levels
  mutate(Country = Country %>% as.character %>% factor)
```

```{r data-baseline}
# Initial Sequence
init_seq = seq(1970, 2000, 10)

# Baseline data
data_base = df1 %>% 
  group_by(Country) %>% subset(Year %in% sim) %>% 
  select(Country, Year, Ny, No, n, p, p1, K) %>% 
  mutate(Sequence = ((sim - 1970)/10) %% 4 + 1, Period = (sim - init_seq) / 40 + 1) %>% 
  mutate_at(vars("Ny", "No", "K"), ~ ifelse(Year == 2010, NA, .)) %>% 
  # Complete NA values for p1 in 2070 and 2080
  mutate(
    p1 = ifelse(Year >= 2070, 
                p1[Year == 2060] + (Year - 2060)/10 * mean(p1/lag(p1)-1, na.rm = T), 
                p1), 
    ## Create empty variables
    eta = NA, AK = NA, AL = NA, k1 = NA, k2 = NA, k = NA, X = NA, L = NA, w = NA,
    r = NA, Y = NA, u = NA, theta = NA, tau = NA, b = NA, h = NA, S = NA) 

# Re-order variables
data_base = data_base %>% 
  select(Country, Year, Sequence, Period, Ny, No, n, p, p1, eta, AK, AL,
         k1, k2, k, X, L, w, r, Y, u, theta, tau, b, h, S, K)
```

```{r data-demo}
data = data_base %>% 
  # No biased technical change
  mutate(AK = 1, AL = 1) %>% 
  # Population dynamics
  demo_changer(init_spe = TRUE)
```

## Calibration

```{r graph-demo}
graph_demo = data %>% 
  mutate(dep = p/n) %>% # Compute old-age dependency ratio
  select(Country, Year, n, p, dep) %>% setDT %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, color = Country)) +
  geom_line() +
  facet_wrap(. ~ variable, scales = "free_y",
    labeller = labeller(variable = c(n = "Population growth (n)", p = "Survival rate (p)",
                                     dep = "Old-age dependency ratio (p/n) "))) +
  scale_x_continuous(breaks = breaks_10_years,
                     labels = c(1970, "", "", 2000, "", "", 2030, "", "", 2060, "", "")) +
  theme_bw() +
  labs(x = element_blank(), y = element_blank(), color = element_blank()) +
  theme(legend.position = "bottom")

# Paper version
graph_demo +
  scale_color_grey(start = 0, end = .5) +
  ggsave(file.path(loc_graphic, "quant-demo.png"), width = 7, height = 7/2.5)

# Color version
graph_demo +
    scale_color_brewer(palette = "Set1")
  ggsave(file.path(loc_graphic, "quant-demo-color.png"), width = 7, height = 7/2.5)
```


```{r calib-alpha-gamma}
# Set Alpha and Gamma (same for all countries)
param_base = data.frame(
  "Country" = rep(c("France", "United States"), each = length(sim)),
  "Year" = sim, "alpha" = (0.99)^40, "gamma" = 0.5)
```


```{r calib-sigma}
# Dataframe for estimation of sigma
df1.sigma0 = df1 %>% 
  group_by(Country) %>% 
  mutate(k_log = log(k), 
         THETA_log = log(theta/(1-theta)), 
         t_diff = Year - first(Year)) %>% 
  select(Country, Year, k_log, THETA_log, t_diff) %>% 
  subset(Year %in% c(1970:2010)) %>% 
  ungroup()

# Regressions to estimate sigma
list.sigma = list(
  ## France
  France = list(
    # One for all
    all = lm(THETA_log ~ k_log + t_diff, data = df1.sigma0, 
             subset = Country == "France") %>% 
      coef %>% {1/(1+.[2])} %>% unname(),
    # Before 1985
    before85 = 1,
    # After 1985
    after85 = lm(THETA_log ~ k_log, data = df1.sigma0,
               subset = Country == "France" & Year > 1985) %>% 
      coef %>% {1/(1+.[2])} %>% unname()
  ),
  # United-States
  `United States` = list(
    all = lm(THETA_log ~ k_log, data = df1.sigma0, 
             subset = Country == "United States") %>% 
    coef %>% {1/(1+.[2])} %>% unname
    )
)

# Add production function parameters (sigma for all)
param_base = param_base %>%
  merge(df1 %>% subset(Year == 1970) %>% mutate(phi = 1-theta) %>% 
          select(Country, phi)) %>% 
  merge(data.frame(Country = c("France", "United States"),
                   sigma = c(list.sigma$France$all, 
                             list.sigma$`United States`$all))) %>% 
  mutate(a = NA)
```


```{r calib-omega-beta}
# Compute omega and beta
param_base = param_base %>%
  merge(., df1) %>% 
  mutate(X = (sigma + (1-phi)/phi*(1-gamma*(1-sigma))/gamma*k^((1-sigma)/sigma))^(-1),
         eta = (1-phi)/phi*k^((1-sigma)/sigma) * ((Ny/K*k-1)*exp(-X) + 1),
         omega = n/p*(1+alpha*p1)/eta,
         beta = 1/(1 - tau)/(1-theta) - 1 - eta) %>% 
  group_by(Country) %>% 
  mutate(omega = first(omega), beta = first(beta)) %>% 
  select(Country, Year, alpha, gamma, phi, sigma, a, omega, beta) %>% 
  ungroup()
```

```{r calib-sigma-france}
# Change sigma for France
param_base = param_base %>% 
  mutate(sigma = ifelse(Country == "France",
                        ifelse(Year <= 1980, list.sigma$France$before85,
                               list.sigma$France$after85), sigma))
```

```{r calib-A}
## Grid search for A (Scale parameter)
# Set data
data = data_base %>% 
  # No biased technical change
  mutate(AK = 1, AL = 1) %>% 
  # Add parameters
  merge(param_base) %>% 
  # Demography
  demo_changer(AFinder = TRUE)
# A Finder script
source(file.path(loc_script, "sim_AFinder.R"))
# Assign A scale parameter to param_base
param_base$A = data$A
# Assign values
param = param_base
```

```{r tab-param}
# Print parameters in the table
coef_summary = param_base %>% 
  subset(Year == 2010) %>% mutate_if(is.numeric, ~ round(., 3)) %>% 
  select(Country, phi, gamma, alpha, sigma, omega, beta, A) %>% 
  setDT %>% melt(id.vars = "Country") %>% 
  dcast(variable ~ Country, value.var = "value") %>% 
  mutate(
    variable = c("$\\phi$", "$\\gamma$", "$\\alpha$", "$\\sigma$", 
                 "$\\omega$", "$\\beta$", "$A$"),
    var_desc = c("Capital share in 1970", "Relative bargaining power of the union",
                 "Discount rate", "Capital-labor elasticity of substitution",
                 "Relative ideological spread-out", 
                 "Preference for government health expenditure", 
                 "Scale parameter of the production function")
  ) %>% 
  select(variable, var_desc, everything())

# Table infos
coef_table_col.names = c("", "Parameter", "France", "United States")

# Save table in TeX format
coef_summary %>% 
  kable(format = "latex", col.names = coef_table_col.names, 
        booktabs = TRUE, linesep = "", escape = FALSE) %>% 
  row_spec(0, bold=TRUE) %>% 
  writeLines(., con = "_tabular/quant-param.tex")

# Print table in html format
coef_summary %>% 
  kable(col.names = coef_table_col.names, align = "llrr") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = FALSE) %>% 
  row_spec(0, bold=TRUE) 

```

```{r breakers}
breakers = demo %>% 
  ## Compute demographic data for 1960
  subset(Year == 1960) %>% 
  mutate(Sequence = NA, Period = NA, Ny = NA, No = NA, p1 = NA) %>% 
  select(Country, Year, Sequence, Period, Ny, No, n, p, p1) %>% 
  rbind(., data_base %>% 
          select(Country, Year, Sequence, Period, Ny, No, n, p, p1) %>% 
          subset(Year == 2000) %>% 
          ungroup()) %>% 
  group_by(Country) %>% 
  mutate(p1 = ifelse(Year == 1960, dplyr::lead(p), p1),
         Ny = ifelse(Year == 1960, dplyr::lead(Ny)/dplyr::lead(n), Ny),
         No = ifelse(Year == 1960, p/n*Ny, No),
         Sequence = ifelse(Year == 1960, 4, Sequence),
         Period = ifelse(Year == 1960, 0, Period)) %>% 
  subset(Year == 1960) %>% 
  ungroup() %>% 
  ## Demographic data for 1960 : done
  rbind(., data_base %>% 
          select(Country, Year, Sequence, Period, Ny, No, n, p, p1) %>% 
          ungroup()) %>% 
  arrange(Country) %>% 
  merge(., param_base %>% select(Country, alpha, omega) %>% unique()) %>% 
  group_by(Country, Sequence) %>% 
  mutate(eta = n/p*(1+alpha*p1)/omega,
         Ny = ifelse(Period == 2, lag(Ny,1)*n, Ny),
         No = ifelse(Period == 2, lag(Ny,1)*p, No),
         Ny = ifelse(Period == 3, lag(Ny,1)*n, Ny),
         No = ifelse(Period == 3, lag(Ny,1)*p, No),) %>% 
  select(-alpha, -omega) %>% 
  ungroup()
```

## Simulation

```{r sim-list}
# Empty list of simulations
list.sim = list()
```

```{r sim-baseline}
# Specification
spe = "baseline"

# Initialize result dataset
final = data.frame(matrix(ncol = ncol(data)+ ncol(param) -2 + 1, nrow = 0)) %>%
  setNames(c("Specification", names(data), names(param)[-c(1,2)]))

# Prepare data for simulation
data = data_base %>% 
  # Merge with parameters
  merge(param) %>% 
  # No BTC
  mutate(AK = 1, AL = 1) %>% 
  # Demography
  demo_changer() %>% 
  # Define specification model
  mutate(Specification = spe) %>%
  # Reorder variables
  select(Specification, everything())

# Prepare result data frame to loop on
result = final

# Simulate the baseline model for each country
for(country in CountrySet){
    result = data %>%
      subset(Country == country) %>% 
      model(time = 3) %>% 
      rbind(result, .)
}

# Regroup result
list.sim$baseline = result
```

```{r}
graph_baseline7010_LS = list.sim$baseline %>% 
  select(Country, Year, theta) %>% setDT %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  rbind(df1 %>% select(Country, Year, theta) %>% setDT %>% 
          melt(id.vars = c("Country", "Year")) %>% mutate(variable = "data")
        ) %>% 
  filter(complete.cases(.)) %>% 
  subset(Year %in% c(1970:2010)) %>% 
  mutate(variable = factor(variable, levels = c("data", "theta"))) %>% 
  
  # Graph
  ggplot(aes(x = Year, y = value, color = Country, linetype = variable)) +
  geom_line() +
  scale_linetype_discrete(label = c("Data", "Model prediction")) +
  labs(x = element_blank(), title = "Labor share", 
       y = element_blank(),
       linetype = element_blank(), color = element_blank()) +
  theme_bw() +
  theme(legend.position = "bottom")

# Paper version
graph_baseline7010_LS +
  scale_color_grey(start = 0, end = .5) +
  ggsave(file.path(loc_graphic, "quant-base7010.png"), width = 7, height = 7/1.5)

# Color version
graph_baseline7010_LS +
    scale_color_brewer(palette = "Set1") +
  ggsave(file.path(loc_graphic, "quant-base7010-color.png"), 
         width = 7, height = 7/1.5)

```

```{r}
graph_dev7010 = list.sim$baseline %>% 
  group_by(Country) %>% 
  mutate(outside = b/(1-tau)) %>% 
  select(Country, Year, eta, outside, w, L, u, K, Y, theta) %>% 
  mutate_at(vars(eta, outside, w, L, u, K, Y, theta),
            ~ (./.[Year == 1970]-1)*100) %>% 
  subset(Year %in% c(1970:2010)) %>% 
  # Variables and names
  select(Country, Year,
         "Young~political~power~(eta)" = eta,
         # "Outside~option" = outside,
         "Wage~rate~(w)" = w, 
         "Labor~(L)" = L, 
         "Unemployment~rate~(u)" = u,
         # "Capital~(K)" = K,
         "Output~(Y)" = Y
         # "Labor~share~(theta)" = theta
         ) %>% 
  setDT %>% melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(. ~ variable, scales = "free", nrow = 2,
             labeller = label_parsed) +
  scale_x_continuous(breaks = seq(1970, 2010, 10),
                     labels = c("1970","", "1990", "", "2010")) +
  labs(x = element_blank(), y = element_blank(), color = element_blank()) +
  theme_bw() +
  theme(legend.position = c(0.95, 0.4), legend.justification = c(1,1),
        panel.spacing.x = unit(1, "lines"))

# Paper version
graph_dev7010 +
  scale_color_grey(start = 0, end = .5) +
  ggsave(file.path(loc_graphic, "quant-dev7010.png"), width = 7, height = 7/1.5)


# Color version
graph_dev7010 +
  scale_color_brewer(palette = "Set1") +
  labs(title = "Deviation from the 1970's value of determinant variables (in %)") +
  ggsave(file.path(loc_graphic, "quant-dev7010-color.png"), width = 7, height = 7/1.5)
```

```{r}
graph_baseline1080_LS = list.sim$baseline %>% 
  select(Country, Year, theta) %>% setDT %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  rbind(df1 %>% select(Country, Year, theta) %>% setDT %>% 
          melt(id.vars = c("Country", "Year")) %>% mutate(variable = "data")
        ) %>% 
  filter(complete.cases(.)) %>% 
  mutate(variable = factor(variable, levels = c("data", "theta"))) %>% 
  
  ggplot(aes(x = Year, y = value, color = Country, linetype = variable)) +
  geom_line() +
  scale_x_continuous(breaks = breaks_10_years, labels = breaks_10_years) +
  scale_linetype_discrete(label = c("Data", "Model prediction")) +
  labs(x = element_blank(), y = element_blank(), 
       title = "Labor share",
       linetype = element_blank(), color = element_blank()) +
  theme_bw() +
  theme(legend.position = "bottom")
  
  
# Paper version
graph_baseline1080_LS +
  scale_color_grey(start = 0, end = .5) +
  ggsave(file.path(loc_graphic, "quant-base1080.png"), width = 7, height = 7/1.5)

# Color version
graph_baseline1080_LS +
  scale_color_brewer(palette = "Set1") +
  annotate("text", x = 2000, y = .71, 
           label = "France", color = brewer.pal(8, "Set1")[1]) +
  annotate("text", x = 2000, y = .61, 
           label = "United-States", color = brewer.pal(8, "Set1")[2]) +
  guides(color = "none") +
  ggsave(file.path(loc_graphic, "quant-base1080-color.png"), 
         width = 7, height = 7/1.5)
```

```{r}
graph_dev1080 = list.sim$baseline %>% 
  group_by(Country) %>% 
  mutate(outside = b/(1-tau)) %>% 
  select(Country, Year, eta, outside, w, L, u, K, Y) %>% 
  mutate_at(vars(eta, outside, w, L, u, K, Y), ~ (./.[Year == 2010]-1)*100) %>% 
  subset(Year %in% c(2010: 2080)) %>% 
  # Variables and names
  select(Country, Year,
         "Young~political~power~(eta)" = eta,
         # "Outside~option" = outside,
         "Wage~rate~(w)" = w, 
         "Labor~(L)" = L, 
         "Unemployment~rate~(u)" = u,
         # "Capital~(K)" = K,
         "Output~(Y)" = Y) %>% 
  setDT %>% melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(. ~ variable, scales = "free", nrow = 2,
             labeller = label_parsed) +
  scale_x_continuous(breaks = seq(2010, 2080, 10),
                     labels = c("2010","", "2030", "", "2050", "", "2070", "")) +
  labs(x = element_blank(), y = element_blank(), color = element_blank()) +
  theme_bw() +
  theme(legend.position = c(0.95, 0.4), legend.justification = c(1,1),
        panel.spacing.x = unit(1, "lines"))

# Paper version
graph_dev1080 + 
  scale_color_grey(start = 0, end = .5) +
  ggsave(file.path(loc_graphic, "quant-dev1080.png"), width = 7, height = 7/1.5)


# Color version
graph_dev1080 +
  scale_color_brewer(palette = "Set1") +
  labs(title = "Deviation from the 2010's value of determinant variables (in %)") +
  ggsave(file.path(loc_graphic, "quant-dev1080-color.png"), width = 7, height = 7/1.5)

```

## Counterfactual

```{r}
# Print demographic variables in 1970 in the table
tab_demo_1970 = list.sim$baseline %>% 
  subset(Year == 1970) %>% mutate(dep = p/n) %>% 
  select(Country, p, n, p1, dep, eta) %>% setDT %>% 
  melt(id.vars = "Country", variable.name = "var") %>% 
  dcast(var ~ Country, value.var = "value") %>% 
  mutate(
    "var" = c("$p_{1970}$", "$n_{1970}$", "$p_{2010}$",
              "$\\frac{p_{1970}}{n_{1970}}$", "$\\eta_{1970}$"),
    "Variable" = c("Survival rate in 1970", "Population growth in 1970",
                        "Expected survival rate in 2010", "Old-age-dependency ratio in 1970",
                        "Young political power in 1970")) %>% 
  mutate_if(is.numeric, ~ round(., 3)) %>% 
  select(var, Variable, everything())

# Table infos
tab_demo_1970.col_names = c("", "Variable", "France", "United-States")

# Save table in TeX format
tab_demo_1970 %>% 
  kable(format = "latex", col.names = tab_demo_1970.col_names, 
        booktabs = TRUE, linesep = "", escape = FALSE) %>% 
  row_spec(0, bold = TRUE) %>% 
  writeLines(., con = "_tabular/quant-demo70.tex")

# Print table in html format
tab_demo_1970 %>% 
  kable(col.names = coef_table_col.names, align = "llrr") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = FALSE) %>% 
  row_spec(0, bold=TRUE)
```

```{r}
# Re initialize result data frame
result = result[0,]
# Define break_year
break_year = 1970

## Aging effect decomposition : Survival rate versus Population growth
  for(sr in c("TSR", "FSR")){
    for(pg in c("TPG", "FPG")){
      
      # Simulation name
      spe = paste0("counter_", break_year, "_", pg, ".", sr, ".", "TDE", ".", "TIE")
      
      # Prepare data
      data = data_base %>% 
      # No biased technical change
      mutate(AK = 1, AL = 1) %>% 
      # Add parameters
      merge(param) %>% 
      # Demography
      demo_changer(break_year = break_year, p1_equals_p_fix = FALSE, PG = pg, SR = sr) %>% 
      # Define specification model
      mutate(Specification = spe) %>%
      # Reorder variables
      select(Specification, everything())
      
      # Simulate the model for each country
      for(country in CountrySet){
          result = data %>%
            subset(Country == country) %>% 
            model(time = 3) %>% 
            rbind(result, .)
      }
    }
  }

## Aging effect decomposition : Direct effect versus Indirect effect
  for(de in c("TDE", "FDE")){
    for(ie in c("TIE", "FIE")){
      
      # Simulation name
      spe = paste0("counter_", break_year, "_", "TPG", ".", "TSR", ".", de, ".", ie)
      
      # Prepare data
      data = data_base %>% 
      # No biased technical change
      mutate(AK = 1, AL = 1) %>% 
      # Add parameters
      merge(param) %>% 
      # Demography
      demo_changer(break_year = break_year, p1_equals_p_fix = FALSE, DE = de, IE = ie) %>% 
      # Define specification model
      mutate(Specification = spe) %>%
      # Reorder variables
      select(Specification, everything())
      
      # Simulate the model for each country
      for(country in CountrySet){
          result = data %>%
            subset(Country == country) %>% 
            model(time = 3) %>% 
            rbind(result, .)
      }
    }  }


# Remove duplicates
final = distinct(result)

# Model specification details
final = final %>% mutate(PG = ifelse(grepl("TPG", Specification), "TPG", "FPG"),
                 SR = ifelse(grepl("TSR", Specification), "TSR", "FSR"),
                 DE = ifelse(grepl("TDE", Specification), "TDE", "FDE"),
                 IE = ifelse(grepl("TIE", Specification), "TIE", "FIE"),
                 break_year = as.numeric(gsub("[^0-9]", "\\1", Specification))) %>% 
  select(Specification, break_year, PG, SR, DE, IE, everything())
```

```{r}
# Dataframe to compare the LS counterfactual
decomp = final %>% 
  select(Country, Specification, Year, theta) %>% 
  rbind(., 
        df1 %>% 
          mutate(Specification = paste0("data_", break_year)) %>%
          select(Specification, Country, Year, theta))  %>% 
  mutate(from = ifelse(!grepl("data", Specification), "sim", "data")) %>%
  filter(complete.cases(.)) %>% 
  mutate(PG = ifelse(from == "data", NA, ifelse(grepl("TPG", Specification), "TPG", "FPG")),
         SR = ifelse(from == "data", NA, ifelse(grepl("TSR", Specification), "TSR", "FSR")),
         DE = ifelse(from == "data", NA, ifelse(grepl("TDE", Specification), "TDE", "FDE")),
         IE = ifelse(from == "data", NA, ifelse(grepl("TIE", Specification), "TIE", "FIE")),
         break_year = as.numeric(gsub("[^0-9]", "\\1", Specification))) %>% 
  select(Specification, break_year, PG, SR, DE, IE, everything())

```

```{r}
# Dataframe for decomposition
decomp2 = decomp %>% subset(from == "sim") %>% 
  mutate(Spe_PGSR = interaction(PG, SR), Spe_DEIE = interaction(DE, IE)) %>% 
  select(Country, Year, break_year, Spe_PGSR, Spe_DEIE, theta) %>% setDT %>% 
  dcast(Country + Year + break_year ~ Spe_PGSR + Spe_DEIE, value.var = "theta") %>% 
  setNames(c("Country", "Year", "break_year",
             "FPG.FSR", "TPG.FSR", "FPG.TSR", "FDE.FIE", "TDE.FIE", "FDE.TIE",
             "benchmark")) %>% 
  mutate(FPG.TSR = (benchmark - FPG.TSR)*100,
         TPG.FSR = (benchmark - TPG.FSR)*100,
         FPG.FSR = (benchmark - FPG.FSR)*100,
         FPG.FSR = FPG.FSR - FPG.TSR - TPG.FSR,
         position_PGSR = (FPG.TSR + TPG.FSR + FPG.FSR),
         FPG.TSR.share = abs(FPG.TSR)/(abs(FPG.TSR) + abs(TPG.FSR) + abs(FPG.FSR)),
         TPG.FSR.share = abs(TPG.FSR)/(abs(FPG.TSR) + abs(TPG.FSR) + abs(FPG.FSR)),
         FPG.FSR.share = abs(FPG.FSR)/(abs(FPG.TSR) + abs(TPG.FSR) + abs(FPG.FSR)),
         FDE.TIE = (benchmark - FDE.TIE)*100,
         TDE.FIE = (benchmark - TDE.FIE)*100,
         FDE.FIE = (benchmark - FDE.FIE)*100,
         FDE.FIE = FDE.FIE - FDE.TIE - TDE.FIE,
         position_DEIE = (FDE.TIE + TDE.FIE + FDE.FIE),
         FDE.TIE.share = abs(FDE.TIE)/(abs(FDE.TIE) + abs(TDE.FIE) + abs(FDE.FIE)),
         TDE.FIE.share = abs(TDE.FIE)/(abs(FDE.TIE) + abs(TDE.FIE) + abs(FDE.FIE)),
         FDE.FIE.share = abs(FDE.FIE)/(abs(FDE.TIE) + abs(TDE.FIE) + abs(FDE.FIE))) %>% 
  setDT %>% 
  melt(id.vars = c("Country", "Year", "break_year", "position_PGSR", "position_DEIE"))

```

### Population growth and survival rate effects

```{r}
# Counterfactual graphic parameters
pgsr_labels = c("Data", "Benchmark", expression(n[1970]), expression(p[1970]),
               expression(n[1970]*", "*p[1970]))

## Counterfactual PGSR
graph_pgsr_counter = decomp %>% 
  # subset(Year >= 2000) %>% 
  subset(DE %in% c("TDE", NA) & IE %in% c("TIE", NA)) %>%
  mutate(PGSR = interaction(PG, SR) %>% as.character %>%
           ifelse(is.na(.), "data", .)) %>% 
  mutate(PGSR = factor(PGSR,
                       levels = c("data", "TPG.TSR", "FPG.TSR", "TPG.FSR", "FPG.FSR"))) %>% 
  
  ggplot(aes(x = Year, y = theta, color = PGSR, linetype = PGSR)) +
  facet_wrap(Country ~ .) +
  geom_line() +
  theme_bw() +
  theme(legend.position = "bottom",) +
  labs(x = element_blank(), y = element_blank(), title = "Labor share",
       color = element_blank(), linetype = element_blank())

# Paper version
graph_pgsr_counter +
  scale_linetype_manual(labels = pgsr_labels, 
                        values = c("solid", "solid", "dashed", "twodash", "dotted")) +
  scale_color_manual(labels = pgsr_labels, values = c("grey", rep("black", 4))) +
  ggsave(file.path(loc_graphic, "quant-pgsr-counter.png"), width = 7, height = 7/1.5)

# Color version
graph_pgsr_counter +
  scale_linetype_manual(labels = pgsr_labels, values = c("solid", rep("dashed", 4))) +
  scale_color_manual(labels = pgsr_labels, 
                     values = c("black", brewer.pal(8, "Set1")[c(1:4)])) +
  ggsave(file.path(loc_graphic, "quant-pgsr-counter-color.png"), width = 7, height = 7/1.5)
 
  
```

```{r}
# Labels
pgsr_labels2 = c("Population growth effect", "Survival rate effect", 
                 "Interaction effect")

## PGSR Decomposition
graph_pgsr_decomp = decomp2 %>%
  subset(variable %in% c("FPG.TSR", "TPG.FSR", "FPG.FSR")) %>%
  mutate(variable = factor(variable, levels = c("FPG.TSR", "TPG.FSR", "FPG.FSR"))) %>%
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable), alpha = .7, 
           position = position_stack(reverse = TRUE)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  facet_wrap(Country ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_bw() +
  theme(legend.direction = "horizontal", legend.box = "horizontal", legend.position = "bottom",
        axis.title.x = element_blank()) +
  labs(x = element_blank(), y = element_blank(), fill = element_blank(),
       title = "Difference with counterfactual (in pp.)")

# Paper version
graph_pgsr_decomp +
  geom_line(aes(y = position_PGSR), color = "black") +
    scale_fill_grey(labels = pgsr_labels2, start = .1, end = .8) +
  ggsave(file.path(loc_graphic, "quant-pgsr-decomp.png"), width = 7, height = 7/1.5)

# Color version
graph_pgsr_decomp + 
  geom_line(aes(y = position_PGSR), color = brewer.pal(8, "Set1")[1]) +
  scale_fill_manual(labels = pgsr_labels2, values = brewer.pal(8, "Set1")[c(2:4)]) +
  ggsave(file.path(loc_graphic, "quant-pgsr-decomp-color.png"), width = 7, height = 7/1.5)

```

### Direct and indirect channels

```{r}
# Counterfactual graphic parameters
deie_labels = c("Data", "Benchmark", expression(p[1970]*", "*n[1970]), expression(eta[1970]),
                expression(p[1970]*", "*n[1970]*", "*eta[1970]))

## Counterfactual PGSR
graph_deie_counter = decomp %>% 
  # subset(Year >= 2000) %>% 
  subset(PG %in% c("TPG", NA) & SR %in% c("TSR", NA)) %>%
  mutate(DEIE = interaction(DE, IE) %>% as.character %>%
           ifelse(is.na(.), "data", .)) %>% 
  mutate(DEIE = factor(DEIE,
                       levels = c("data", "TDE.TIE", "FDE.TIE", "TDE.FIE", "FDE.FIE"))) %>% 
  
  ggplot(aes(x = Year, y = theta, color = DEIE, linetype = DEIE)) +
  facet_wrap(Country ~ .) +
  geom_line() +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_bw() +
  theme(legend.position = "bottom",) +
  labs(x = element_blank(), y = element_blank(), title = "Labor share",
       color = element_blank(), linetype = element_blank())

# Paper version
graph_deie_counter +
    scale_linetype_manual(labels = deie_labels, 
                        values = c("solid", "solid", "dashed", "twodash", "dotted")) +
    scale_color_manual(labels = deie_labels, values = c("grey", rep("black", 4))) +
  ggsave(file.path(loc_graphic, "quant-deie-counter.png"), width = 7, height = 7/1.5)

# Color version
graph_deie_counter +
    scale_linetype_manual(labels = deie_labels, 
                          values = c("solid", rep("dashed", 4))) +
    scale_color_manual(labels = deie_labels, 
                       values = c("black", brewer.pal(8, "Set1")[c(1,5,8,4)])) +
  ggsave(file.path(loc_graphic, "quant-deie-counter-color.png"), width = 7, height = 7/1.5)
```

```{r}
# Labels
deie_labels2 = c("Factor accumulation", "Policy mechanism",
                 "Interaction effect")

## DEIE Decomposition
graph_deie_decomp = decomp2 %>% 
  subset(variable %in% c("FDE.TIE", "TDE.FIE", "FDE.FIE")) %>% 
  mutate(variable = factor(variable, levels = c("FDE.TIE", "TDE.FIE", "FDE.FIE"))) %>% 
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable), alpha = .7) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  facet_wrap(Country ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_bw() +
  theme(legend.direction = "horizontal", legend.box = "horizontal", legend.position = "bottom") +
  labs(x = element_blank(), y = element_blank(), fill = element_blank(),
       title = "Difference with counterfactual (in pp.)")

# Paper version
graph_deie_decomp +
  geom_line(aes(y = position_DEIE), color = "black") +
    scale_fill_grey(labels = deie_labels2, start = .1, end = .8) +
  ggsave(file.path(loc_graphic, "quant-deie-decomp.png"), width = 7, height = 7/1.5)

# Color version
graph_deie_decomp + 
  geom_line(aes(y = position_DEIE), color = brewer.pal(8, "Set1")[1]) +
  scale_fill_manual(labels = deie_labels2, values = brewer.pal(8, "Set1")[c(5,8,4)]) +
  ggsave(file.path(loc_graphic, "quant-deie-decomp-color.png"),
         width = 7, height = 7/1.5)


```

## Summary

```{r }
# Compute the share of each effect/channel for two sub_periods 1980-2010 & 2020-2050
decomp_mean.period = decomp2 %>% select(-contains("position")) %>% setDT %>% 
  dcast(Country + Year + break_year ~ variable) %>% 
  mutate(Country_break = interaction(break_year, Country, sep = " - "),
         Period = ifelse(Year %in% c(1970:2010), "P1",
                         ifelse(Year %in% c(2020:2050), "P2", "P3"))) %>% 
  subset(Period != "P3") %>% 
  group_by(Country_break, Period) %>% 
  select(Country_break, Period, TPG.FSR.share, FPG.TSR.share, FPG.FSR.share,
         FDE.TIE.share, TDE.FIE.share, FDE.FIE.share) %>% 
  summarise_at(vars(TPG.FSR.share:FDE.FIE.share), mean, na.rm = TRUE)
```

```{r}
# Summary
graph_decomp_summary = decomp_mean.period %>% setDT %>% 
  melt(id.vars = c("Country_break", "Period")) %>% 
  mutate(value = value*100) %>% 
  subset(Country_break %in% c("1970 - France", "1970 - United States")) %>% 
  mutate(Country = ifelse(Country_break == "1970 - France", "France", "United States"),
         effect = factor(ifelse(variable %>% grepl(pattern = "PG", .), "first", "second")),
         Period = ifelse(Period == "P1", "1980 - 2010", "2020 - 2050")) %>% 
  mutate(variable = factor(variable, 
    levels = c("FPG.TSR.share", "TPG.FSR.share", "FDE.TIE.share", 
               "TDE.FIE.share", "FPG.FSR.share", "FDE.FIE.share"),
    labels = c("Population growth", "Survival rate", "Factor accumulation", 
               "Policy mechanism", "Interaction", "Interaction"))) %>% 
  
  ggplot(aes(x = effect, y = value, fill = variable)) +
  facet_grid(Country ~ Period) +
  scale_x_discrete(breaks = c("first", "second"), 
                   labels = c("Determinants", "Channels")) +
  theme_bw() +
  theme(legend.direction = "horizontal", legend.position = "bottom") +
  labs(x = element_blank(), y = element_blank(), fill = element_blank())

# Paper version
graph_decomp_summary +
  geom_bar(stat = "identity", position = position_dodge(), color = "black") +
  scale_fill_grey(start = 1, end = 0) +
  ggsave(file.path(loc_graphic, "quant-sum-decomp.png"), width = 7, height = 7/1.5)

# Color version
graph_decomp_summary +
    geom_bar(stat = "identity", position = position_dodge(), alpha = .7) +
    scale_fill_manual(values = brewer.pal(8, "Set1")[c(2,3,5,8,4)]) +
  ggsave(file.path(loc_graphic, "quant-sum-decomp-color.png"), 
         width = 7, height = 7/1.5)
```

# Discussion

## Age-related conflict: who are the winners ? {#winners}

```{r}
# Compute redistribution
redis = list.sim$baseline %>%
  group_by(Country) %>% 
  # Compute GDP split
  mutate(
    # Step 1
    wL = w*L, rK = r*K,
    # Step 2
    wL_net = (1-tau)*wL, rK_net = (1-tau)*rK, gov_rev = tau*Y,
    # Step 3
    unemp_ben = b*u*Ny, health_spen = h*No,
    # Step 4
    C1 = 1/(1+alpha*p1)*(wL_net+unemp_ben),
    Saving = alpha*p1/(1+alpha*p1)*(wL_net+unemp_ben),
    C2 = rK_net,
    # Incomes
    inc_y = wL_net + unemp_ben, inc_o = rK_net,
    # Labor share
    theta = wL/Y,
    # Dep ratio
    dep = p/n,
    ) %>% 
  select(Country, Year, wL, rK, wL_net, rK_net, gov_rev, unemp_ben, health_spen,
         C1, Saving, C2, inc_y, inc_o, Y, theta, eta, dep) %>% 
  ungroup()
```


```{r}
## Core
graph_dev_income_ratio = redis %>% 
  select(Country, Year, inc_y, inc_o, wL, rK, health_spen, eta) %>% 
  group_by(Country) %>% 
  mutate(inc_ratio = inc_y/inc_o,
         #inc_ratio_with_h = inc_y/(inc_o + health_spen),
         lab_to_cap_ratio = wL/rK) %>% 
  mutate_at(vars(contains("ratio")), ~ {(./.[Year == 1970] -1)*100}) %>% 
  select(Country, Year, lab_to_cap_ratio, inc_ratio) %>% 
  setDT %>% melt(id.vars = c("Country", "Year")) %>% 
  mutate(variable = factor(variable, 
                           labels = c("Labor-to-capital", "Young-to-old"))) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = variable, color = Country)) +
  geom_line() +
  # geom_hline(yintercept = 0, linetype = "dotted") +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_bw() +
  labs(x = element_blank(), y = element_blank(), 
       linetype = "Income ratio", color = "Country") +
  theme(legend.position = "right")

# Color version
graph_dev_income_ratio + 
  scale_color_grey(start = 0, end = .5) + 
  ggsave(file.path(loc_graphic, "discuss-dev-inc-ratio.png"), 
         width = 7, height = 7/2)

# Paper version
graph_dev_income_ratio +
  geom_hline(yintercept = 0, linetype = "dotted") +
  scale_color_brewer(palette = "Set1") +
  labs(title = "Income ratios in deviation from the 1970's value (in %)") +
  ggsave(file.path(loc_graphic, "discuss-dev-inc-ratio-color.png"), 
         width = 7, height = 7/2)

```


```{r}
## Core
graph_dev_income_ratio_capita = redis %>% 
  select(Country, Year, inc_y, inc_o, wL, rK, health_spen, eta, dep) %>% 
  group_by(Country) %>% 
  mutate(inc_ratio = inc_y/inc_o*dep,
         #inc_ratio_with_h = inc_y/(inc_o + health_spen),
         lab_to_cap_ratio = wL/rK*dep) %>% 
  mutate_at(vars(contains("ratio")), ~ {(./.[Year == 1970] -1)*100}) %>% 
  select(Country, Year, lab_to_cap_ratio, inc_ratio) %>% 
  setDT %>% melt(id.vars = c("Country", "Year")) %>% 
  mutate(variable = factor(variable, 
                           labels = c("Labor-to-capital", "Young-to-old"))) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = variable, color = Country)) +
  geom_line() +
  # geom_hline(yintercept = 0, linetype = "dotted") +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_bw() +
  labs(x = element_blank(), y = element_blank(), 
       linetype = "Income ratio", color = "Country") +
  theme(legend.position = "right")

# Color version
graph_dev_income_ratio_capita + 
  scale_color_grey(start = 0, end = .5) + 
  ggsave(file.path(loc_graphic, "discuss-dev-inc-ratio-capita.png"), 
         width = 7, height = 7/2)

# Paper version
graph_dev_income_ratio_capita +
  geom_hline(yintercept = 0, linetype = "dotted") +
  scale_color_brewer(palette = "Set1") +
  labs(title = "Income (per-cohort-member) ratios in deviation from the 1970's value (in %)") +
  ggsave(file.path(loc_graphic, "discuss-dev-inc-ratio-capita-color.png"), 
         width = 7, height = 7/2)

```

```{r}
## 3rd step decomposition of GDP
graph_step3_stacked = redis %>% 
  mutate(wL_net = wL_net/Y,
         unemp_ben = unemp_ben/Y,
         health_spen = health_spen/Y,
         rK_net = rK_net/Y) %>% 
  select(Country, Year, rK_net, health_spen, unemp_ben, wL_net, theta) %>% 
  setDT %>% melt(id.vars = c("Country", "Year", "theta")) %>%
  mutate(variable = factor(variable, 
                           levels = c("rK_net", "health_spen", "unemp_ben",
                                      "wL_net"), 
                           labels = c("Net capital income", "Health spending", 
                                      "Unemployment spending", "Net labor income"))
         ) %>% 
  
  # Plot
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable)) +
  geom_line(aes(y = theta), linetype = "dashed", color = "black") +
  facet_wrap(Country ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_bw() +
  theme(legend.position = "bottom", panel.spacing.x = unit(1.5, "lines")) +
  labs(x = element_blank(), y = element_blank(), title = "Share of GDP",
       fill = element_blank()) 
# + 
#   guides(fill = guide_legend(nrow = 2, byrow = TRUE))


# Paper version
graph_step3_stacked + 
  scale_fill_grey(start = .8, end = 0) +
  ggsave(file.path(loc_graphic, "discuss-step3-stacked.png"), 
         width = 7, height = 7/2)
  
# Color version
graph_step3_stacked + 
    scale_fill_manual(values = brewer.pal(8, "Set3")[c(4,6,3,5)]) +
  ggsave(file.path(loc_graphic, "discuss-step3-stacked-color.png"), 
         width = 7, height = 7/2)

```

```{r}
# Utility level per generation
utility = list.sim$baseline %>%
  group_by(Country, Sequence) %>% 
  # Compute GDP split
  mutate(
    y = (1-u)*(1-tau)*w+u*b,
    c1 = log(y/(1+alpha*p1)),
    c2 = alpha*p1/(1+alpha*p1)*(1-lead(tau,1))*y*r/p,
    util = log(c1) + alpha*p1*(log(c2) + beta*log(lead(h,1)))
    ) %>% 
  ungroup()

View(utility)

# Always increasing because of the increase in survival rate

```


## Retirement age

```{r retage_init}

# Define break_year
break_year = 2020
# Define first years after the reform
first_years = seq(break_year+10, (break_year+40), by = 10)

# Init ret_age
list.sim$retage = data.frame(matrix(ncol = ncol(result)+3, nrow = 0)) %>%
  setNames(c(names(result), c("p_fix", "p1_to_p_dist", "shock")))

for(spe in c(1:3)){

if(spe == 1){shock = -1/10}
if(spe == 2){frac = 0}
if(spe == 3){frac = .5}

# Re initialize result data frame
result = result[0,] %>% 
  data.frame()
  
# Prepare data
data = data_base %>% 
  # No biased technical change
  mutate(AK = 1, AL = 1) %>% 
  # Add parameters
  merge(param) %>% 
  # Demography
  demo_changer(break_year = break_year, p1_equals_p_fix = FALSE) %>% 
  # Define specification model
  mutate(Specification = spe) %>%
  # Reorder variables
  select(Specification, everything())

## Modification of demographic data
if(spe == 1){
data = data %>% 
  group_by(Country, Sequence) %>% 
  mutate(
    # New p, p1 and n
    p.new = ifelse(Year > break_year, p*(1+shock), p),
    p1.new = ifelse(Year > break_year, p1*(1+shock), p1),
    n.new = ifelse(Year %in% first_years, n*(1-shock), n),
    
    p_fix = NA,
    p1_to_p_dist = NA,
    shock = shock,
    )
}
if(spe %in% c(2,3)){
data = data %>% 
  group_by(Country, Sequence) %>% 
  # Merge with break year
  merge(., data_base %>% 
          subset(Year == break_year) %>%
          select(Country, p_fix = p), by = "Country") %>% 
  
  mutate(
    p1_to_p_dist = p1 - p,
    # New p and p1
    p.new = ifelse(Year > break_year, frac*(p-p_fix) + p_fix, p),
    p1.new = ifelse(Year > break_year & Period < 3, dplyr::lead(p.new,1),
                    ifelse(Period == 3, p.new + p1_to_p_dist*frac, p1)),
    # Scale for the affected periods
    shock = (p.new - p)/p
    )
}

data = data %>% 
  mutate(
    # New n
    n.new = ifelse(Year %in% first_years, n*(1-shock), n),
    # Compute Ny and No for the affected periods
    Ny.new = ifelse(Year %in% first_years, Ny*(1-shock), NA),
    No.new = ifelse(Year %in% first_years, No*(1+shock), NA),
    # Compute Ny and No for last sequence/periods
    Ny.new = ifelse(Year > max(first_years), lag(Ny.new,1)*n, Ny.new),
    No.new = ifelse(Year > max(first_years), lag(Ny.new,1)*p.new, No.new),
    # Recompute eta
    eta.new = n.new/p.new*(1+alpha*p1.new)/omega,
    # Replace values
    Ny = ifelse(is.na(Ny.new), Ny, Ny.new),
    No = ifelse(is.na(No.new), No, No.new),
    n = n.new,
    p = p.new,
    p1 = p1.new,
    eta = eta.new
    ) %>% 
  select(Specification, Country, Year, Sequence, Period, Ny, No, n, p, p1, 
         eta, everything(), -contains("new"), ) %>%
  ungroup()


# Simulate the model for each country
for(country in CountrySet){
  result = data %>%
  subset(Country == country) %>% 
  model(time = 3) %>% 
  rbind(result, .)
}

# Remove duplicates
list.sim$retage = rbind(list.sim$retage, result)
}

```

```{r discuss-retage-p}
## Survival rate dataframe
retage_p = list.sim$retage[,-c({ncol(list.sim$retage)-2}:ncol(list.sim$retage))] %>%
  rbind(list.sim$baseline) %>% 
  select(Specification, Country, Year, p, p1) %>% setDT %>% 
  melt(id.vars = c("Specification" ,"Country", "Year")) %>% 
  subset(Year >= 2020) %>% 
  mutate(Specification = factor(Specification,
    levels = c("baseline", 1:3),
    labels = c("Benchmark", "Shift -10%", "Constant", "Half growth")))

# Paper version
retage_p %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = variable)) +
  geom_line() +
  facet_wrap(Country ~ ., scales = "fixed") +
  scale_linetype_manual(values = c("solid", "dashed", "dotdash", "dotted")) +
  scale_color_grey(start = 0, end = .5, labels = c(expression(p[t]), expression(p[t+1]))) +
  scale_x_continuous(breaks = seq(2020, 2080, 10),
                     labels = c("2020", "", "2040", "", "2060", "", "2080")) +
  theme_bw() +
  theme(legend.position = "right", legend.text.align = 0, 
        panel.spacing.x = unit(1, "lines")) +
  labs(x = element_blank(), y = element_blank(), linetype = "Scenario",
       color = "Variable", title = "Survival rates") +
  guides(linetype = guide_legend(order = 2), color = guide_legend(order = 1)) +
  ggsave(file.path(loc_graphic, "discuss-retage-p.png"), 
         width = 7, height = 7/2)

# Color version
retage_p  %>% 
  
  ggplot(aes(x = Year, y = value, linetype = variable, color = Specification)) +
  geom_line() +
  facet_wrap(Country ~ ., scales = "fixed") +
  scale_linetype_manual(values = c("solid", "dashed"), 
                        labels = c(expression(p[t]), expression(p[t+1]))) +
  scale_color_manual(values = c("black", brewer.pal(8, "Set1")[c(1:3)])) +
  scale_x_continuous(breaks = seq(2020, 2080, 10),
                     labels = c("2020", "", "2040", "", "2060", "", "2080")) +
  theme_bw() +
  theme(legend.position = "right", legend.text.align = 0, 
        panel.spacing.x = unit(1, "lines")) +
  labs(x = element_blank(), y = element_blank(), linetype = "Variable",
       color = "Scenario", title = "Survival rates") +
  guides(linetype = guide_legend(order = 1), color = guide_legend(order = 2)) +
  ggsave(file.path(loc_graphic, "discuss-retage-p-color.png"), 
         width = 7, height = 7/2)

```

```{r}
## Survival rate dataframe
retage_ls = list.sim$retage[,-c({ncol(list.sim$retage)-2}:ncol(list.sim$retage))] %>%
  rbind(list.sim$baseline) %>% 
  select(Specification, Country, Year, theta) %>% setDT %>% 
  melt(id.vars = c("Specification" ,"Country", "Year")) %>% 
  subset(Year >= 2020) %>% 
  mutate(Specification = factor(Specification,
    levels = c("baseline", 1:3),
    labels = c("Benchmark", "Shift -10%", "Constant", "Half growth")))

# Paper version
retage_ls %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Specification)) +
  geom_line() +
  facet_wrap(Country ~ ., scales = "fixed") +
  scale_color_manual(values = rep("black", 4)) +
  scale_linetype_manual(values = c("solid", "dashed", "dotdash", "dotted")) +
  scale_x_continuous(breaks = seq(2020, 2080, 10),
                     labels = c("2020", "", "2040", "", "2060", "", "2080")) +
  theme_bw() +
  theme(legend.position = "bottom", legend.text.align = 0) +
  labs(x = element_blank(), y = element_blank(), linetype = "Scenario",
       color = "Scenario", title = "Labor share") +
  ggsave(file.path(loc_graphic, "discuss-retage-ls.png"), 
         width = 7, height = 7/1.5)

# Color version
retage_ls  %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Specification)) +
  geom_line() +
  facet_wrap(Country ~ ., scales = "fixed") +
  scale_color_manual(values = c("black", brewer.pal(8, "Set1")[c(1:3)])) +
  scale_linetype_manual(values = c("solid", rep("dashed", 3))) +
  scale_x_continuous(breaks = seq(2020, 2080, 10),
                     labels = c("2020", "", "2040", "", "2060", "", "2080")) +
  theme_bw() +
  theme(legend.position = "bottom", legend.text.align = 0) +
  labs(x = element_blank(), y = element_blank(), linetype = "Scenario",
       color = "Scenario", title = "Labor share") +
  ggsave(file.path(loc_graphic, "discuss-retage-ls-color.png"), 
         width = 7, height = 7/1.5)

```

# Uniqueness

```{r}
# Define the g function
g = function(k, sigma, ks){
  k1 = ks[1]
  k2 = ks[2]
  G = log((k/k1-1)/((k/k2)^((sigma-1)/sigma)-1))
  return(G)
}

# Create a dataframe with only x values
df.inter = data.frame("inter" = seq(0, 6, length.out = 10000))

# 4 cases
sigmas = c(0.8, 1.2)
ks = list(c(1, 2), c(2,1))

# Empty dataframe
df.g = data.frame(matrix(nrow = 0, ncol = 4)) %>% 
  setNames(c("inter", "sigma", "k_type", "g"))

# Loop
for(ss in 1:length(sigmas)){
  for(kk in 1:length(ks)){
    
  df.g = df.inter %>% 
    mutate(sigma = sigmas[ss], k_type = kk) %>% 
    mutate(g = g(inter, sigma, ks[[kk]])) %>% 
    rbind(df.g)
  }
}

# Figure
df.g %>% 
  
  filter(!((is.nan(g)|is.infinite(g)) & sigma == 0.8 & inter > 3)) %>%
  mutate(sigma = factor(sigma, labels = c('sigma~"<"~1','sigma~">"~1')),
         k_type = factor(k_type, labels = c('k[1]~"<"~k[2]', 'k[1]~">"~k[2]'))) %>%
  
  ggplot(aes(x = inter, y = g)) +
  geom_vline(xintercept = 1, color = "black", linetype = "dashed", alpha = 0.5) +
  geom_vline(xintercept = 2, color = "black", linetype = "dashed", alpha = 0.5) +
  geom_line() +
  facet_grid(k_type ~ sigma , scales = "free_x", labeller = label_parsed) +
  scale_x_continuous(breaks = c(0, 1, 2), 
                     labels = c(0, "", ""), expand = c(0,0)) +
  scale_y_continuous(name = "", breaks = 0, labels = 0, expand = c(0,0)) +
  labs(x = element_blank(), y = element_blank()) +
  theme_bw() +
  ggsave(file.path(loc_graphic, "uniq-g-shape.png"), width = 7, height = 7/1.5)
```

```{r}
# Define h function
h = function(k, sigma, phi, gamma){
  H = (sigma + (1-phi)/phi * (1-gamma*(1-sigma))/gamma * k^((1-sigma)/sigma))^(-1)
  return(H)
}

# Create a dataframe with only x values
df.inter = data.frame("inter" = seq(0, 1, length.out = 10000))

# 3 cases
sigmas = c(0.25, 0.8, 1.2)
phi = 0.3 # Average value of phi for France and the United-States
gamma = 0.5 # Value from calibration

# Empty dataframe
df.h = data.frame(matrix(nrow = 0, ncol = 4)) %>% 
  setNames(c("inter", "sigma", "k_type", "g"))

# Loop
for(ss in 1:length(sigmas)){
  
  df.h = df.inter %>% 
    mutate(sigma = sigmas[ss]) %>% 
    mutate(h = h(inter, sigma, phi, gamma)) %>% 
    rbind(df.h)
}

# Figure
df.h %>% 
  mutate(h_rescale = h*sigma) %>% 
  
  filter(inter < 1) %>%
  mutate(sigma = factor(sigma, labels = c('sigma~"<"~0.5','0.5~"<"~sigma~"<"~1',
                                          'sigma~">"~1'))) %>% 
  
  ggplot(aes(x = inter, y = h_rescale)) +
  geom_hline(yintercept = 1, color = "black", linetype = "dashed", alpha = 0.5) +
  # geom_vline(xintercept = 2, color = "black", linetype = "dashed", alpha = 0.5) +
  geom_line() +
  facet_grid(. ~ sigma , scales = "free_x", labeller = label_parsed) +
  scale_x_continuous(breaks = 0, labels = 0, expand = c(0,0)) +
  scale_y_continuous(breaks = c(0, 1), labels = c(0, expression(frac(1,sigma))), 
                     limits = c(0, 1.05), expand = c(0,0)) +
  labs(x = element_blank(), y = element_blank()) +
  theme_bw() +
  ggsave(file.path(loc_graphic, "uniq-h-shape.png"), width = 7, height = 7/2.5)
```

```{r}
# Ranges
sigma_range = c(1.1, 1.2, 1.3, 1.5, 1.7)
k1 = 1
k2_range = k1*c(0.3, 0.6, 0.9)
gamma = 0.5
phi = 0.3

# Interval
inter = seq(0.001, 30, 0.001)

# Empty data frame
result = data.frame(matrix(ncol = 4, nrow = 0)) %>% 
  setNames(c("inter", "sigma", "k2", "value"))

# Loop to compute g function
for(k2 in k2_range){
  for(sigma in sigma_range){
   
   g = function(k, sigma, k1, k2){
      G = log((k/k1-1)/((k/k2)^((sigma-1)/sigma)-1))
      return(G)
   }
   
   h = function(k, sigma, k1, phi, gamma){
     H = (sigma + (1-phi)/phi*(1-gamma*(1-sigma))/gamma*k^((1-sigma)/sigma))^(-1)
     return(H)
   }
   
   # Cbind
   result = cbind(inter, sigma, k2, "value" = g(inter, sigma, k1, k2),
                  "value_h" = h(inter, sigma, k1, phi, gamma)) %>% 
     rbind(result)
  }
}

# Regroup and set factor
result = as.data.frame(result) %>% 
   mutate(bound = 1/as.numeric(as.character(sigma)),
          violation = ifelse(bound > value, TRUE, FALSE),
          h_over_g = ifelse(value < value_h, TRUE, FALSE),
          sigma = as.factor(sigma),
          k2 = as.factor(k2))

result_after = result %>% 
  subset(inter > as.numeric(as.character(k2)))

result_before = result %>% 
  subset(inter <= as.numeric(as.character(k2)))

# Show minimum k on (k2, +infinity)
min_val = result_after %>%  
  group_by(sigma, k2) %>% 
  summarise(min(value), min(bound)) %>% 
  setNames(c("sigma", "k2", "min_k", "min_x"))

x_bound = min_val %>% pull("min_x")

## Figure
graph_uniq_case_d = result %>% 
  
  ggplot(aes(x = inter, color = sigma)) +
  # g function
  geom_line(aes(y = value)) +
  # h function
  geom_line(aes(y = value_h), linetype = "dashed") +
  # Limit in +infinity of the h function
  geom_hline(data = min_val, aes(yintercept = x_bound, color = sigma), linetype = "dotted") +
  # Wrap
  facet_wrap(k2 ~ ., labeller = label_bquote(nu == .(as.numeric(as.character(k2))))) +
  # Axis
  scale_x_continuous(breaks = 0, limits = c(0, 3), expand = c(0,0)) +
  scale_y_continuous(breaks = c(0,1), limits = c(0, 3), expand = c(0,0)) +
  # Graphic parameters
  theme_bw() +
  theme(legend.position = "right") +
  labs(x = element_blank(), y = element_blank())

# Paper version
graph_uniq_case_d +
  scale_color_grey(name = bquote(sigma), start = 0, end  = .8) +
  ggsave(file.path(loc_graphic, "uniq-case-d.png"), width = 7, height = 7/3)

# Color version
graph_uniq_case_d +
  scale_color_manual(name = bquote(sigma), values = brewer.pal(8, "Set1")) +
  ggsave(file.path(loc_graphic, "uniq-case-d-color.png"), width = 7, height = 7/3)
```


```{r}
# Ranges
sigma_range = c(1.1, 1.2, 1.3, 1.5, 1.7)
k1 = 1
k2_range = k1*c(1.1, 3, 5)
gamma = 0.5
phi = 0.3

# Interval
inter = seq(0.001, 30, 0.001)

# Empty data frame
result = data.frame(matrix(ncol = 4, nrow = 0)) %>% 
  setNames(c("inter", "sigma", "k2", "value"))

# Loop to compute g function
for(k2 in k2_range){
  for(sigma in sigma_range){
   
   g = function(k, sigma, k1, k2){
      G = log((k/k1-1)/((k/k2)^((sigma-1)/sigma)-1))
      return(G)
   }
   
   h = function(k, sigma, k1, phi, gamma){
     H = (sigma + (1-phi)/phi*(1-gamma*(1-sigma))/gamma*k^((1-sigma)/sigma))^(-1)
     return(H)
   }
   
   result = cbind(inter, sigma, k2, "value" = g(inter, sigma, k1, k2),
                  "value_h" = h(inter, sigma, k1, phi, gamma)) %>% 
     rbind(result)
   
  }
}

result = as.data.frame(result) %>% 
  # subset(inter > k2) %>% 
   mutate(bound = 1/as.numeric(as.character(sigma)),
          violation = ifelse(bound > value, TRUE, FALSE),
          sigma = as.factor(sigma),
          k2 = as.factor(k2))
# Values for all k > k2
result_after = result %>% 
  subset(inter > as.numeric(as.character(k2)))
# Values for all k<= k2
result_before = result %>% 
  subset(inter <= as.numeric(as.character(k2)))

# # Check if g and h intersect
# sum(result_after$violation, na.rm = TRUE) # If =  0, then do not intersect after k2

# Show minimum k on (k2, +infinity)
min_val = result_after %>%  
  group_by(sigma, k2) %>% 
  summarise(min(value), min(bound)) %>% 
  setNames(c("sigma", "k2", "min_k", "min_x"))
# Pull the minimum value of X for each possible couples (sigma, k2)
x_bound = min_val %>% pull("min_x")

## Figure
graph_uniq_case_c = result %>% 
  
  ggplot(aes(x = inter, color = sigma)) +
  # g function
  geom_line(aes(y = value)) +
  # h function
  geom_line(aes(y = value_h), linetype = "dashed") +
  # Limit in +infinity of the h function
  geom_hline(data = min_val, aes(yintercept = x_bound, color = sigma), linetype = "dotted") +
  # Wrap
  facet_wrap(k2 ~ ., labeller = label_bquote(nu == .(as.numeric(as.character(k2))))) +
  # Axis
  scale_x_continuous(breaks = 0, limits = c(0, 10), expand = c(0,0)) +
  scale_y_continuous(breaks = c(0,1), limits = c(0, 5), expand = c(0,0)) +
  # Graphic parameters
  theme_bw() +
  theme(legend.position = "right") +
  labs(x = element_blank(), y = element_blank())


## Paper version
graph_uniq_case_c +
  scale_color_grey(name = bquote(sigma), start = 0, end  = .8) +
  ggsave(file.path(loc_graphic, "uniq-case-c.png"), width = 7, height = 7/3)

# Color version
graph_uniq_case_c +
  scale_color_manual(name = bquote(sigma), values = brewer.pal(8, "Set1")) +
  ggsave(file.path(loc_graphic, "uniq-case-c-color.png"), width = 7, height = 7/3)
```


# Derivatives

# Sigma

```{r}
# Variable modifications
pwt1 = pwt %>%
  subset(Year %in% c(1970:2010)) %>% 
  group_by(Country) %>% 
  mutate(L = emp * 1000, # Labor
         K = rnna * 1000, # Capital
         K.avh = rnna / avh * 1000, # Capital // AVH control
         theta1 = lab_sh1, # Labor share // Adjustment 1
         theta2 = lab_sh2, # Labor share // Adjustment 2
         ) %>% 
  select(Country, Year, avh, L, K, K.avh, theta1, theta2) %>% 
  mutate(avh = avh / first(avh), # Normalized avh
         L = L / first(L), # Normalized labor
         K = K / first(K), # Normalized capital
         K.avh = K.avh / first(K.avh), # Normalized capital // AVH Control
         k = K / L, # Normalized capital-labor ratio
         k.avh = K.avh / L, # Normalized capital-labor ratio // AVH Control
         ) %>% # Normalized old population
  ungroup() %>% 
  # Remove unused countries from Country levels
  mutate(Country = factor(Country))
```

```{r}
# Compare Labor share with adjustment method 1 and 2
pwt1 %>% select(Country, Year, theta1, theta2) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  ggplot(aes(x = Year, y = value, color = variable)) +
  scale_color_discrete(name = "Adjustment Method", breaks = c("lab_sh1", "lab_sh2"),
                       labels = c("1st", "2nd")) +
  geom_line(size = 0.5) +
  facet_wrap(Country ~ .) +
  labs(x = "Year", y = "Labor share") +
  theme_classic(base_size = 14) +
  theme(legend.direction = "horizontal", legend.position = "bottom")
```

```{r}
# Compare normalized capital ratio with and without hours worked
pwt1 %>% select("Country", "Year", "k", "k.avh") %>%
  melt(id.vars = c("Country", "Year")) %>%
  ggplot(aes(x = Year, y = value, color = variable)) +
  geom_line(size = .5) +
  facet_wrap(Country ~ .) +
  scale_color_discrete(name = "", breaks = c("k", "k.avh"),
                       labels = c("Standard", "AVH correction")) +
  labs(x = "Year", y = "Normalized capital-to-labor ratio") +
  theme_classic(base_size = 14) +
  theme(legend.direction = "horizontal", legend.position = "bottom")
```

```{r}
pwt2 = pwt1 %>% 
  group_by(Country) %>% 
  mutate(
         # Compute the income ratio
         THETA1 = theta1/(1-theta1),
         THETA2 = theta2/(1-theta2),
         THETA1.avh = THETA1*avh,
         THETA2.avh = THETA2*avh,
         # Logarithm
         THETA1_log = log(THETA1),
         THETA2_log = log(THETA2),
         THETA1.avh_log = log(THETA1.avh),
         THETA2.avh_log = log(THETA2.avh),
         k_log = log(k),
         k.avh_log = log(k.avh),
         # Time trend
         t_diff = Year - first(Year))
```

```{r}
# Empty list
reg = list()

# Coefficients
coef.map = list(
  "(Intercept)" = "$\\alpha$",
  "CountryUnited States" = "$\\alpha~\\times$ US",
  "k_log" = "$\\beta$",
  "k_log:CountryUnited States" = "$\\beta~\\times$ US",
  "k.avh_log" = "$\\beta$",
  "k.avh_log:CountryUnited States" = "$\\beta~\\times$ US",
  "t_diff" = "$\\gamma$",
  "CountryUnited States:t_diff" = "$\\gamma~\\times$ US"
)
```


```{r est_adjust1}
reg$raw = lm(formula = THETA1_log ~ k_log * Country,
             data = pwt2)
reg$hwc = lm(formula = THETA1_log ~ k.avh_log * Country,
             data = pwt2)
reg$btc = lm(formula = THETA1_log ~ k_log * Country + t_diff*Country, 
             data = pwt2)
reg$both = lm(formula = THETA1_log ~ k.avh_log * Country + t_diff * Country,
              data = pwt2)
```

```{r}
## Compute sigma
# France
sigma$fr = c(1/(1+reg$raw$coefficients["k_log"]),
             1/(1+reg$hwc$coefficients["k.avh_log"]),
             1/(1+reg$btc$coefficients["k_log"]),
             1/(1+reg$both$coefficients["k.avh_log"])
             ) %>% unname()
# United-States
sigma$us = c(1/(1+reg$raw$coefficients["k_log"]+reg$raw$coefficients["k_log:CountryUnited States"]),
             1/(1+reg$hwc$coefficients["k.avh_log"]+reg$hwc$coefficients["k.avh_log:CountryUnited States"]),
             1/(1+reg$btc$coefficients["k_log"]+reg$btc$coefficients["k_log:CountryUnited States"]),
             1/(1+reg$both$coefficients["k.avh_log"]+reg$both$coefficients["k.avh_log:CountryUnited States"])
             ) %>% unname()

sigma = lapply(sigma, function(x){round(x, 3)})
```

```{r est_adjust1}
tabular(reg, coef_map = coef.map,
        gof.row = list(
          "$\\sigma_{FR}$" = c(sigma$fr),
          "$\\sigma_{US}$" = c(sigma$us)
          ),
        digits = 3,
        model_map = c("(RAW)", "(HWC)", "(BTC)", "(HWC-BTC)")) %>% 
  writeLines(., con = "_tabular/sigma-estimate.tex")
```

# Regimes

```{r}
pwt2.fr = pwt2 %>% 
  subset(Country == "France")
```


```{r}
## Core
break_year_graph_1 = pwt2.fr %>%
  select(Country, Year, k.avh_log, THETA1_log) %>% setDT %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, color = variable, linetype = variable)) +
  geom_line() +
  geom_vline(xintercept = 1982, linetype = "dotted", color = "grey") +
  scale_x_continuous(breaks = c(1970, 1980, 1982, 1990, 2000, 2010),
                     labels = c(1970, "", 1982, 1990, 2000, 2010)) +
  theme_classic(base_size = 14) +
  labs(x = "", y = "") +
  theme(legend.position = "none", axis.title.x = element_blank(), axis.title.y = element_blank())

## Paper version
break_year_graph_1 +
  scale_color_grey(start = 0, end = 0) +
  scale_linetype_manual(values = c("solid", "dashed")) +
  ggsave(file.path(loc_graphic, "regime-break.png"), width = 7, height = 7/3)

## Color version
break_year_graph_1 +
  scale_linetype_manual(values = c("solid", "solid")) +
  scale_color_manual(values = brewer.pal(8, "Set1")) +
  ggsave(file.path(loc_graphic, "regime-break-color.png"), width = 7, height = 7/3)
```

```{r break_year_corr_1}
# 1982 included in before
pwt2.fr %>% 
  mutate(period = ifelse(Year <= 1982, "before", "after")) %>% 
  group_by(period) %>% 
  summarise(cor(k.avh_log, THETA1_log))
```

```{r break_year_corr2}
# 1982 included in after
pwt2.fr %>% 
  mutate(period = ifelse(Year < 1982, "before", "after")) %>% 
  group_by(period) %>% 
  summarise(cor(k.avh_log, THETA1_log))

```

```{r break_year_detrend, warnings = FALSE}
# Detrend k
pwt2.fr$k.avh_log_detrend = pwt2.fr %>% 
  lm(k.avh_log ~ t_diff, data = .) %>%
  residuals()

# Detrend THETA
pwt2.fr$THETA1_log_detrend = pwt2.fr %>% 
  lm(THETA1_log ~ t_diff, data = .) %>%
  residuals()

# Plot detrended variables

## Core
graph_detrend = pwt2.fr %>% 
  select(Country, Year, k.avh_log, THETA1_log, 
         k.avh_log_detrend, THETA1_log_detrend) %>% setDT %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  mutate(type = factor(variable, labels = c("raw", "raw", "detrend", "detrend")),
         var = factor(variable, labels = c("k", "THETA", "k", "THETA"))) %>% 
  
  ggplot(aes(x = Year, y = value, color = var, linetype = var)) +
  geom_line() +
  geom_vline(xintercept = 1985, linetype = "solid", color = "black") +
  facet_wrap(. ~ type, scales = "free",
    labeller = labeller(type = c(raw = "Raw data", detrend = "Detrended data"))) +
  theme_bw() +
  labs(x = element_blank(), y = element_blank(), 
       color = element_blank(), linetype = element_blank()) +
  theme(legend.position = "bottom")

## Paper version
graph_detrend +
  scale_color_grey(start = 0, end = 0,
                   labels = c("Capital-to-labor ratio", 
                              "Labor-to-capital income ratio")) +
  scale_linetype_manual(values = c("solid", "dashed"),
                        labels = c("Capital-to-labor ratio",
                                   "Labor-to-capital income ratio")) +
  ggsave(file.path(loc_graphic, "regime-detrend.png"), width = 7, height = 7/2)

## Color version
graph_detrend +
  scale_color_manual(values = brewer.pal(8, "Set1"),
                        labels = c("Capital-to-labor ratio", 
                                   "Labor-to-capital income ratio")) +
  scale_linetype_manual(values = c("solid", "solid"),
                        labels = c("Capital-to-labor ratio", 
                                   "Labor-to-capital income ratio")) +
  ggsave(file.path(loc_graphic, "regime-detrend-color.png"), width = 7, height = 7/2)

```

```{r}
graph_regline = pwt2.fr %>% 
  select(Country, Year, k_raw = k.avh_log, THETA_raw = THETA1_log, 
         k_detrend = k.avh_log_detrend, THETA_detrend = THETA1_log_detrend) %>% 
  setDT %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  tidyr::separate(variable, c("var", "type")) %>% 
  dcast.data.table(Country + Year + type ~ var, value.var = "value") %>% 
  mutate(before_break = factor(ifelse(Year <= 1985, "1970-1985", "1986-2010")),
         type = factor(type, levels = c("raw", "detrend"))) %>% 
  
  ggplot(aes(x = k, y = THETA, color = before_break, shape = before_break)) +
  geom_point(size = 2) +
  stat_smooth(method = "lm", alpha = 0.2) +
  facet_wrap(type ~ ., scale = "free",
    labeller = labeller(type = c(raw = "Raw data", detrend = "Detrended data"))) +
  theme_bw() +
  labs(x = element_blank(), y = element_blank()) +
  theme(legend.position = "bottom")

## Paper version
graph_regline +
  scale_color_grey(name = "", start = 0.1, end = 0.5) +
  scale_shape_manual(name = "", values = c(16, 17)) +
  ggsave(file.path(loc_graphic, "regime-regline.png"), width = 7, height = 7/2)

## Color version
graph_regline +
  scale_color_manual(name = "", values = brewer.pal(8, "Set1")[c(3,4)]) +
  scale_shape_manual(name = "", values = c(16, 17)) +
  ggsave(file.path(loc_graphic, "regime-regline-color.png"), width = 7, height = 7/2)
```

```{r break_year_optimal_splitter}
split.coef = data.frame(matrix(nrow = 0, ncol = 6))
split.R2 = data.frame(matrix(nrow = 0, ncol = 2))

# Loop to analysis splitters
for(splitter in c(1975:1995)){
  
  est_sigma.fr = pwt2.fr %>% 
    mutate(after_split = ifelse(Year > splitter, 1, 0),
           before_split = ifelse(Year <= splitter, 1, 0))
  
  # Break
  ols.france_dummy = est_sigma.fr %>% 
    lm(THETA1_log_detrend ~ k.avh_log_detrend*before_split + k.avh_log_detrend*after_split - 1 -
         k.avh_log_detrend, data = .)
  ols.france_dummy = summary(ols.france_dummy)
  
  ## Gather results
  # Coefs
  split.coef = split.coef %>%
    rbind(data.frame(splitter,
                     var = ols.france_dummy$coefficients %>% row.names(),
                     ols.france_dummy$coefficients,
                     row.names = NULL))
  # R^2
  split.R2 = split.R2 %>% 
    rbind(data.frame(splitter, R2 = ols.france_dummy$r.squared))
}

# Sort data
split.coef = split.coef %>% 
  setNames(c("splitter", "variable", "estimate", "se", "tvalue", "pvalue")) %>% 
  mutate(star = ifelse(pvalue > 0.1, NA,
                       ifelse(pvalue > 0.05, "*",
                              ifelse(pvalue > 0.01, "**", "***"))))
```


```{r break_year_optimal_splitter_coef}
# R2
split.R2 = split.R2 %>% 
  mutate(
    variable = "estimate",
    R2 = sprintf("%.3f", R2)
    )

# Coefficients
split.coef = split.coef %>% 
  mutate(
    estimate = ifelse(!is.na(star), 
                      paste0(sprintf("%.3f", estimate), "^{", star, "}"), 
                      sprintf("%.3f", estimate)),
    se = paste0("(", sprintf("%.3f", se), ")"),
    ) %>% 
  select(splitter, var = variable, estimate, se) %>%  setDT %>% 
  melt(id.vars = c("splitter", "var")) %>% 
  dcast(splitter + variable ~ var, value.var = "value") %>% 
  merge(split.R2, by = c("splitter", "variable"), all.x = T) %>% 
  # Select years to show
  subset(splitter %in% c(1980:1990)) %>% 
  mutate(splitter = c(rbind(unique(splitter), NA))) %>% 
  select(-variable) %>% 
  select(splitter, nu1 = before_split, nu2 = after_split,
         rho1 = "k.avh_log_detrend:before_split", 
         rho2 = "k.avh_log_detrend:after_split", R2)
```


```{r break_year_optimal_splitter_coef}
options(knitr.kable.NA = '') # Fill NA with blank
# Table infos
split_table_col.names = c("$\\bar{t}$", "\\multicolumn{1}{c}{$\\nu_1$}", "\\multicolumn{1}{c}{$\\nu_2$}", "\\multicolumn{1}{c}{$\\rho_1$}",
                          "\\multicolumn{1}{c}{$\\rho_2$}", "\\multicolumn{1}{c}{$R^2$}")
  

# Save table in TeX format
split.coef %>% 
  kable(format = "latex", col.names = split_table_col.names, 
        booktabs = TRUE, linesep = "", escape = FALSE) %>% 
  strsplit("\n") %>% 
  unlist %>% 
  {.[-c(1:2)]} %>% 
  c("\\begin{tabular}{c D{.}{.}{-3} D{.}{.}{-3} D{.}{.}{-3} D{.}{.}{-3} D{.}{.}{-3}}", .) %>% 
  writeLines(., con = "_tabular/regime-split.tex", sep = "\n")


# HTML format
split.coef %>% 
  kable(col.names = split_table_col.names) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = FALSE) %>% 
  row_spec(0, bold=TRUE) 
  
```

```{r}
# Break year
break_year = 1985

# Empty list
reg2 = list()

# Coefficients
coef.map2 = list(
  "(Intercept)" = "$\\alpha$",
  "k.avh_log" = "$\\beta$",
  "t_diff" = "$\\gamma$"
)
```


```{r est_adjust1}
reg2$p1_hwc = lm(formula = THETA1_log ~ k.avh_log, data = pwt2.fr, subset = Year <= break_year)
reg2$p1_both = lm(formula = THETA1_log ~ k.avh_log + t_diff, data = pwt2.fr, subset = Year <= break_year)
reg2$p2_hwc = lm(formula = THETA1_log ~ k.avh_log, data = pwt2.fr, subset = Year > break_year)
reg2$p2_both = lm(formula = THETA1_log ~ k.avh_log + t_diff, data = pwt2.fr, subset = Year > break_year)
```

```{r}
## Compute sigma
# France
sigma2 = c(1/(1+reg2$p1_hwc$coefficients["k.avh_log"]),
             1/(1+reg2$p1_both$coefficients["k.avh_log"]),
             1/(1+reg2$p2_hwc$coefficients["k.avh_log"]),
             1/(1+reg2$p2_both$coefficients["k.avh_log"])
             ) %>% unname()

sigma2 = lapply(sigma2, function(x){round(x, 3)})
```

```{r est_adjust1}
tabular(reg2, coef_map = coef.map2,
        gof.row = list(
          "$\\sigma_{FR}$" = c(sigma2)
          ),
        digits = 3,
        group.models = list("1970-1985" = 1:2, "1986-2010" = 3:4),
        model_map = c("(HWC)", "(HWC-BTC)", "(HWC)", "(HWC-BTC)")) %>% 
  writeLines(., con = "_tabular/regime-estimate.tex")
```















