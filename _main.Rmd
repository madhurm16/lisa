---
title: "Appendix A"
author: "Fabien Petit"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output: 
  github_document:	
    pandoc_args: --webtex
---

This notebook refers to the Appendix A **"Uniqueness of the equilibrium"**. All the graphs used in the appendix are generated in this notebook.

```{r init, results = "hide", message = FALSE}

# Load packages
packages <- c("dplyr", "ggplot2", "ggrepel", "RColorBrewer", "reshape2", "extrafont")
lapply(packages, require, character.only = TRUE)
rm(packages)

# Define paths
loc_appA = file.path(getwd(), "result", "appendix_A")

# Graphic parameter
scale_graph = 1920/1080
red = brewer.pal(8, "Set1")[1]

```

## Shapes of the g function

```{r g_function_define}

g = function(k, sigma, ks){
  
  k1 = ks[1]
  k2 = ks[2]
  
  G = log((k/k1-1)/((k/k2)^((sigma-1)/sigma)-1))
  return(G)
}

```

```{r g_function_generate, warning = FALSE}

# Create a dataframe with only x values
df = data.frame("inter" = seq(0, 10, length.out = 10000))

# 4 cases
sigmas = c(0.8, 1.2)
ks = list(c(1, 2), c(2,1))

# Generate g function for each cases
df = df %>% 
  mutate(g1 = g(inter, sigmas[1], ks[[1]]),
         g2 = g(inter, sigmas[1], ks[[2]]),
         g3 = g(inter, sigmas[2], ks[[1]]),
         g4 = g(inter, sigmas[2], ks[[2]])) %>% 
  melt(id.vars = "inter")

```

```{r g_function_graph_a, warning = FALSE}

## Core
g_function_graph_a = df %>%
  subset(variable == "g1") %>% 
  
  ggplot(aes(x = inter, y = value)) +
  geom_hline(yintercept = 0) +
  scale_x_continuous(name = "", breaks = c(0, 1, 2), labels = c(0, expression(k[1]), expression(k[2])),
                     limits = c(0,3), expand = c(0,0)) + 
  scale_y_continuous(name = "", breaks = 0, labels = 0,
                      limits = c(-1.5,3.5), expand = c(0,0)) +
  theme_classic(base_size = 14) +
  theme(axis.line.x = element_blank(), axis.ticks.x = element_blank())

## Paper version
g_function_graph_a +
  geom_line(color = "black") +
  geom_vline(xintercept = 1, color = "black", linetype = "dashed", alpha = 0.5) +
  geom_vline(xintercept = 2, color = "black", linetype = "dashed", alpha = 0.5) +
  ggsave(file.path(loc_appA, "function_g", "graph_a.png"), width = 7, height = 7*2/3)

## Color version
g_function_graph_a +
  geom_line(color = red) +
  geom_vline(xintercept = 1, color = red, linetype = "dashed", alpha = 0.5) +
  geom_vline(xintercept = 2, color = red, linetype = "dashed", alpha = 0.5) +
  ggsave(file.path(loc_appA, "function_g", "graph_a_color.png"), width = 7, height = 7*2/3)

```

```{r g_function_graph_b, warning = FALSE}

## Core
g_function_graph_b = df %>%
  subset(variable == "g2") %>% 
  
  ggplot(aes(x = inter, y = value)) +
  geom_hline(yintercept = 0) +
  scale_x_continuous(name = "", breaks = c(0, 1, 2), labels = c(0, expression(k[2]), expression(k[1])),
                     limits = c(0,3), expand = c(0,0)) + 
  scale_y_continuous(name = "", breaks = 0, labels = 0,
                      limits = c(-1.5,3.5), expand = c(0,0)) +
  theme_classic(base_size = 14) +
  theme(axis.line.x = element_blank(), axis.ticks.x = element_blank())

## Paper version
g_function_graph_b +
  geom_line(color = "black") +
  geom_vline(xintercept = 1, color = "black", linetype = "dashed", alpha = 0.5) +
  geom_vline(xintercept = 2, color = "black", linetype = "dashed", alpha = 0.5) +
  ggsave(file.path(loc_appA, "function_g", "graph_b.png"), width = 7, height = 7*2/3)

## Color version
g_function_graph_b +
  geom_line(color = red) +
  geom_vline(xintercept = 1, color = red, linetype = "dashed", alpha = 0.5) +
  geom_vline(xintercept = 2, color = red, linetype = "dashed", alpha = 0.5) +
  ggsave(file.path(loc_appA, "function_g", "graph_b_color.png"), width = 7, height = 7*2/3)

```

```{r g_function_graph_c, warning = FALSE}

## Core
g_function_graph_c = df %>%
  subset(variable == "g3") %>% 
  
  ggplot(aes(x = inter, y = value)) +
  geom_hline(yintercept = 0) +
  scale_x_continuous(name = "", breaks = c(0, 1, 2), labels = c(0, expression(k[1]), expression(k[2])),
                     limits = c(0,7), expand = c(0,0)) + 
  scale_y_continuous(name = "", breaks = 0, labels = 0,
                      limits = c(-2,5), expand = c(0,0)) +
  coord_cartesian() + 
  theme_classic(base_size = 14) +
  theme(axis.line.x = element_blank(), axis.ticks.x = element_blank())

## Paper version
g_function_graph_c +
  geom_line(color = "black") +
  geom_vline(xintercept = 1, color = "black", linetype = "dashed", alpha = 0.5) +
  geom_vline(xintercept = 2, color = "black", linetype = "dashed", alpha = 0.5) +
  ggsave(file.path(loc_appA, "function_g", "graph_c.png"), width = 7, height = 7*2/3)
  
## Color version
g_function_graph_c +
  geom_line(color = red) +
  geom_vline(xintercept = 1, color = red, linetype = "dashed", alpha = 0.5) +
  geom_vline(xintercept = 2, color = red, linetype = "dashed", alpha = 0.5) +
  ggsave(file.path(loc_appA, "function_g", "graph_c_color.png"), width = 7, height = 7*2/3)

```

```{r g_function_graph_d, warning = FALSE}

## Core
g_function_graph_d = df %>%
  subset(variable == "g4") %>% 
  
  ggplot(aes(x = inter, y = value)) +
  geom_hline(yintercept = 0) +
  scale_x_continuous(name = "", breaks = c(0, 1, 2), labels = c(0, expression(k[2]), expression(k[1])),
                     limits = c(0,7), expand = c(0,0)) + 
  scale_y_continuous(name = "", breaks = 0, labels = 0,
                      limits = c(-2,5), expand = c(0,0)) +
  coord_cartesian() + 
  theme_classic(base_size = 14) +
  theme(axis.line.x = element_blank(), axis.ticks.x = element_blank())

## Paper version
g_function_graph_d +
  geom_line(color = "black") +
  geom_vline(xintercept = 1, color = "black", linetype = "dashed", alpha = 0.5) +
  geom_vline(xintercept = 2, color = "black", linetype = "dashed", alpha = 0.5) +
  ggsave(file.path(loc_appA, "function_g", "graph_d.png"), width = 7, height = 7*2/3)

## Color version
g_function_graph_d +
  geom_line(color = red) +
  geom_vline(xintercept = 1, color = red, linetype = "dashed", alpha = 0.5) +
  geom_vline(xintercept = 2, color = red, linetype = "dashed", alpha = 0.5) +
  ggsave(file.path(loc_appA, "function_g", "graph_d_color.png"), width = 7, height = 7*2/3)

```

## Shapes of the h function

```{r h_function_define, echo = FALSE}

h = function(k, sigma, phi, gamma){
  H = (sigma + (1-phi)/phi * (1-gamma*(1-sigma))/gamma * k^((1-sigma)/sigma))^(-1)
  return(H)
}

```

```{r h_function_generate, warning = FALSE}
# Interval vector
inter = seq(0.001, 100, by = 0.001)

# 3 cases
sigmas = c(0.25, 0.8, 1.2)
phi = 0.3 # Average value of phi for France and the United-States
gamma = 0.5 # Value from calibration

# Empty data frame
df = data.frame(matrix(ncol = 3, nrow = 0)) %>% 
  setNames(c("inter", "sigma", "value"))

# Loop
for(i in c(1:3)){
    
    df = cbind(inter, "sigma" = sigmas[i], "value" = h(inter, sigmas[i], phi, gamma)) %>% 
      as.data.frame() %>% 
      rbind(df)
    
}
```

```{r h_function_graph_1, warning = FALSE}

# Value of sigma in this case
sigma_1 = 0.25

## Core
h_function_graph_1 = df %>% 
  subset(sigma == 0.25) %>% 
  
  ggplot(aes(x = inter, y = value)) +
  scale_x_continuous(name = "", breaks = 0, labels = 0, limits = c(0, 1.5), expand = c(0,0)) +
  scale_y_continuous(name = "", breaks = c(0, 1/sigma_1), labels = c(0, expression(frac(1,sigma))),
                     limits = c(0, 1/sigma_1*1.05), expand = c(0,0)) +
  theme_classic(base_size = 14)

## Paper version
h_function_graph_1 +
  geom_line(color = "black") +
  geom_hline(yintercept = 1/sigma_1, linetype = "dashed", color = "black", alpha = 0.5) +
  ggsave(file.path(loc_appA, "function_h", "graph_1.png"), width = 5, height = 5)

## Color version
h_function_graph_1 +
  geom_line(color = red) +
  geom_hline(yintercept = 1/sigma_1, linetype = "dashed", color = red, alpha = 0.5) +
  ggsave(file.path(loc_appA, "function_h", "graph_1_color.png"), width = 5, height = 5)
  

```

```{r h_function_graph_2, warning = FALSE}

# Value of sigma in this case
sigma_2 = 0.8

## Core
h_function_graph_2 = df %>% 
  subset(sigma == sigma_2) %>% 
  
  ggplot(aes(x = inter, y = value)) +
  scale_x_continuous(name = "", breaks = 0, labels = 0, limits = c(0, 1.5), expand = c(0,0)) +
  scale_y_continuous(name = "", breaks = c(0, 1/sigma_2), labels = c(0, expression(frac(1,sigma))),
                     limits = c(0, 1/sigma_2*1.05), expand = c(0,0)) +
  theme_classic(base_size = 14)

## Paper version
h_function_graph_2 +
  geom_line(color = "black") +
  geom_hline(yintercept = 1/sigma_2, linetype = "dashed", color = "black", alpha = 0.5) +
  ggsave(file.path(loc_appA, "function_h", "graph_2.png"), width = 5, height = 5)
  
## Color version
h_function_graph_2 +
  geom_line(color = red) +
  geom_hline(yintercept = 1/sigma_2, linetype = "dashed", color = red, alpha = 0.5) +
  ggsave(file.path(loc_appA, "function_h", "graph_2_color.png"), width = 5, height = 5)

```

```{r h_function_graph_3, warning = FALSE}

# Value of sigma in this case
sigma_3 = 1.2

## Core
h_function_graph_3 = df %>% 
  subset(sigma == sigma_3) %>% 
  
  ggplot(aes(x = inter, y = value)) +
  scale_x_continuous(name = "", breaks = 0, labels = 0, limits = c(0, 1.5), expand = c(0,0)) +
  scale_y_continuous(name = "",
                     breaks = c(0, 1/sigma_3), labels = c(0, expression(frac(1,sigma))),
                     limits = c(0, 1/sigma_3*1.05), expand = c(0,0)) +
  theme_classic(base_size = 14)

## Paper version
h_function_graph_3 +
  geom_line(color = "black") +
  geom_hline(yintercept = 1/sigma_3, linetype = "dashed", color = "black", alpha = 0.5) +
  ggsave(file.path(loc_appA, "function_h", "graph_3.png"), width = 5, height = 5)

## Color version
h_function_graph_3 +
  geom_line(color = red) +
  geom_hline(yintercept = 1/sigma_3, linetype = "dashed", color = red, alpha = 0.5) +
  ggsave(file.path(loc_appA, "function_h", "graph_3_color.png"), width = 5, height = 5)

```

## Uniqueness of the equilibrium in case c)

```{r uniqc_generate_violation, warning = FALSE}
# Ranges
sigma_range = c(1.1, 1.2, 1.3, 1.5, 1.7)
k1 = 1
k2_range = k1*c(1.1, 3, 5)
gamma = 0.5
phi = 0.3

# Interval
inter = seq(0.001, 30, 0.001)

# Empty data frame
result = data.frame(matrix(ncol = 4, nrow = 0)) %>% 
  setNames(c("inter", "sigma", "k2", "value"))

# Loop to compute g function
for(k2 in k2_range){
  for(sigma in sigma_range){
   
   g = function(k, sigma, k1, k2){
      G = log((k/k1-1)/((k/k2)^((sigma-1)/sigma)-1))
      return(G)
   }
   
   h = function(k, sigma, k1, phi, gamma){
     H = (sigma + (1-phi)/phi*(1-gamma*(1-sigma))/gamma*k^((1-sigma)/sigma))^(-1)
     return(H)
   }
   
   result = cbind(inter, sigma, k2, "value" = g(inter, sigma, k1, k2),
                  "value_h" = h(inter, sigma, k1, phi, gamma)) %>% 
     rbind(result)
   
  }
}

result = as.data.frame(result)

# Compute bound and violation as a logic variable
result = result %>% 
  # subset(inter > k2) %>% 
   mutate(bound = 1/as.numeric(as.character(sigma)),
          violation = ifelse(bound > value, TRUE, FALSE),
          sigma = as.factor(sigma),
          k2 = as.factor(k2))

# Values for all k > k2
result_after = result %>% 
  subset(inter > as.numeric(as.character(k2)))

# Values for all k<= k2
result_before = result %>% 
  subset(inter <= as.numeric(as.character(k2)))

# Check if g and h intersect
sum(result_after$violation, na.rm = TRUE) # If =  0, then do not intersect after k2
```


```{r uniqc_minvalue, warning = FALSE}
# Show minimum k on (k2, +infinity)
min_val = result_after %>%  
  group_by(sigma, k2) %>% 
  summarise(min(value), min(bound)) %>% 
  setNames(c("sigma", "k2", "min_k", "min_x"))
min_val
```


```{r uniqc_graph_1, warning = FALSE}
# Pull the minimum value of X for each possible couples (sigma, k2)
x_bound = min_val %>% pull("min_x")

## Core
uniqc_graph_1 = result_after %>%  
  
  ggplot(aes(x = inter, y = value)) +
  geom_line(aes(color = sigma)) +
  # Limit in +infinity of the h function
  geom_hline(data = min_val, aes(yintercept = x_bound, color = sigma), linetype = "dashed") +
  # Wrap
  facet_wrap(k2 ~ ., labeller = label_bquote(nu == .(as.numeric(as.character(k2))))) +
  # Axis
  scale_x_continuous(breaks = 0, limits = c(0, 10), expand = c(0,0)) +
  scale_y_continuous(breaks = c(0,1), limits = c(0, 5), expand = c(0,0)) +
  # Graphic parameters
  theme_classic(base_size = 14) +
  theme(legend.position = "right") +
  labs(x = "", y = "")

## Paper version
uniqc_graph_1 +
  scale_color_grey(name = bquote(sigma), start = 0.2, end = 0.8) +
  ggsave(file.path(loc_appA, "uniqueness", "gc_after.png"), width = scale_graph*5, height = scale_graph*5/3)

## Color version
uniqc_graph_1 +
  scale_color_manual(name = bquote(sigma), values = brewer.pal(8, "Set1")) +
  ggsave(file.path(loc_appA, "uniqueness", "gc_after_color.png"), width = scale_graph*5, height = scale_graph*5/3)

```

```{r uniqc_graph_2, warning = FALSE}

uniqc_graph_2 = result_before %>% 
  
  ggplot(aes(x = inter, y = value)) +
  geom_line(aes(color = sigma)) +
  # Limit in +infinity of the h function (not very useful on this graph)
  geom_hline(data = min_val, aes(yintercept = x_bound, color = sigma), linetype = "dashed") +
  # Wrap
  facet_wrap(k2 ~ ., labeller = label_bquote(nu == .(as.numeric(as.character(k2))))) +
  # Axis
  scale_x_continuous(breaks = c(0,1), limits = c(0, 1), expand = c(0,0)) +
  scale_y_continuous(breaks = c(0,1), limits = c(0, 2), expand = c(0,0)) +
  # Graphic parameters
  theme_classic(base_size = 14) +
  theme(legend.position = "right") +
  labs(x = "", y = "")

## Paper version
uniqc_graph_2 +
  scale_color_grey(name = bquote(sigma), start = 0.2, end  = 0.8) +
  ggsave(file.path(loc_appA, "uniqueness", "gc_before.png"), width = scale_graph*5, height = scale_graph*5/3)

## Color version
uniqc_graph_2 +
  scale_color_manual(name = bquote(sigma), values = brewer.pal(8, "Set1")) +
  ggsave(file.path(loc_appA, "uniqueness", "gc_before_color.png"), width = scale_graph*5, height = scale_graph*5/3)

```


```{r uniqc_graph_3, warning = FALSE}

## Core
uniqc_graph_3 = result_before %>% 
  
  ggplot(aes(x = inter, color = sigma)) +
  # g function
  geom_line(aes(y = value)) +
  # h function
  geom_line(aes(y = value_h), linetype = "dashed") +
  # Limit in +infinity of the h function
  geom_hline(data = min_val, aes(yintercept = x_bound, color = sigma), linetype = "dotted") +
  # Wrap
  facet_wrap(k2 ~ ., labeller = label_bquote(nu == .(as.numeric(as.character(k2))))) +
  # Axis
  scale_x_continuous(breaks = c(0,1), limits = c(0, 1), expand = c(0,0)) +
  scale_y_continuous(breaks = c(0,1), limits = c(0, 2), expand = c(0,0)) +
  # Graphic parameters
  theme_classic(base_size = 14) +
  theme(legend.position = "right") +
  labs(x = "", y = "")

## Paper version
uniqc_graph_3 +
  scale_color_grey(name = bquote(sigma), start = 0.2, end = 0.8) +
  ggsave(file.path(loc_appA, "uniqueness", "gc_before_all.png"), width = scale_graph*5, height = scale_graph*5/3)

## Color version
uniqc_graph_3 +
  scale_color_manual(name = bquote(sigma), values = brewer.pal(8, "Set1")) +
  ggsave(file.path(loc_appA, "uniqueness", "gc_before_all_color.png"), width = scale_graph*5, height = scale_graph*5/3)

```


```{r uniqc_graph_4, warning = FALSE}

## Core
uniqc_graph_4 = result %>% 
  
  ggplot(aes(x = inter, color = sigma)) +
  # g function
  geom_line(aes(y = value)) +
  # h function
  geom_line(aes(y = value_h), linetype = "dashed") +
  # Limit in +infinity of the h function
  geom_hline(data = min_val, aes(yintercept = x_bound, color = sigma), linetype = "dotted") +
  # Wrap
  facet_wrap(k2 ~ ., labeller = label_bquote(nu == .(as.numeric(as.character(k2))))) +
  # Axis
  scale_x_continuous(breaks = 0, limits = c(0, 10), expand = c(0,0)) +
  scale_y_continuous(breaks = c(0,1), limits = c(0, 5), expand = c(0,0)) +
  # Graphic parameters
  theme_classic(base_size = 14) +
  theme(legend.position = "right") +
  labs(x = "", y = "")

## Paper version
uniqc_graph_4 +
  scale_color_grey(name = bquote(sigma), start = 0.2, end = 0.8) +
  ggsave(file.path(loc_appA, "uniqueness", "gc_all.png"), width = scale_graph*5, height = scale_graph*5/3)

## Core version
uniqc_graph_4 +
  scale_color_manual(name = bquote(sigma), values = brewer.pal(8, "Set1")) +
  ggsave(file.path(loc_appA, "uniqueness", "gc_all_color.png"), width = scale_graph*5, height = scale_graph*5/3)

```

## Uniqueness of the equilibrium in case d)

```{r uniqd_generate_violation, warning = FALSE}
# Ranges
sigma_range = c(1.1, 1.2, 1.3, 1.5, 1.7)
k1 = 1
k2_range = k1*c(0.3, 0.6, 0.9)
gamma = 0.5
phi = 0.3

# Interval
inter = seq(0.001, 30, 0.001)

# Empty data frame
result = data.frame(matrix(ncol = 4, nrow = 0)) %>% 
  setNames(c("inter", "sigma", "k2", "value"))

# Loop to compute g function
for(k2 in k2_range){
  for(sigma in sigma_range){
   
   g = function(k, sigma, k1, k2){
      G = log((k/k1-1)/((k/k2)^((sigma-1)/sigma)-1))
      return(G)
   }
   
   h = function(k, sigma, k1, phi, gamma){
     H = (sigma + (1-phi)/phi*(1-gamma*(1-sigma))/gamma*k^((1-sigma)/sigma))^(-1)
     return(H)
   }
   
   result = cbind(inter, sigma, k2, "value" = g(inter, sigma, k1, k2),
                  "value_h" = h(inter, sigma, k1, phi, gamma)) %>% 
     rbind(result)
   
  }
}

result = as.data.frame(result)

# Compute bound and violation logic
result = result %>% 
  # subset(inter > k2) %>% 
   mutate(bound = 1/as.numeric(as.character(sigma)),
          violation = ifelse(bound > value, TRUE, FALSE),
          h_over_g = ifelse(value < value_h, TRUE, FALSE),
          sigma = as.factor(sigma),
          k2 = as.factor(k2))

result_after = result %>% 
  subset(inter > as.numeric(as.character(k2)))

result_before = result %>% 
  subset(inter <= as.numeric(as.character(k2)))

# Check if g and h intersect
sum(result_after$h_over_g, na.rm = TRUE) # If =  0, then do not intersect after k2
```

```{r uniqd_minvalue, warning = FALSE}
# Show minimum k on (k2, +infinity)
min_val = result_after %>%  
  group_by(sigma, k2) %>% 
  summarise(min(value), min(bound)) %>% 
  setNames(c("sigma", "k2", "min_k", "min_x"))
min_val

x_bound = min_val %>% pull("min_x")
```

```{r uniqd_graph, warning = FALSE}

## Core
uniqd_graph = result %>% 
  
  ggplot(aes(x = inter, color = sigma)) +
  # g function
  geom_line(aes(y = value)) +
  # h function
  geom_line(aes(y = value_h), linetype = "dashed") +
  # Limit in +infinity of the h function
  geom_hline(data = min_val, aes(yintercept = x_bound, color = sigma), linetype = "dotted") +
  # Wrap
  facet_wrap(k2 ~ ., labeller = label_bquote(nu == .(as.numeric(as.character(k2))))) +
  # Axis
  scale_x_continuous(breaks = 0, limits = c(0, 10), expand = c(0,0)) +
  scale_y_continuous(breaks = c(0,1), limits = c(0, 5), expand = c(0,0)) +
  # Graphic parameters
  theme_classic(base_size = 14) +
  theme(legend.position = "right") +
  labs(x = "", y = "")

## Paper version
uniqd_graph +
  scale_color_grey(name = bquote(sigma), start = 0.2, end  = 0.8) +
  ggsave(file.path(loc_appA, "uniqueness", "gd_all.png"), width = scale_graph*5, height = scale_graph*5/3)

## Color version
uniqd_graph +
  scale_color_manual(name = bquote(sigma), values = brewer.pal(8, "Set1")) +
  ggsave(file.path(loc_appA, "uniqueness", "gd_all_color.png"), width = scale_graph*5, height = scale_graph*5/3)

```

<!--chapter:end:appendix_A.Rmd-->

---
title: "Appendix CD"	
author: "Fabien Petit"	
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output:	
  github_document:	
    pandoc_args: --webtex
---

This notebook refers to the Appendix C **"Estimation of σ"** and the Appendix D **"Two σ regimes in France "**. All the graphs used in these appendices are generated in this notebook.

```{r init, results = "hide", message = FALSE}	

# Load packages
packages <- c("dplyr", "ggplot2", "RColorBrewer", "reshape2", "bucky", "sandwich")
lapply(packages, require, character.only = TRUE)
rm(packages)

# Define paths
loc_final = file.path("data", "final")
loc_appCD = file.path(getwd(), "result", "appendix_CD")

# Define country set
country_set = c("France", "United States")

# Graphic parameter
scale_graph = 1920/1080
red = brewer.pal(8, "Set1")[1]

```	

## Methodology

I estimate the elasticity of substitution between capital and labor with a single-equation from the two first-order conditions of the profit maximization. Estimation are done for France and United States between 1970 and 2010, using Penn World Table 9.1 data.

I estimate the following equation :	
<center>
$$\ln \Theta_t = \alpha + \frac{1-\sigma}{\sigma} \ln k_t + \frac{1-\sigma}{\sigma} \left( a_K-a_L\right)t + \varepsilon_t$$
</center>
Therefore, I need to compute the capital-to-labor ratio $~k_t~$ and the capital-to-labor income ratio $~\Theta_t~$.

## Data

```{r load_data}

# Penn World Table
df = read.csv(file.path(loc_final, "pwt.csv"), header = TRUE) %>%
  select("Country", "Year", "emp", "avh", "rgdpna", "rnna", "lab_sh1", "lab_sh2") %>% 
  subset(Country %in% country_set & Year >= 1970)

# Variable modifications
df = df %>%
  subset(Year %in% c(1970:2010)) %>% 
  group_by(Country) %>% 
  mutate(L = emp * 1000, # Labor
         K = rnna * 1000, # Capital
         K.avh = rnna / avh * 1000, # Capital // AVH control
         theta1 = lab_sh1, # Labor share // Adjustment 1
         theta2 = lab_sh2, # Labor share // Adjustment 2
         ) %>% 
  select(Country, Year, avh, L, K, K.avh, theta1, theta2) %>% 
  mutate(avh = avh / first(avh), # Normalized avh
         L = L / first(L), # Normalized labor
         K = K / first(K), # Normalized capital
         K.avh = K.avh / first(K.avh), # Normalized capital // AVH Control
         k = K / L, # Normalized capital-labor ratio
         k.avh = K.avh / L, # Normalized capital-labor ratio // AVH Control
         ) %>% # Normalized old population
  ungroup()

# Remove unused countries from Country levels
df$Country = df$Country %>% as.character %>% as.factor()

# Visualization
head(df)
 
```	

The variables from the **Penn World Table 9.1** are the following :	

* *emp* : Number of persons engaged (in millions)	
* *avh* : Average annual hours worked by persons engaged
* *rnna* : Capital stock at constant 2011 national prices (in mil. 2011 US$)	
* *lab_sh1* : Share of labour compensation in GDP at current national prices (**Adjustment method 1**)
* *lab_sh2* : Share of labour compensation in GDP at current national prices (**Adjustment method 2**)

```{r compare_both_ls}

df %>% select(Country, Year, theta1, theta2) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  ggplot(aes(x = Year, y = value, color = variable)) +
  scale_color_discrete(name = "Adjustment Method", breaks = c("lab_sh1", "lab_sh2"),
                       labels = c("1st", "2nd")) +
  geom_line(size = 0.5) +
  facet_wrap(Country ~ .) +
  labs(x = "Year", y = "Labor share") +
  theme_classic(base_size = 14) +
  theme(legend.direction = "horizontal", legend.position = "bottom")

```

I use the first adjustment method (see **Frenstra, Inklaar and Timmer 2015** and **Gollin 2002** for more details). An adjustment method is required to take into account self-employed income.

**Adjustment 1** adds mixed income (MIX) to the compensation of employees (COMP). Thus,
<center>
$$LS = \frac{COMP+MIX}{GDP}$$
</center>

**Adjustment 2** assumes the same labor share for mixed income as for the rest of the economy. Thus,
<center>
$$LS = \frac{COMP}{GDP-MIX}$$
</center>

In the model, workers are only young individuals and provide only labor supply. Therefore, I assume that self-employed people earn an income that is characterized as a compensation. Hence, I will use the first adjustment method. I normalize the capital-to-labor ratio to the initial year (i.e. 1970).

```{r plot_k_normalized}

df %>% select("Country", "Year", "k", "k.avh") %>%
  melt(id.vars = c("Country", "Year")) %>%
  ggplot(aes(x = Year, y = value, color = variable)) +
  geom_line(size = .5) +
  facet_wrap(Country ~ .) +
  scale_color_discrete(name = "", breaks = c("k", "k.avh"),
                       labels = c("Standard", "AVH correction")) +
  labs(x = "Year", y = "Normalized capital-to-labor ratio") +
  theme_classic(base_size = 14) +
  theme(legend.direction = "horizontal", legend.position = "bottom")
  
```	

```{r computation}

df = df %>% 
  group_by(Country) %>% 
  mutate(
         # Compute the income ratio
         THETA1 = theta1/(1-theta1),
         THETA2 = theta2/(1-theta2),
         THETA1.avh = THETA1*avh,
         THETA2.avh = THETA2*avh,
         # Logarithm
         THETA1_log = log(THETA1),
         THETA2_log = log(THETA2),
         THETA1.avh_log = log(THETA1.avh),
         THETA2.avh_log = log(THETA2.avh),
         k_log = log(k),
         k.avh_log = log(k.avh),
         # Time trend
         t_diff = Year - first(Year))

```

## Appendix C - Estimation of σ

```{r est_adjust1}

ols1.raw = df %>% 
  lm(formula = THETA1_log ~ Country + k_log*Country - 1 - k_log)
ols1.raw %>% summary()
sigma1.raw = 1/(1 + ols1.raw$coefficients[c(3,4)])

ols1.hwc = df %>% 
  lm(formula = THETA1_log ~ Country + k.avh_log*Country - 1 - k.avh_log)
ols1.hwc %>% summary()
sigma1.hwc = 1/(1 + ols1.hwc$coefficients[c(3,4)])

ols1.btc = df %>% 
  lm(formula = THETA1_log ~ Country + k_log*Country + t_diff*Country - 1 - k_log - t_diff)
ols1.btc %>% summary()
sigma1.btc = 1/(1 + ols1.btc$coefficients[c(3,4)])

ols1.both = df %>% 
  lm(formula = THETA1_log ~ Country + k.avh_log*Country + t_diff*Country - 1 - k.avh_log - t_diff)
ols1.both %>% summary()
sigma1.both = 1/(1 + ols1.both$coefficients[c(3,4)])

```

```{r est_adjust2}

ols2.raw = df %>% 
  lm(formula = THETA2_log ~ Country + k_log*Country - 1 - k_log)
ols2.raw %>% summary()
sigma2.raw = 1/(1 + ols2.raw$coefficients[c(3,4)])

ols2.hwc = df %>% 
  lm(formula = THETA2_log ~ Country + k.avh_log*Country - 1 - k.avh_log)
ols2.hwc %>% summary()
sigma2.hwc = 1/(1 + ols2.hwc$coefficients[c(3,4)])

ols2.btc = df %>% 
  lm(formula = THETA2_log ~ Country + k_log*Country + t_diff*Country - 1 - k_log - t_diff)
ols2.btc %>% summary()
sigma2.btc = 1/(1 + ols2.btc$coefficients[c(3,4)])

ols2.both = df %>% 
  lm(formula = THETA2_log ~ Country + k.avh_log*Country + t_diff*Country - 1 - k.avh_log - t_diff)
ols2.both %>% summary()
sigma2.both = 1/(1 + ols2.both$coefficients[c(3,4)])

```

```{r gather_results, warning = FALSE}

data.frame(sigma1.raw, sigma1.hwc, sigma1.btc, sigma1.both,
           sigma2.raw, sigma2.hwc, sigma2.btc, sigma2.both)


```

## Appendix D - Two σ regimes in France

The purpose of this section is to investigate whether there is a break in the estimated elasticity of substitution. In particular for France. Indeed, there capital-per-worker $k_t$ grows at a relatively constant rate while the labor income share $~\Theta_t~$ faces a huge decrease during the 80's.

I consider only France with adjustment method 1 and capital with average hours worked correction. Estimation is done with biased technical change.

```{r break_year_graph_1}

df.fr = df %>% 
  ungroup() %>% 
  subset(Country == "France") %>% 
  select(- Country)

## Core
break_year_graph_1 = df.fr %>% 
  select(Year, k.avh_log, THETA1_log) %>% 
  melt(id.vars = "Year") %>% 
  
  ggplot(aes(x = Year, y = value, color = variable, linetype = variable)) +
  geom_line() +
  geom_vline(xintercept = 1982, linetype = "dotted", color = "grey") +
  scale_x_continuous(breaks = c(1970, 1980, 1982, 1990, 2000, 2010),
                     labels = c(1970, "", 1982, 1990, 2000, 2010)) +
  theme_classic(base_size = 14) +
  labs(x = "", y = "") +
  theme(legend.position = "none", axis.title.x = element_blank(), axis.title.y = element_blank())

## Paper version
break_year_graph_1 +
  scale_color_grey(start = 0, end = 0) +
  scale_linetype_manual(values = c("solid", "dashed")) +
  ggsave(file.path(loc_appCD, "k_Theta_log.png"), width = scale_graph*5, height = scale_graph*5/2)

## Color version
break_year_graph_1 +
  scale_linetype_manual(values = c("solid", "solid")) +
  scale_color_manual(values = brewer.pal(8, "Set1")) +
  ggsave(file.path(loc_appCD, "k_Theta_log_color.png"), width = scale_graph*5, height = scale_graph*5/2)

```
```{r break_year_corr_1}
# 1982 included in before
df.fr %>% 
  mutate(period = ifelse(Year <= 1983, "before", "after")) %>% 
  group_by(period) %>% 
  summarise(cor(k.avh_log, THETA1_log))
```


```{r break_year_corr2}
# 1982 included in after
df.fr %>% 
  mutate(period = ifelse(Year < 1983, "before", "after")) %>% 
  group_by(period) %>% 
  summarise(cor(k.avh_log, THETA1_log))

```

This is the baseline regression, where I estimate the capital-labor elasticity of substitution for the whole sample. 

```{r break_year_baseline_est}

ols_base = df.fr %>% 
  lm(THETA1_log ~ k.avh_log + t_diff, data = .)
robust.summary(ols_base)

sigma.fr_all = 1/(1+ols_base$coefficients[2]) %>% unname()
sigma.fr_all

```

There is a biased technical change, which is constant and significant. I have to keep the same rate of technical change. Because if I split the sample, I would obtain two different BTC growth rates. Thus, a way is to detrend the capital-per-worker and the capital-to-labor income ratio. Such a methodology comes from the **Frisch–Waugh–Lovell theorem**.

```{r break_year_detrend, warnings = FALSE}

# Detrend k
df.fr$k.avh_log_detrend = df.fr %>% 
  lm(k.avh_log ~ t_diff, data = .) %>%
  residuals()

# Detrend THETA
df.fr$THETA1_log_detrend = df.fr %>% 
  lm(THETA1_log ~ t_diff, data = .) %>%
  residuals()

# Plot detrended variables

## Core
break_year_detrend = df.fr %>% 
  select(Year, k.avh_log_detrend, THETA1_log_detrend) %>% 
  melt(id.vars = "Year") %>% 
  
  ggplot(aes(x = Year, y = value, color = variable, linetype = variable)) +
  geom_line() +
  geom_vline(xintercept = 1982, linetype = "dotted", color = "grey") +
  geom_vline(xintercept = 1985, linetype = "dotted", color = "grey") +
  geom_vline(xintercept = 1989, linetype = "dotted", color = "grey") +
  scale_x_continuous(breaks = c(1970, 1980, 1982, 1985, 1989, 1990, 2000, 2010),
                     labels = c(1970, "", 1982, 1985, 1989, "", 2000, 2010)) +
  theme_classic(base_size = 14) +
  labs(x = "", y = "") +
  theme(legend.position = "none", axis.title.x = element_blank(), axis.title.y = element_blank())

## Paper version
break_year_detrend +
  scale_color_grey(start = 0, end = 0) +
  scale_linetype_manual(values = c("solid", "dashed")) +
  ggsave(file.path(loc_appCD, "k_Theta_log_detrend.png"), width = scale_graph*5, height = scale_graph*5/2)

## Color version
break_year_detrend +
  scale_color_manual(values = brewer.pal(8, "Set1")) +
  scale_linetype_manual(values = c("solid", "solid")) +
  ggsave(file.path(loc_appCD, "k_Theta_log_detrend_color.png"), width = scale_graph*5, height = scale_graph*5/2)

```

This is an example of the regressions when I break the sample in 1985. It seems that there are two regimes. There are three main potential breaks around the years 1982, 1985 and 1989. 

```{r break_year_max_k}

# Find the max of the red and blue curves
df.fr %>% 
  subset(k.avh_log_detrend == max(k.avh_log_detrend) | 
           THETA1_log_detrend == max(THETA1_log_detrend) |
           THETA1_log_detrend == min(THETA1_log_detrend))

```

However, the break may have occur during the 80's. I have to determine which year optimize the split. To do so, I use a grid-search approach between 1980 and 1990.

```{r break_year_graph_2regimes}

## Core

break_year_graph_2regimes = df.fr %>% 
  select(Year, k.avh_log_detrend, THETA1_log_detrend) %>% 
  mutate(before_break = as.factor(ifelse(Year <= 1985, "1970-1985", "1986-2010"))) %>% 
  
  ggplot(aes(x = k.avh_log_detrend, y = THETA1_log_detrend, color = before_break, shape = before_break)) +
  geom_point(size = 2) +
  stat_smooth(method = "lm", alpha = 0.2) +
  # stat_smooth(method = "lm", color = "black") +
  theme_classic(base_size = 14) +
  labs(x = "", y = "") +
  theme(legend.direction = "vertical", legend.box = "horizontal", 
          legend.position = c(0.02,1), legend.justification = c(0,1))

## Paper version
break_year_graph_2regimes +
  scale_color_grey(name = "", start = 0.1, end = 0.5) +
  scale_shape_manual(name = "", values = c(16,15)) +
  ggsave(file.path(loc_appCD, "k_Theta_log_reg85.png"), width = scale_graph*5, height = scale_graph*5/2)

## Color version
break_year_graph_2regimes +
  scale_color_manual(name = "", values = brewer.pal(8, "Set1")[c(3,4)]) +
  scale_shape_manual(name = "", values = c(16,15)) +
  ggsave(file.path(loc_appCD, "k_Theta_log_reg85_color.png"), width = scale_graph*5, height = scale_graph*5/2)

```

```{r break_year_optimal_splitter}
split.coef = data.frame(matrix(nrow = 0, ncol = 6))
split.R2 = data.frame(matrix(nrow = 0, ncol = 2))

# Loop to analysis splitters
for(splitter in c(1975:1995)){
  
  est_sigma.fr = df.fr %>% 
    mutate(after_split = ifelse(Year > splitter, 1, 0),
           before_split = ifelse(Year <= splitter, 1, 0))
  
  # Break
  ols.france_dummy = est_sigma.fr %>% 
    lm(THETA1_log_detrend ~ k.avh_log_detrend*before_split + k.avh_log_detrend*after_split - 1 -
         k.avh_log_detrend, data = .)
  ols.france_dummy = summary(ols.france_dummy)
  
  ## Gather results
  # Coefs
  split.coef = split.coef %>%
    rbind(data.frame(splitter,
                     var = ols.france_dummy$coefficients %>% row.names(),
                     ols.france_dummy$coefficients,
                     row.names = NULL))
  # R^2
  split.R2 = split.R2 %>% 
    rbind(data.frame(splitter, R2 = ols.france_dummy$r.squared))
  
}

# Sort data
split.coef = split.coef %>% 
  setNames(c("splitter", "variable", "estimate", "se", "tvalue", "pvalue")) %>% 
  mutate(star = ifelse(pvalue > 0.1, NA,
                       ifelse(pvalue > 0.05, "*",
                              ifelse(pvalue > 0.01, "**", "***"))))
```


```{r break_year_optimal_splitter_coef}

split.coef[3:6] = split.coef[3:6] %>% apply(., 2, function(x){round(x, digits = 3)})
split.coef

```


```{r break_year_optimal_splitter_R2}

split.R2$R2 = split.R2$R2 %>% round(digits = 3)
split.R2

```


```{r break_year_optimal_year_est}

# Max R2 : define the break_year
break_year = split.R2 %>% subset(R2 == max(R2)) %>% pull("splitter")
print(paste0("Break in the regime in : ", break_year))


### With BTC
## Before
ols.fr.btc_before = df.fr %>% 
  subset(Year <= break_year) %>% 
  lm(formula = THETA1_log ~ k.avh_log + t_diff)

ols.fr.btc_before %>% summary()

sigma.fr.btc_before = 1/(1+ols.fr.btc_before$coefficients[2]) %>% unname()
sigma.fr.btc_before

## After
ols.fr.btc_after = df.fr %>% 
  subset(Year > break_year) %>% 
  lm(formula = THETA1_log ~ k.avh_log + t_diff)

ols.fr.btc_after %>% summary()

sigma.fr.btc_after = 1/(1+ols.fr.btc_after$coefficients[2]) %>% unname()
sigma.fr.btc_after

### Without BTC
ols.fr_before = df.fr %>% 
  subset(Year <= break_year) %>% 
  lm(formula = THETA1_log ~ k.avh_log)

ols.fr_before %>% summary()

sigma.fr_before = 1/(1+ols.fr_before$coefficients[2]) %>% unname()
sigma.fr_before

## After
ols.fr_after = df.fr %>% 
  subset(Year > break_year) %>% 
  lm(formula = THETA1_log ~ k.avh_log)

ols.fr_after %>% summary()

sigma.fr_after = 1/(1+ols.fr_after$coefficients[2]) %>% unname()
sigma.fr_after


```

<!--chapter:end:appendix_CD.Rmd-->

---
title: "LISA - Gamma specification"
author: "Fabien Petit"
output: 
  github_document:	
    pandoc_args: --webtex
---

## Data

Data are from Penn World Table 9.1, OECD Database and the United Nations database (World Population Prospects). The purpose of this section is to explore the impact of $\gamma \in (0,1)$, i.e. the bargaining power.

```{r init, results = "hide", message = FALSE}
# Define paths
loc_result = file.path(getwd(), "result")
loc_sim = file.path(loc_result, "sim")
loc_function = file.path(getwd(), "function")
loc_final = file.path(getwd(), "data", "final")

# Load packages
packages <- c("bucky", "dplyr", "ggplot2", "ggrepel", "lmtest", "sandwich", "zoo", "RColorBrewer", "reshape2")
lapply(packages, require, character.only = TRUE)
rm(packages)

# Load functions
sapply(list.files(pattern = "[.]R$", path = loc_function, full.names = TRUE), source)

# Country set
country_set = c("France", "United States")

# Simulation periods
sim = seq(1970, 2080, 10)

# Estimation sample
est_sample = c(1970:2010)

```

```{r load_data}

# Penn World Table 9.1
pwt = read.csv(file.path(loc_final, "pwt.csv"), header = TRUE) %>%
  select("Country", "Year", "emp", "avh", "rgdpna", "rnna", "lab_sh1") %>% 
  subset(Country %in% country_set & Year >= 1970)

# OECD data
oecd = read.csv(file.path(loc_final, "oecd.csv"), header = TRUE) %>% 
  select("Country", "Year", tax_rate = "tax_rev_PC_GDP", 
         union_density = "union_density.lin_inter", union_coverage = "union_coverage.lin_inter") %>% 
  subset(Country %in% country_set & Year >= 1970)

# Demographic data
demo = read.csv(file.path(loc_final, "demo.csv"), header = TRUE) %>% 
  select("Country", "Year", "young", "young_1564", "old", "dep", "n", "p") %>% 
  subset(Country %in% country_set & Year >= 1970)

## Merge
df = merge(merge(pwt, oecd, all = TRUE), demo, all = TRUE)

```

```{r data_treatment}

# Variable modifications
df = df %>%
  group_by(Country) %>% 
  mutate(L = emp * 1000,
         Y = rgdpna / avh * 1000, # AVH control
         K = rnna / avh * 1000, # AVH control
         theta = lab_sh1, # Labor share
         tau = tax_rate / 100, # Tax rate
         u = 1 - L / (young_1564), # Unemployment rate
         p1 = lead(p, 40)) %>% 
  select(Country, Year, Ny = young, No = old, n, p, p1, dep, K, L, Y, theta, tau, u) %>% 
  mutate(L = L / first(L), # Normalized labor
         K = K / first(K), # Normalized capital
         Y = Y / first(Y), # Normalized output
         k = K / L, # Normalized capital-labor ratio
         Ny = L / (1-u), # Normalized young population
         No = Ny * dep) %>% # Normalized old population
  ungroup()

# Remove unused countries from Country levels
df$Country = df$Country %>% as.character %>% as.factor()

# Visualization
head(df)

```

## Parameter calibration

*For more details on the calibration, please consult "main.md" file.*

```{r param}

param_base = data.frame("Country" = rep(c("France", "United States"), each = length(sim)),
                   "Year" = sim,
                   "phi" = NA, "sigma" = NA, "a" = NA, "alpha" = (0.99)^40, "gamma" = NA,
                   "omega" = NA, "beta" = NA, A = NA)

```

### Production function

I estimate the elasticity of substitution between capital and labor using the first order conditions from the profit maximization. Estimation are done for France and United States between 1970 and 2010, using Penn World Table 9.1 data. *For more details, please consult "sigma.md" file.*

```{r param_prod_fr}
# Estimation
est_sigma = df %>% 
  group_by(Country) %>% 
  mutate(k_log = log(k),
         THETA_log = log(theta/(1-theta)),
         t_diff = Year - first(Year)) %>% 
  select(Country, Year, k_log, THETA_log, t_diff) %>% 
  subset(Year %in% c(1970:2010)) %>% 
  ungroup()

### Regression France : one sigma for the whole period
  ols.france_all = est_sigma %>% 
    subset(Country == "France") %>% 
    lm(THETA_log ~ k_log + t_diff, data = .)
  # Report sigma
    sigma.fr_all = 1/(1 + ols.france_all$coefficients[2]) %>% unname()

# Result visualization
robust.summary(ols.france_all)
```


```{r param_prod_us}
### Regression United-States : one sigma for the whole period
  ols.us_all = est_sigma %>% 
    subset(Country == "United States") %>% 
    lm(THETA_log ~ k_log, data = .)
  # Report Sigma
  sigma.us_all = 1/(1 + ols.us_all$coefficients[2]) %>% unname()

# Result visualization
robust.summary(ols.us_all)

```


```{r param_prod}
# Add production function parameters
param_base = param_base %>% 
  mutate("phi" = rep(1 - df %>% subset(Year == 1970) %>% pull("theta"), each = length(sim)),
         "sigma" = rep(c(sigma.fr_all, sigma.us_all), each = length(sim)))

```

### Wage bargaining

I create 4 different specifications of the relative bargaining power of the union.

* *gamma.cst* : Constant value of 0.5. This specification will be used for prediction.
* *gamma0* : Proxy of the bargaining power. It depends on the trade union density and the collective union coverage. I use a square root function to have a concave function of both variables and smooth the variations in bargaining power.
* *gamma1* : Rescale gamma0 such that gamma1 = 0.5 in 1970.
* *gamma2* : Rescale gamma0 such that mean(gamma2) = 0.5.

Both last specifications will be used to improve the quality of the fit on the period 1970 - 2010. Only the first specification will be used for prediction.

```{r param_gamma}

## Generate different specifications for bargaining power
param.gamma = oecd %>% 
  # subset(Year %in% sim) %>% 
  group_by(Country) %>% 
  mutate(gamma.cst = 0.5,
         gamma0 = sqrt(union_density/100*union_coverage/100),
         gamma1 = gamma0 / first(gamma0) * gamma.cst, # Rescale gamma such that gamma = 0.5 in 1970
         gamma2 = gamma0 / mean(gamma0, na.rm = TRUE) * gamma.cst) %>% # Rescale gamma such that gamma is normalize to its average value on the estimated sample
  merge(param_base[, c("Country", "Year")], ., all.x = TRUE) %>% 
  select(Country, Year, starts_with("gamma")) %>% 
  mutate(gamma.cst = 0.5)

# List gamma specification
gamma_specification = c(".cst", "0", "1", "2")

## Predictions about gamma to be able to run the model
# Constant interpolation
param.gamma[param.gamma$Year ==  2080 , c("gamma0","gamma1","gamma2")] = param.gamma %>%
  subset(Year == 2010) %>%
  select(gamma0, gamma1, gamma2)

param.gamma = param.gamma %>%
  interpol_group(method_use = "constant")

# Visualization
param.gamma


```

### Preferences

According to the specification of $\gamma$, the parameters $\omega$ and $\beta$ are different. Therefore, I compute parameter values for each specification.

```{r param_pref}

## Generate different parameter values according to the value of gamma
param.pref = df %>%
  subset(Year == 1970) %>% 
  merge(param_base %>% select(Country, Year, phi, sigma, a, alpha), .) %>% 
  merge(param.gamma %>% select(Country, Year, gamma.cst, gamma0, gamma1, gamma2), .) %>% 
  mutate(## Variable : X for each gamma specification
         X.cst = (sigma + (1-phi)/phi*(1-gamma.cst*(1-sigma))/gamma.cst)^(-1),
         X0 = (sigma + (1-phi)/phi*(1-gamma0*(1-sigma))/gamma0)^(-1),
         X1 = X.cst, # X1 is the same as X.cst since gamma1 = 0.5 in 1970
         X2 = (sigma + (1-phi)/phi*(1-gamma2*(1-sigma))/gamma2)^(-1),
         
         ## Parameter : OMEGA
         omega.cst = phi/(1-phi)*n/p*(1+alpha*p1)/(1 + exp(-X.cst)*(Ny - 1)),
         omega0 = phi/(1-phi)*n/p*(1+alpha*p1)/(1 + exp(-X0)*(Ny - 1)),
         omega1 = omega.cst, # omega1 is the same as omega.cst since gamma1 = 0.5 in 1970
         omega2 = phi/(1-phi)*n/p*(1+alpha*p1)/(1 + exp(-X2)*(Ny - 1)),
         
         ## Variable : ETA
         eta.cst = n/p*(1+alpha*p1)/omega.cst,
         eta0 = n/p*(1+alpha*p1)/omega0,
         eta1 = eta.cst, # eta1 is the same as X.cst since gamma1 = 0.5 in 1970
         eta2 = n/p*(1+alpha*p1)/omega2,
         
         ## Parameter : BETA
         beta.cst = 1/(1 - tau)/phi - 1 - eta.cst,
         beta0 = 1/(1 - tau)/phi - 1 - eta0,
         beta1 = beta.cst, # beta1 is the same as omega.cst since gamma1 = 0.5 in 1970
         beta2 = 1/(1 - tau)/phi - 1 - eta2
         ) %>% 
  select(Country, starts_with("omega"), starts_with("beta")) %>% 
  merge(param_base[, c("Country", "Year")], ., all.x = TRUE)

# Visualization
param.pref %>% subset(Year ==  1970) %>% select(-Year)

```

## Simulation

I simulate the model with a different $A$ parameter for each $\gamma$ specification and then with the same $A$ parameter.

```{r sim_param_spe}

init_seq = seq(1970, 2000, 10)

# Baseline data
data_base = df %>% 
  group_by(Country) %>% 
  subset(Year %in% sim) %>% 
  select(Country, Year, Ny, No, n, p, p1, K) %>% 
  mutate(Sequence = ((sim - 1970)/10) %% 4 + 1,
         Period = (sim - init_seq) / 40 + 1,
         Ny = ifelse(Year == 2010, NA, Ny),
         No = ifelse(Year == 2010, NA, No),
         K = ifelse(Year == 2010, NA, K),
         # Complete NA values for p1 in 2070 and 2080
         p1 = ifelse(Year >= 2070, p1[Year == 2060] + 
                       (Year - 2060)/10 * mean(p1/lag(p1)-1, na.rm = T), p1), 
         ## Create empty variables
         eta = NA, AK = NA, AL = NA, k1 = NA, k2 = NA, k = NA, X = NA, L = NA, w = NA,
         r = NA, Y = NA, u = NA, theta = NA, tau = NA, b = NA, h = NA, S = NA) 

# Re-order variables
data_base = data_base %>% select(Country, Year, Sequence, Period, Ny, No, n, p, p1, eta, AK, AL,
                                 k1, k2, k, X, L, w, r, Y, u, theta, tau, b, h, S, K)
  
# Visualization
head(data_base)

```


```{r data_prep}

# Prepare dataset
data = data_base %>% 
  # Demography
  demo_changer(init_spe = TRUE)

# Prepare parameters
param = param_base
  
```

### Different scale parameter (A)

```{r gamma_diffA}

# Initialize final dataset for gamma comparison
final_gamma_diffA = data.frame(matrix(ncol = ncol(data)+ ncol(param) -2 + 1, nrow = 0)) %>%
  setNames(c("Specification", names(data), names(param)[-c(1,2)]))

# Data save
data_save = data

for(gamma_spe in gamma_specification){
  
  # Prepare data
  data = data_save %>% 
    # Re-initialize data and define specification of the model
    mutate(Specification = gamma_spe) %>% 
    # Put Specification as 1st column
    select(Specification, everything()) %>% 
    # Select gamma / omega / beta : choose between ".cst" / "0" / "1" / "2"
    gob_finder(param, gamma_spe = gamma_spe) %>% 
    # No BTC
    mutate(AK = 1, AL = 1) %>% 
    # Demography
    demo_changer(AFinder = TRUE)
  
  # A Finder script
  source("./script/sim_AFinder.R")
  
  # Empty dataframe for results
  result = data.frame(matrix(ncol = ncol(data), nrow = 0)) %>%
    setNames(names(data))
  
  # Simulate model for country_set
  for(country in country_set){
    
    result = data %>%
      subset(Country == country) %>% 
      model(time = 2) %>% 
      rbind(result, .)
    
  }
  
  # Regroup results
  final_gamma_diffA = rbind(final_gamma_diffA, result)
  
}

# Write final_gamma
write.csv(final_gamma_diffA, file.path(loc_sim, "final_gamma_diffA.csv"), row.names = FALSE)

```

```{r gamma_diffA_plot}

final_gamma_diffA %>% 
  select(Specification, Country, Year, theta) %>% 
  subset(Year %in% seq(1970, 2010, 10)) %>% 
  
  ggplot(aes(x = Year, y = theta, color = Specification)) +
  geom_line(size = 0.5) +
  facet_wrap(Country ~ .) +
  theme_classic() +
  theme(legend.position = "bottom", legend.direction = "horizontal") +
  labs(x = "Year", y = "Labor share")

```

Decreasing $\gamma$ does not improve the model performance. The predictions are almost the same whatever the specification of $\gamma$.

### Same scale parameter (A)

```{r gamma_sameA}

# Initialize final dataset for gamma comparison
final_gamma_sameA = data.frame(matrix(ncol = ncol(data)+ ncol(param) -2 + 1, nrow = 0)) %>%
  setNames(c("Specification", names(data), names(param)[-c(1,2)]))

## Find A for all, from baseline estimation
data = data_save %>% 
    # Re-initialize data and define specification of the model
    mutate(Specification = ".cst") %>% 
    # Put Specification as 1st column
    select(Specification, everything()) %>% 
    # Select gamma / omega / beta : choose between ".cst" / "0" / "1" / "2"
    gob_finder(param, gamma_spe = ".cst") %>% 
    # No BTC
    mutate(AK = 1, AL = 1) %>% 
    # Demography
    demo_changer(AFinder = TRUE)


# A Finder script
source("./script/sim_AFinder.R")

# Assign A scale parameter to param_base
param$A = data$A

for(gamma_spe in gamma_specification){
  
  # Prepare data
  data = data_save %>% 
    # Re-initialize data and define specification of the model
    mutate(Specification = gamma_spe) %>% 
    # Put Specification as 1st column
    select(Specification, everything()) %>% 
    # Select gamma / omega / beta : choose between ".cst" / "0" / "1" / "2"
    gob_finder(param, gamma_spe = gamma_spe) %>% 
    # No BTC
    mutate(AK = 1, AL = 1) %>% 
    # Demography
    demo_changer(AFinder = TRUE)
  
  # Empty dataframe for results
  result = data.frame(matrix(ncol = ncol(data), nrow = 0)) %>%
    setNames(names(data))
  
  # Simulate model for country_set
  for(country in country_set){
    
    result = data %>%
      subset(Country == country) %>% 
      model(time = 2) %>% 
      rbind(result, .)
    
  }
  
  # Regroup results
  final_gamma_sameA = rbind(final_gamma_sameA, result)
  
}

# Write final_gamma2
write.csv(final_gamma_sameA, file.path(loc_sim, "final_gamma_sameA.csv"), row.names = FALSE)

```

```{r gamma_sameA_plot}

final_gamma_sameA %>% 
  select(Specification, Country, Year, theta) %>% 
  subset(Year %in% seq(1970, 2010, 10)) %>% 
  
  ggplot(aes(x = Year, y = theta, color = Specification)) +
  geom_line(size = 0.5) +
  facet_wrap(Country ~ ., scale = "free") +
  theme_classic() +
  theme(legend.position = "bottom", legend.direction = "horizontal") +
  labs(x = "Year", y = "Labor share")
```

Decreasing $\gamma$ does not improve the model performance. The predictions are almost the same whatever the specification of $\gamma$.

## Conclusion

Changing $\gamma$ does not improve the results. Relative bargaining power has a small impact in the model prediction. However, it may mean that the outside option is the key determinant to improve model predictions.

<!--chapter:end:gamma.Rmd-->

---
title: "Labor Share & Aging Population"
author: "Fabien Petit"
output:	
  github_document:	
    pandoc_args: --webtex
---

## Data

### Raw data

Data are from :

* Penn World Table 9.1
* OECD Database
* United Nations (World Population Prospects)

```{r init, results = "hide", message = FALSE}

# Define paths
loc_result = file.path(getwd(), "result")
loc_sim = file.path(loc_result, "sim")
loc_function = file.path(getwd(), "function")
loc_final = file.path(getwd(), "data", "final")

# Load packages
packages <- c("bucky", "dplyr", "ggplot2", "ggrepel", "lmtest", "sandwich", "zoo", "RColorBrewer", "reshape2")
lapply(packages, require, character.only = TRUE)
rm(packages)

# Load functions
sapply(list.files(pattern = "[.]R$", path = loc_function, full.names = TRUE), source)

# Country set
country_set = c("France", "United States")

# Simulation periods
sim = seq(1970, 2080, 10)

# Estimation sample
est_sample = c(1970:2010)

# Graphic parameters
breaks_10_years = seq(1970, 2080, 10)
labs_20_years = as.vector(rbind(seq(1970, 2080, 20), rep("", length(breaks_10_years)/2)))
scale_graph = 1920/1080

```

```{r load_data, include = FALSE}

# Penn World Table
pwt = read.csv(file.path(loc_final, "pwt.csv"), header = TRUE) %>%
  select("Country", "Year", "emp", "avh", "rgdpna", "rnna", "lab_sh1", "lab_sh2") %>% 
  subset(Country %in% country_set & Year >= 1970)

# OECD data
oecd = read.csv(file.path(loc_final, "oecd.csv"), header = TRUE) %>% 
  select("Country", "Year", tax_rate = "tax_rev_PC_GDP",
         union_density = "union_density.lin_inter", union_coverage = "union_coverage.lin_inter") %>% 
  subset(Country %in% country_set & Year >= 1970)

# Demographic data
demo = read.csv(file.path(loc_final, "demo.csv"), header = TRUE) %>% 
  select("Country", "Year", "young", "young_1564", "old", "dep", "n", "p") %>% 
  subset(Country %in% country_set)

## Merge
df = merge(merge(pwt, oecd, all = TRUE), demo, all = TRUE) %>% 
  subset(Year >= 1970)

```

```{r data_treatment}

# Variable modifications
df = df %>%
  group_by(Country) %>% 
  mutate(L = emp * 1000,
         Y = rgdpna / avh * 1000, # AVH control
         K = rnna / avh * 1000, # AVH control
         theta = lab_sh1, # Labor share
         tau = tax_rate / 100, # Tax rate
         u = 1 - L / (young_1564), # Unemployment rate
         p1 = lead(p, 40)) %>% 
  select(Country, Year, Ny = young, No = old, n, p, p1, dep, K, L, Y, theta, tau, u) %>% 
  mutate(L = L / first(L), # Normalized labor
         K = K / first(K), # Normalized capital
         Y = Y / first(Y), # Normalized output
         k = K / L, # Normalized capital-labor ratio
         Ny = L / (1-u), # Normalized young population
         No = Ny * dep) %>% # Normalized old population
  ungroup()

# Remove unused countries from Country levels
df$Country = df$Country %>% as.character %>% as.factor()

# Visualization
head(df)

# Write df
write.csv(df, file.path(loc_sim, "data.csv"), row.names = FALSE)

```

### Data for simulation

```{r data_sim_prep}

init_seq = seq(1970, 2000, 10)

# Baseline data
data_base = df %>% 
  group_by(Country) %>% 
  subset(Year %in% sim) %>% 
  select(Country, Year, Ny, No, n, p, p1, K) %>% 
  mutate(Sequence = ((sim - 1970)/10) %% 4 + 1,
         Period = (sim - init_seq) / 40 + 1,
         Ny = ifelse(Year == 2010, NA, Ny),
         No = ifelse(Year == 2010, NA, No),
         K = ifelse(Year == 2010, NA, K),
         # Complete NA values for p1 in 2070 and 2080
         p1 = ifelse(Year >= 2070, p1[Year == 2060] + 
                       (Year - 2060)/10 * mean(p1/lag(p1)-1, na.rm = T), p1), 
         ## Create empty variables
         eta = NA, AK = NA, AL = NA, k1 = NA, k2 = NA, k = NA, X = NA, L = NA, w = NA,
         r = NA, Y = NA, u = NA, theta = NA, tau = NA, b = NA, h = NA, S = NA) 

# Re-order variables
data_base = data_base %>% select(Country, Year, Sequence, Period, Ny, No, n, p, p1, eta, AK, AL,
                                 k1, k2, k, X, L, w, r, Y, u, theta, tau, b, h, S, K)
  
# Visualization
head(data_base)

```

```{r init_spe}

data = data_base %>% 
  # No biased technical change
  mutate(AK = 1, AL = 1) %>% 
  # Population dynamics
  demo_changer(init_spe = TRUE)

```

```{r graph_demo}

## Core
graph_demo = data %>% 
  mutate("dep" = p/n) %>%
  select("Country", "Year", 
         "Population~growth~(n)" = n,
         "Survival~rate~(p)" = p,
         "Old~age~dependency~ratio~(p/n)" = dep) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, color = Country)) +
  geom_line() +
  facet_wrap(variable ~ ., scales = "free", nrow = 1, labeller = label_parsed) +
  scale_x_continuous(breaks = breaks_10_years,
                       labels = c(1970, "", "", 2000, "", "", 2030, "", "", 2060, "", "")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
graph_demo +
  scale_color_grey(breaks = c("France", "United States"), start = 0.2, end = 0.8) +
  ggsave(file.path(loc_result, "demo_npdep.png"), 
         width = scale_graph*5, height = scale_graph*5/3)

## Color version
graph_demo +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  ggsave(file.path(loc_result, "demo_npdep_color.png"), 
         width = scale_graph*5, height = scale_graph*5/3)

```

## Parameter calibration

The discount factor *alpha* is set to `r round(0.99^40,3)`. The relative bargaining power of the union *gamma* is set to `r 0.5`. *For more details, please consult "gamma.md" file.*

```{r param}

param_base = data.frame("Country" = rep(c("France", "United States"), each = length(sim)),
                   "Year" = sim, "alpha" = (0.99)^40, "gamma" = 0.5)

```

### Production function

I estimate the elasticity of substitution between capital and labor using the first order conditions from the profit maximization. Estimation are done for France and United States between 1970 and 2010, using Penn World Table 9.1 data. *For more details, please consult "sigma.md" file.*

```{r param_prod}

# Dataframe for estimation
est_sigma = df %>% 
  group_by(Country) %>% 
  mutate(k_log = log(k),
         THETA_log = log(theta/(1-theta)),
         t_diff = Year - first(Year)) %>% 
  select(Country, Year, k_log, THETA_log, t_diff) %>% 
  subset(Year %in% c(1970:2010)) %>% 
  ungroup()

```

#### France

```{r param_prod_fr}

### Regression : one sigma for the whole period
  ols.france_all = est_sigma %>% 
    subset(Country == "France") %>% 
    lm(THETA_log ~ k_log + t_diff, data = .)
  # Report sigma
    sigma.fr_all = 1/(1 + ols.france_all$coefficients[2]) %>% unname()

### Regression : sigma before the change in the regime (1985)
  ols.france_before = est_sigma %>% 
    subset(Country == "France" & Year <= 1985) %>% 
    lm(THETA_log ~ k_log, data = .)
# Report sigma
  # Significant
    # sigma.fr_before = 1/(1 + ols.france_before$coefficients[2]) %>% unname()
  # Not significant => sigma.fr_before = 1
    sigma.fr_before = 1

### Regression : sigma after the change in the regime (1985)
  ols.france_after = est_sigma %>%
    subset(Country == "France" & Year > 1985) %>% 
    lm(THETA_log ~ k_log, data = .)
  # Report sigma
    sigma.fr_after = 1/(1 + ols.france_after$coefficients[2]) %>% unname()
    
### Report all sigmas
  print(paste0("One for all : ", round(sigma.fr_all,3)))
  print(paste0("Before 1985 : ", round(sigma.fr_before,3)))
  print(paste0("After 1985 : ", round(sigma.fr_after,3)))

```

#### United States

```{r param_prod_us}

### Regression : one sigma for the whole period
  ols.us_all = est_sigma %>% 
    subset(Country == "United States") %>% 
    lm(THETA_log ~ k_log, data = .)
  # Report Sigma
  sigma.us_all = 1/(1 + ols.us_all$coefficients[2]) %>% unname()
  print(paste0("One for all : ", round(sigma.us_all,3)))

```

#### Summary

```{r param_prod_summary}

# Add production function parameters
param_base = param_base %>%
  mutate("phi" = rep(1 - df$theta[df$Year == 1970], each = length(sim)), 
         "sigma" = ifelse(Country == "France", sigma.fr_all, sigma.us_all),
         "a" = NA)

# Visualization
param_base %>% subset(Year == 1970) %>% select(Country, phi, sigma, a)

```

### Preferences

The relative per-capita influence of old households *omega* is deduced such that the capital-to-labor ratio is matched in 1970. The preference for government health expenditure *beta* is deduced such that the tax rate in 1970 is matched.

```{r param_pref}

# Compute omega and beta
param_base = param_base %>%
  merge(., df) %>% 
  mutate(X = (sigma + (1-phi)/phi*(1-gamma*(1-sigma))/gamma*k^((1-sigma)/sigma))^(-1),
         eta = (1-phi)/phi*k^((1-sigma)/sigma) * ((Ny/K*k-1)*exp(-X) + 1),
         omega = n/p*(1+alpha*p1)/eta,
         beta = 1/(1 - tau)/(1-theta) - 1 - eta) %>% 
  group_by(Country) %>% 
  mutate(omega = first(omega),
         beta = first(beta)) %>% 
  select(Country, Year, alpha, gamma, phi, sigma, a, omega, beta) %>% 
  ungroup()

# Visualization
param_base %>% subset(Year == 1970) %>% select(Country, omega, beta)

```


### Scale parameter

The scale parameter *A* is decuded using grid search to match the average labor share between 2008 and 2012.

```{r param_A}

data = data_base %>% 
  # No biased technical change
  mutate(AK = 1, AL = 1) %>% 
  # Add parameters
  merge(param_base) %>% 
  # Demography
  demo_changer(AFinder = TRUE)

# A Finder script
source("./script/sim_AFinder.R")

# Assign A scale parameter to param_base
param_base$A = data$A

```

### Summary

All parameters are constant over time.

```{r param_summary}

# Visualization
param_base %>% subset(Year == 1970) %>% select(-Year, -a) 

# Assign values
param = param_base 

```

## Simulation

### Demography : break years

Prepare the dataset for the counterfactual analysis.

```{r breakers}

breakers = demo %>% 
  ## Compute demographic data for 1960
  subset(Year == 1960) %>% 
  mutate(Sequence = NA, Period = NA, Ny = NA, No = NA, p1 = NA) %>% 
  select(Country, Year, Sequence, Period, Ny, No, n, p, p1) %>% 
  rbind(., data_base %>% 
          select(Country, Year, Sequence, Period, Ny, No, n, p, p1) %>% 
          subset(Year == 2000) %>% 
          ungroup()) %>% 
  group_by(Country) %>% 
  mutate(p1 = ifelse(Year == 1960, dplyr::lead(p), p1),
         Ny = ifelse(Year == 1960, dplyr::lead(Ny)/dplyr::lead(n), Ny),
         No = ifelse(Year == 1960, p/n*Ny, No),
         Sequence = ifelse(Year == 1960, 4, Sequence),
         Period = ifelse(Year == 1960, 0, Period)) %>% 
  subset(Year == 1960) %>% 
  ungroup() %>% 
  ## Demographic data for 1960 : done
  rbind(., data_base %>% 
          select(Country, Year, Sequence, Period, Ny, No, n, p, p1) %>% 
          ungroup()) %>% 
  arrange(Country) %>% 
  merge(., param_base %>% select(Country, alpha, omega) %>% unique()) %>% 
  group_by(Country, Sequence) %>% 
  mutate(eta = n/p*(1+alpha*p1)/omega,
         Ny = ifelse(Period == 2, lag(Ny,1)*n, Ny),
         No = ifelse(Period == 2, lag(Ny,1)*p, No),
         Ny = ifelse(Period == 3, lag(Ny,1)*n, Ny),
         No = ifelse(Period == 3, lag(Ny,1)*p, No),) %>% 
  select(-alpha, -omega) %>% 
  ungroup()

# Visualization
breakers

```

### Baseline model

```{r sim_bmodel}

# Specification
spe = "baseline"

# Initialize result dataset
final = data.frame(matrix(ncol = ncol(data)+ ncol(param) -2 + 1, nrow = 0)) %>%
  setNames(c("Specification", names(data), names(param)[-c(1,2)]))

# Prepare data for simulation
data = data_base %>% 
  # Merge with parameters
  merge(param) %>% 
  # No BTC
  mutate(AK = 1, AL = 1) %>% 
  # Demography
  demo_changer() %>% 
  # Define specification model
  mutate(Specification = spe) %>%
  # Reorder variables
  select(Specification, everything())

# Prepare result data frame to loop on
result = final

# Simulate the baseline model for each country
for(country in country_set){
    
    result = data %>%
      subset(Country == country) %>% 
      model(time = 3) %>% 
      rbind(result, .)
    
}

# Regroup result
baseline = result

# Write final_baseline
write.csv(baseline, file.path(loc_sim, paste0("final_", spe, ".csv")), row.names = FALSE)

```

#### Performance

```{r sim_bmodel_perf}

# Prepare data and regression
perf = baseline %>% 
  subset(Specification == "baseline") %>% 
  select(Country, Year, theta) %>% 
  merge(., 
        df %>% select(Country, Year, theta) %>% setNames(c("Country", "Year", "labsh")),
        all = TRUE
        ) %>% 
  interpol_group() %>% 
  filter(complete.cases(.)) %>% 
  mutate(Year1 = Year - 1970 + 1,
         Year2 = Year1^2,
         Year3 = Year1^3,
         # Year4 = Year1^4,
         # Year5 = Year1^5,
         labsh.fitted = lm(data = .,
                           formula = labsh 
                           ~ Year1*Country 
                           + Year2*Country
                           + Year3*Country 
                           # + Year4*Country 
                           # + Year5*Country 
                           - Country) %>%
           fitted.values() %>% unname())

# Core plot
perf_plot = perf %>% 
  select(Country, Year, theta, labsh, labsh.fitted) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = variable)) +
  geom_line() +
  facet_wrap(Country ~ .) +
  theme_classic(base_size = 14) +
  theme(legend.position = c(0.99, 0.99),
        legend.justification = c("right", "top"),
        legend.direction = "vertical",
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "Year", y = "Labor income share")

## Paper version
perf_plot +
  scale_linetype_manual(name = "",
                     breaks = c("theta", "labsh", "labsh.fitted"), labels = c("Model", "Data", "Smoothed data"),
                     values = c("dotted", "solid", "dashed"))

# Performance regression France
perf %>% 
  subset(Country == "France") %>% 
  lm(labsh.fitted ~ theta, data = .) %>% 
  summary()

# Performance regression United-States
perf %>% 
  subset(Country == "United States") %>% 
  lm(labsh.fitted ~ theta, data = .) %>% 
  summary()
  
```

### Fill the gap : France 1980

```{r sim_fgap_france_param}

# Change param for France
param = param %>% 
  mutate(sigma = ifelse(Country == "France",
                        ifelse(Year <= 1980, sigma.fr_before, sigma.fr_after), sigma))

# Change A
data = data_base %>%
  # No biased technical change
  mutate(AK = 1, AL = 1) %>%
  # Add parameters
  merge(param) %>%
  # Remove the previous A
  select(-A) %>%
  # Demography
  demo_changer(AFinder = TRUE)

# A Finder script
source("./script/sim_AFinder.R")

# Assign A scale parameter to param_base
param$A = data$A

# Visualization : New A
param %>% subset(Year == 1970) %>% select(Country, A)

```


```{r sim_fgap_france}

# Specification
spe = "fillgap"

# Initialize result dataset
fillgap = data.frame(matrix(ncol = ncol(data)+ ncol(param) -2 + 1, nrow = 0)) %>%
  setNames(c("Specification", names(data), names(param)[-c(1,2)]))

# Prepare data for simulation
data = data_base %>% 
  # Merge with parameters
  merge(param) %>% 
  # No BTC
  mutate(AK = 1, AL = 1) %>% 
  # Demography
  demo_changer() %>% 
  # Define specification model
  mutate(Specification = spe) %>%
  # Reorder variables
  select(Specification, everything())

# Simulate the fillthegap model for France
fillgap = data %>%
  subset(Country == "France") %>%
  model(time = 3)

# Write fillgap
write.csv(fillgap, file.path(loc_sim, paste0("final_", spe, ".csv")), row.names = FALSE)

```

```{r bmodel_plot_LS7010_all}

## Core
bmodel_plot_LS7010 = baseline %>% 
  subset(Specification == "baseline") %>% 
  select(Country, Year, theta) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  mutate(variable = ifelse(Country == "France", "base.fr", "base.us")) %>% 
  rbind(.,
        fillgap %>% select(Country, Year, theta) %>% setNames(c("Country", "Year", "fill.fr")) %>% 
          melt(id.vars = c("Country", "Year"))) %>% 
  rbind(.,
        df %>% select(Country, Year, theta) %>% setNames(c("Country", "Year", "data")) %>% 
          melt(id.vars = c("Country", "Year"))
        ) %>% 
  filter(complete.cases(.)) %>% 
  mutate(fill = ifelse(variable == "fill.fr", "fill", "other")) %>% 
  subset(Year %in% c(1970:2010)) %>% 
  # Trick to put data line under others
  mutate(variable = as.character(variable),
         variable = ifelse(variable == "data", "a.data", variable),
         variable = as.factor(variable)) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = variable, color = variable)) +
  geom_line() +
  facet_wrap(Country ~ ., scales = "fixed") +
  theme_classic(base_size = 14) +
  theme(legend.position = c(0.99, 0.99), legend.justification = c(1,1), panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
bmodel_plot_LS7010 +
  scale_linetype_manual(breaks = c("base.fr", "base.us", "a.data", "fill.fr"), 
                        values = c("blank", "dashed", "solid", "dashed") %>% 
                        setNames(c("base.fr", "base.us", "a.data", "fill.fr"))) +
  scale_color_manual(breaks = c("base.fr", "base.us", "a.data", "fill.fr"), 
                        values = rep("black", 4) %>% 
                        setNames(c("base.fr", "base.us", "a.data", "fill.fr"))) +
  ggsave(file.path(loc_result, "baseline7010.png"), width = scale_graph*5, height = scale_graph*5/2)

## Color version
bmodel_plot_LS7010 +
  scale_linetype_manual(breaks = c("base.fr", "base.us", "a.data", "fill.fr"), 
                        values = c("solid", "solid", "solid", "dashed") %>% 
                        setNames(c("base.fr", "base.us", "a.data", "fill.fr"))) +
  scale_color_manual(breaks = c("base.fr", "base.us", "a.data", "fill.fr"), 
                     values = c(brewer.pal(8, "Set1")[c(1,2)], "black", brewer.pal(8, "Set1")[1]) %>%
                       setNames(c("base.fr", "base.us", "a.data", "fill.fr"))) +
  ggsave(file.path(loc_result, "baseline7010_color.png"), width = scale_graph*5, height = scale_graph*5/2)

```

```{r bmodel_plot_LS7010}

## Core
bmodel_plot_LS7010 = baseline %>% 
  subset(Specification == "baseline") %>% 
  select(Country, Year, theta) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  mutate(variable = ifelse(Country == "France", "base.fr", "base.us")) %>% 
  rbind(.,
        fillgap %>% select(Country, Year, theta) %>% setNames(c("Country", "Year", "fill.fr")) %>% 
          melt(id.vars = c("Country", "Year"))) %>% 
  rbind(.,
        df %>% select(Country, Year, theta) %>% setNames(c("Country", "Year", "data")) %>% 
          melt(id.vars = c("Country", "Year"))
        ) %>% 
  filter(complete.cases(.)) %>% 
  subset(Year %in% c(1970:2010)) %>% 
  subset(variable != "base.fr") %>% 
  # Trick to put data line under others
  mutate(variable = as.character(variable),
         variable = ifelse(variable == "data", "data", "model.pred"),
         variable = as.factor(variable)) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = variable, color = interaction(variable, Country))) +
  geom_line() +
  facet_wrap(factor(Country,levels=c("United States","France")) ~ ., scales = "fixed") +
  theme_classic(base_size = 14) +
  theme(legend.position = c(0.1, 0.99), 
        legend.justification = c(0,1), 
        panel.spacing.x = unit(1.5, "lines"),
        # legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
bmodel_plot_LS7010 +
  scale_linetype_manual(breaks = c("data", "model.pred"), labels = c("Data", "Model Prediction"),
                        values = c("solid", "dashed") %>% setNames(c("data", "model.pred")),
                        name = element_blank()) +
  scale_color_manual(breaks = c("data.United States", "data.France", "model.pred.United States", "model.pred.France"), 
                     values = rep("black",4), 
                     name = element_blank(),
                     guide = FALSE) +
  ggsave(file.path(loc_result, "baseline7010.png"), width = scale_graph*5, height = scale_graph*5/2)

## Color version
bmodel_plot_LS7010 +
  scale_linetype_manual(breaks = c("data", "model.pred"), labels = c("Data", "Model Prediction"),
                        values = c("solid", "solid") %>% setNames(c("data", "model.pred")),
                        name = element_blank(), guide = FALSE) +
  scale_color_manual(breaks = c("data.United States", "model.pred.United States", "model.pred.France"), 
                     labels = c("Data", "Model Prediction (US)", "Model Prediction (FR)"),
                     name = element_blank(),
                     values = c(rep("black", 2), brewer.pal(8, "Set1")[c(1,2)]) %>% 
                       setNames(c("data.United States", "data.France", "model.pred.United States", "model.pred.France"))) +
  ggsave(file.path(loc_result, "baseline7010_color.png"), width = scale_graph*5, height = scale_graph*5/2)

```

```{r bmodel_plot_LS7080}

## Core
bmodel_plot_LS7080 = baseline %>% 
  subset(Specification == "baseline") %>% 
  select(Country, Year, theta) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  mutate(variable = ifelse(Country == "France", "base.fr", "base.us")) %>% 
  rbind(.,
        fillgap %>% select(Country, Year, theta) %>% setNames(c("Country", "Year", "fill.fr")) %>% 
          melt(id.vars = c("Country", "Year"))) %>% 
  rbind(.,
        df %>% select(Country, Year, theta) %>% setNames(c("Country", "Year", "data")) %>% 
          melt(id.vars = c("Country", "Year"))
        ) %>% 
  filter(complete.cases(.)) %>%  
  subset(Year %in% c(1970:2080)) %>%
  subset(variable != "base.fr") %>% 
  # Trick to put data line under others
  mutate(variable = as.character(variable),
         variable = ifelse(variable == "data", "data", "model.pred"),
         variable = as.factor(variable)) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = variable, color = interaction(variable, Country))) +
  geom_line() +
  facet_wrap(factor(Country,levels=c("United States","France")) ~ ., scales = "fixed") +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_classic(base_size = 14) +
  theme(legend.position = c(0.49, 0.99), 
        legend.justification = c("right", "top"),
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
bmodel_plot_LS7080 +
  scale_linetype_manual(breaks = c("data", "model.pred"), labels = c("Data", "Model Prediction"),
                        values = c("solid", "dashed") %>% setNames(c("data", "model.pred")),
                        name = element_blank()) +
  scale_color_manual(breaks = c("data.United States", "data.France", "model.pred.United States", "model.pred.France"), 
                     values = rep("black",4), 
                     name = element_blank(),
                     guide = FALSE) +
  ggsave(file.path(loc_result, "baseline7080.png"), width = scale_graph*5, height = scale_graph*5/2)

## Color version
bmodel_plot_LS7080 +
  scale_linetype_manual(breaks = c("data", "model.pred"), labels = c("Data", "Model Prediction"),
                        values = c("solid", "solid") %>% setNames(c("data", "model.pred")),
                        name = element_blank(), guide = FALSE) +
  scale_color_manual(breaks = c("data.United States", "model.pred.United States", "model.pred.France"), 
                     labels = c("Data", "Model Prediction (US)", "Model Prediction (FR)"),
                     name = element_blank(),
                     values = c(rep("black", 2), brewer.pal(8, "Set1")[c(1,2)]) %>% 
                       setNames(c("data.United States", "data.France", "model.pred.United States", "model.pred.France"))) +
  ggsave(file.path(loc_result, "baseline7080_color.png"), width = scale_graph*5, height = scale_graph*5/2)

```

### Variables dynamics

```{r loc_dev}

loc_dev = file.path(loc_result, "deviation")

# Computation average growth rate of p on 10 years per country
baseline %>% 
  select(Country, Year, p) %>% 
  subset(Year >= 2010) %>% 
  group_by(Country) %>% 
  mutate(p = p/dplyr::lag(p) -1) %>% 
  summarize(mean(p, na.rm = T))

```

#### Demography

```{r dev_demo7010}

## Core
dev_demo7010 = baseline %>%
  # subset(Country == "France") %>% 
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>% 
  group_by(from) %>% 
  mutate(
    # Deviation from the 1970 steady state
         "n" = n/n[Year == 1970] -1,
         "p" = p/p[Year == 1970] -1,
         "p[+1]" = p1/p1[Year == 1970] -1,
         "eta" = eta/eta[Year == 1970] -1) %>% 
  ungroup() %>% 
  select(Specification, Country , Year,
         "Population~growth~(n)"= "n", 
         "Survival~rate~(p)"= "p", 
         "Exp.~survival~rate~(p[+1])"= "p[+1]", 
         "Youth~political~weight~(eta)" = "eta") %>% 
  subset(Year %in% c(1970:2010)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  subset(Specification == "baseline") %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_x_continuous(labels = c("1970", "", "1990", "", "2010")) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
dev_demo7010 +
  scale_color_grey(breaks = c("France", "United States"), start = 0.2, end = 0.8) +
  ggsave(file.path(loc_dev, "dev_demo7010.png"), width = scale_graph*5, height = scale_graph*5/3)

## Color version
dev_demo7010 +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  ggsave(file.path(loc_dev, "dev_demo7010_color.png"), width = scale_graph*5, height = scale_graph*5/3)
  
```

```{r dev_demo1080}

## Paper version
dev_demo1080 = baseline %>%
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>% 
  group_by(from) %>% 
  mutate(
    # Deviation from the 2010 steady state
         "n" = n/n[Year == 2010] -1,
         "p" = p/p[Year == 2010] -1,
         "p[+1]" = p1/p1[Year == 2010] -1,
         "eta" = eta/eta[Year == 2010] -1) %>% 
  ungroup() %>% 
  select(Specification, Country , Year,
         "Population~growth~(n)"= "n", 
         "Survival~rate~(p)"= "p", 
         "Exp.~survival~rate~(p[+1])"= "p[+1]", 
         "Youth~political~weight~(eta)" = "eta") %>% 
  subset(Year %in% c(2010:2080)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  subset(Specification == "baseline") %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_x_continuous(breaks = seq(2010, 2080, 10), 
                     labels = c("2010","", "2030", "", "2050", "", "2070", "")) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "") 

## Paper version
dev_demo1080 +
  scale_color_grey(breaks = c("France", "United States"), start = 0.2, end = 0.8) +
  ggsave(file.path(loc_dev, "dev_demo1080.png"), width = scale_graph*5, height = scale_graph*5/3)

## Color version
dev_demo1080 +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  ggsave(file.path(loc_dev, "dev_demo1080_color.png"), width = scale_graph*5, height = scale_graph*5/3)
  
```


#### Public

```{r dev_public7010}

## Core

dev_public7010 = baseline %>%
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>% 
  group_by(from) %>% 
  mutate(`b share` = b*u*Ny/tau/Y,
         `h share` = h*No/tau/Y,
         bh = b/h,
    # Deviation from the 1970 steady state
         "eta" = eta/eta[Year == 1970] -1,
         "tau" = tau/tau[Year == 1970] -1,
         "b" = b/b[Year == 1970]-1,
         "h" = h/h[Year == 1970]-1,
         "`b share`" = `b share`/`b share`[Year == 1970]-1,
         "`h share`" = `h share`/`h share`[Year == 1970]-1,
         "b/h" = bh/bh[Year == 1970]-1) %>% 
  ungroup() %>% 
  select(Specification, Country , Year,
         "Youth~political~weight~(eta)" = "eta", 
         "Tax~rate~(tau)" = "tau", 
         "Unemp.~benefits~share" = "`b share`") %>% 
  subset(Year %in% c(1970:2010)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_x_continuous(labels = c("1970", "", "1990", "", "2010")) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
dev_public7010 +
  scale_color_grey(breaks = c("France", "United States"), start = 0.2, end = 0.8) +
  ggsave(file.path(loc_dev, "dev_public7010.png"), width = scale_graph*5, height = scale_graph*5/3)

## Color version
dev_public7010 +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  ggsave(file.path(loc_dev, "dev_public7010_color.png"), width = scale_graph*5, height = scale_graph*5/3)

```

```{r dev_public1080}

## Core
dev_public1080 = baseline %>%
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>% 
  group_by(from) %>% 
  mutate(`b share` = b*u*Ny/tau/Y,
         `h share` = h*No/tau/Y,
          bh = b/h,
    # Deviation from the 2010 steady state
         "eta" = eta/eta[Year == 2010] -1,
         "tau" = tau/tau[Year == 2010] -1,
         "b" = b/b[Year == 2010]-1,
         "h" = h/h[Year == 2010]-1,
         "`b share`" = `b share`/`b share`[Year == 2010]-1,
         "`h share`" = `h share`/`h share`[Year == 2010]-1,
         "b/h" = bh/bh[Year == 2010]-1) %>% 
  ungroup() %>% 
  select(Specification, Country , Year,
         "Youth~political~weight~(eta)" = "eta", 
         "Tax~rate~(tau)" = "tau", 
         "Unemp.~benefits~share" = "`b share`") %>% 
  subset(Year %in% c(2010:2080)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_x_continuous(breaks = seq(2010,2080,10), 
                     labels = c("2010","", "2030", "", "2050", "", "2070", "")) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
dev_public1080 +
  scale_color_grey(breaks = c("France", "United States"), start = 0.2, end = 0.8) +
  ggsave(file.path(loc_dev, "dev_public1080.png"), width = scale_graph*5, height = scale_graph*5/3)

## Color version
dev_public1080 +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  ggsave(file.path(loc_dev, "dev_public1080_color.png"), width = scale_graph*5, height = scale_graph*5/3)

```

#### Outside

```{r dev_outside7010}

## Core 
dev_outside7010 = baseline %>%
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>% 
  mutate(net = 1-tau,
         outside = b/(1-tau),
         # Deviation from the 1970 steady state
         "b" = b/b[Year == 1970] -1,
         "1-tau" = net/net[Year == 1970] -1,
         "b/(1-tau)" = outside/outside[Year == 1970] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year,
         "Unemployment~benefits~(b)" = "b", 
         "Disposable~income~rate~(1-tau)" = "1-tau", 
         "Outside~option" = "b/(1-tau)") %>% 
  subset(Year %in% c(1970:2010)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_x_continuous(labels = c("1970", "", "1990", "", "2010")) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
dev_outside7010 +
  scale_color_grey(breaks = c("France", "United States"), start = 0.2, end = 0.8) +
  ggsave(file.path(loc_dev, "dev_outside7010.png"), width = scale_graph*5, height = scale_graph*5/3)

## Color version
dev_outside7010 +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  ggsave(file.path(loc_dev, "dev_outside7010_color.png"), width = scale_graph*5, height = scale_graph*5/3)
  
```


```{r dev_outside1080}

## Core
dev_outside1080 = baseline %>%
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>% 
  mutate(net = 1-tau,
         outside = b/(1-tau),
         # Deviation from the 2010 steady state
         "b" = b/b[Year == 2010] -1,
         "1-tau" = net/net[Year == 2010] -1,
         "b/(1-tau)" = outside/outside[Year == 2010] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year, 
         "Unemployment~benefits~(b)" = "b", 
         "Disposable~income~rate~(1-tau)" = "1-tau", 
         "Outside~option" = "b/(1-tau)") %>% 
  subset(Year %in% c(2010:2080)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_x_continuous(breaks = seq(2010,2080,10), 
                     labels = c("2010","", "2030", "", "2050", "", "2070", "")) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
dev_outside1080 +
  scale_color_grey(breaks = c("France", "United States"), start = 0.2, end = 0.8) +
  ggsave(file.path(loc_dev, "dev_outside1080.png"), width = scale_graph*5, height = scale_graph*5/3)

## Color version
dev_outside1080 +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  ggsave(file.path(loc_dev, "dev_outside1080_color.png"), width = scale_graph*5, height = scale_graph*5/3)
  

```

#### Bargaining

```{r dev_bargaining7010}

## Core
dev_bargaining7010 = baseline %>%
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>% 
  mutate(outside = b/(1-tau),
         # Deviation from the 1970 steady state
         "b/(1-tau)" = outside/outside[Year == 1970] -1,
         "w" = w/w[Year == 1970] -1,
         "X" = X/X[Year == 1970] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year,
         "Outside~option" = "b/(1-tau)", 
         "Wage~rate~(w)" = "w", 
         "Job~value~added~(X)" = "X") %>% 
  subset(Year %in% c(1970:2010)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_x_continuous(labels = c("1970", "", "1990", "", "2010")) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
dev_bargaining7010 +
  scale_color_grey(breaks = c("France", "United States"), start = 0.2, end = 0.8) +
  ggsave(file.path(loc_dev, "dev_bargain7010.png"), width = scale_graph*5, height = scale_graph*5/3)

## Color version
dev_bargaining7010 +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  ggsave(file.path(loc_dev, "dev_bargain7010_color.png"), width = scale_graph*5, height = scale_graph*5/3)
  
```

```{r dev_bargaining1080}

## Core
dev_bargaining1080 = baseline %>%
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>% 
  mutate(outside = b/(1-tau),
         # Deviation from the 2010 steady state
         "eta" = eta/eta[Year == 2010] -1,
         "b/(1-tau)" = outside/outside[Year == 2010] -1,
         "w" = w/w[Year == 2010] -1,
         "X" = X/X[Year == 2010] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year,
         "Outside~option" = "b/(1-tau)", 
         "Wage~rate~(w)" = "w", 
         "Job~value~added~(X)" = "X") %>% 
  subset(Year %in% c(2010:2080)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_x_continuous(breaks = seq(2010,2080,10), 
                     labels = c("2010","", "2030", "", "2050", "", "2070", "")) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
dev_bargaining1080 +
  scale_color_grey(breaks = c("France", "United States"), start = 0.2, end = 0.8) +
  ggsave(file.path(loc_dev, "dev_bargain1080.png"), width = scale_graph*5, height = scale_graph*5/3)

## Color version
dev_bargaining1080 +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  ggsave(file.path(loc_dev, "dev_bargain1080_color.png"), width = scale_graph*5, height = scale_graph*5/3)
  
```

#### Production

```{r dev_prod7010}

## Core
dev_prod7010 = baseline %>%
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>%  
  mutate(
         # Deviation from the 1970 steady state
         "K" = K/K[Year == 1970] -1,
         "L" = L/L[Year == 1970] -1,
         "Y" = Y/Y[Year == 1970] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year, 
         "Capital~stock~(K)" = "K", 
         "Labor~(L)" = "L", 
         "Production~(Y)" = "Y") %>% 
  subset(Year %in% c(1970:2010)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  scale_x_continuous(labels = c("1970", "", "1990", "", "2010")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
dev_prod7010 +
  scale_color_grey(breaks = c("France", "United States"), start = 0.2, end = 0.8) +
  ggsave(file.path(loc_dev, "dev_prod7010.png"), width = scale_graph*5, height = scale_graph*5/3)

## Color version
dev_prod7010 +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  ggsave(file.path(loc_dev, "dev_prod7010_color.png"), width = scale_graph*5, height = scale_graph*5/3)

```


```{r dev_prod1080}

## Core
dev_prod1080 = baseline %>%
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>%  
  mutate(
         # Deviation from the 2010 steady state
         "K" = K/K[Year == 2010] -1,
         "L" = L/L[Year == 2010] -1,
         "Y" = Y/Y[Year == 2010] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year, 
         "Capital~stock~(K)" = "K",
         "Labor~(L)" = "L",
         "Production~(Y)" = "Y") %>% 
  subset(Year %in% c(2010:2080)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  scale_x_continuous(breaks = seq(2010,2080,10), 
                     labels = c("2010","", "2030", "", "2050", "", "2070", "")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
dev_prod1080 +
  scale_color_grey(breaks = c("France", "United States"), start = 0.2, end = 0.8) +
  ggsave(file.path(loc_dev, "dev_prod1080.png"), width = scale_graph*5, height = scale_graph*5/3)

## Color version
dev_prod1080 +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  ggsave(file.path(loc_dev, "dev_prod1080_color.png"), width = scale_graph*5, height = scale_graph*5/3)

```

#### Unemployment

```{r dev_unemp7010}

## Core
dev_unemp7010 = baseline %>%
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>%  
  mutate(
         # Deviation from the 1970 steady state
         "N^y" = Ny/Ny[Year == 1970] -1,
         "L" = L/L[Year == 1970] -1,
         "u" = u/u[Year == 1970] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year,
         "Young~households~(N^y)" = "N^y",
         "Labor~(L)" = "L",
         "Unemployment~rate~(u)" = "u") %>% 
  subset(Year %in% c(1970:2010)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  scale_x_continuous(labels = c("1970", "", "1990", "", "2010")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
dev_unemp7010 + 
  scale_color_grey(breaks = c("France", "United States"), start = 0.2, end = 0.8) +
  ggsave(file.path(loc_dev, "dev_unemp7010.png"), width = scale_graph*5, height = scale_graph*5/3)

## Color version
dev_unemp7010 + 
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  ggsave(file.path(loc_dev, "dev_unemp7010_color.png"), width = scale_graph*5, height = scale_graph*5/3)

```


```{r dev_unemp1080}

## Core
dev_unemp1080 = baseline %>%
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>%  
  mutate(
         # Deviation from the 2010 steady state
         "N^y" = Ny/Ny[Year == 2010] -1,
         "L" = L/L[Year == 2010] -1,
         "u" = u/u[Year == 2010] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year, 
         "Young~households~(N^y)" = "N^y", 
         "Labor~(L)" = "L", 
         "Unemployment~rate~(u)" = "u") %>% 
  subset(Year %in% c(2010:2080)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  scale_x_continuous(breaks = seq(2010,2080,10), 
                     labels = c("2010","", "2030", "", "2050", "", "2070", "")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
dev_unemp1080 + 
  scale_color_grey(breaks = c("France", "United States"), start = 0.2, end = 0.8) +
  ggsave(file.path(loc_dev, "dev_unemp1080.png"), width = scale_graph*5, height = scale_graph*5/3)

## Color version
dev_unemp1080 + 
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  ggsave(file.path(loc_dev, "dev_unemp1080_color.png"), width = scale_graph*5, height = scale_graph*5/3)

```

#### Labor share

```{r dev_laborshare7010}

## Core
dev_laborshare7010 = baseline %>%
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>%  
  mutate("YL" = Y/L,
         # Deviation from the 1970 steady state
         "w" = w/w[Year == 1970] -1,
         "u" = u/u[Year == 1970] -1,
         "Y/L" = YL/YL[Year == 1970] -1,
         "theta" = theta/theta[Year == 1970] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year,
         "Wage~rate~(w)" = "w", 
         "Production-per-worker~(Y/L)" = "Y/L", 
         "Labor~share~(theta)" = "theta") %>% 
  subset(Year %in% c(1970:2010)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  scale_x_continuous(labels = c("1970", "", "1990", "", "2010")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
dev_laborshare7010 +
  scale_color_grey(breaks = c("France", "United States"), start = 0.2, end = 0.8) +
  ggsave(file.path(loc_dev, "dev_laborshare7010.png"), width = scale_graph*5, height = scale_graph*5/3)
  
## Color version
dev_laborshare7010 +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  ggsave(file.path(loc_dev, "dev_laborshare7010_color.png"), width = scale_graph*5, height = scale_graph*5/3)

```

```{r dev_laborshare1080}

## Core
dev_laborshare1080 = baseline %>%
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>%  
  mutate("YL" = Y/L,
         # Deviation from the 2010 steady state
         "w" = w/w[Year == 2010] -1,
         "u" = u/u[Year == 2010] -1,
         "Y/L" = YL/YL[Year == 2010] -1,
         "theta" = theta/theta[Year == 2010] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year,
         "Wage~rate~(w)" = "w", 
         "Production-per-worker~(Y/L)" = "Y/L", 
         "Labor~share~(theta)" = "theta") %>% 
  subset(Year %in% c(2010:2080)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "fixed", nrow = 1, labeller = label_parsed) +
  scale_x_continuous(breaks = seq(2010, 2080, 10),
                     labels = c("2010","", "2030", "", "2050", "", "2070", "")) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
dev_laborshare1080 +
  scale_color_grey(breaks = c("France", "United States"), start = 0.2, end = 0.8) +
  ggsave(file.path(loc_dev, "dev_laborshare1080.png"), width = scale_graph*5, height = scale_graph*5/3)

## Color version
dev_laborshare1080 +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  ggsave(file.path(loc_dev, "dev_laborshare1080_color.png"), width = scale_graph*5, height = scale_graph*5/3)

```

#### Multiple variables deviation

```{r dev_multiple7010}

dev_multiple7010 = baseline %>%
  subset(Country == "United States") %>% 
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>%  
  mutate("outside" = b/(1-tau),
         # Deviation from the 1970 steady state
         "eta" = eta/eta[Year == 1970] -1,
         "outside" = outside/outside[Year == 1970] -1,
         "w" = w/w[Year == 1970] -1,
         "L" = L/L[Year == 1970] -1,
         "u" = u/u[Year == 1970] -1,
         "K" = K/K[Year == 1970] -1,
         "Y" = Y/Y[Year == 1970] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year,
         "Youth~political~power~(eta)" = "eta",
         # "Outside~option" = "outside",
         "Wage~rate~(w)" = "w", 
         "Labor~(L)" = "L", 
         "Unemployment~rate~(u)" = "u",
         # "Capital~(K)" = "K",
         "Output~(Y)" = "Y") %>% 
  subset(Year %in% c(1970:2010)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>%
  mutate(Country = factor(Country, levels = c("United States", "France"))) %>% 
  
  ggplot(aes(x = Year, y = value, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "free", nrow = 2, labeller = label_parsed) +
  scale_x_continuous(breaks = seq(1970, 2010, 10),
                     labels = c("1970","", "1990", "", "2010")) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  theme_classic(base_size = 14) +
  theme(legend.position = c(0.75, 0.15), legend.justification = c("left", "bottom"), legend.direction = "vertical",
        panel.spacing.x = unit(1, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  guides(color = guide_legend(reverse = TRUE)) +
  labs(x = "", y = "")

## Paper version
dev_multiple7010 +
  scale_color_grey(breaks = c("France", "United States"), start = 0.2, end = 0.8) +
  ggsave(file.path(loc_dev, "dev_multiple7010.png"), width = scale_graph*5, height = scale_graph*5/2)

## Color version
dev_multiple7010 +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  ggsave(file.path(loc_dev, "dev_multiple7010_color.png"), width = scale_graph*5, height = scale_graph*5/2)

```

```{r dev_multiple1080}

dev_multiple1080 = baseline %>%
  subset(Country == "United States") %>% 
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>%
  group_by(from) %>%  
  mutate("outside" = b/(1-tau),
         # Deviation from the 2010 steady state
         "eta" = eta/eta[Year == 2010] -1,
         "outside" = outside/outside[Year == 2010] -1,
         "w" = w/w[Year == 2010] -1,
         "L" = L/L[Year == 2010] -1,
         "u" = u/u[Year == 2010] -1,
         "K" = K/K[Year == 2010] -1,
         "Y" = Y/Y[Year == 2010] -1) %>% 
  ungroup() %>% 
  select(Specification, Country, Year,
         "Youth~political~power~(eta)" = "eta",
         # "Outside~option" = "outside",
         "Wage~rate~(w)" = "w", 
         "Labor~(L)" = "L", 
         "Unemployment~rate~(u)" = "u",
         # "Capital~(K)" = "K",
         "Output~(Y)" = "Y") %>% 
  subset(Year %in% c(2010:2080)) %>% 
  melt(id.vars = c("Specification", "Country", "Year")) %>%
  mutate(Country = factor(Country, levels = c("United States", "France"))) %>% 
  
  ggplot(aes(x = Year, y = value, color = Country)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_wrap(variable ~ ., scales = "free", nrow = 2, labeller = label_parsed) +
  scale_x_continuous(breaks = seq(2010, 2080, 10),
                     labels = c("2010","", "2030", "", "2050", "", "2070", "")) +
  scale_linetype_manual(breaks = c("baseline", "fillgap"), values = c("solid", "dashed")) +
  theme_classic(base_size = 14) +
  theme(legend.position = c(0.75, 0.15), legend.justification = c("left", "bottom"), legend.direction = "vertical",
        panel.spacing.x = unit(1, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  guides(color = guide_legend(reverse = TRUE)) +
  labs(x = "", y = "")

## Paper version
dev_multiple1080 +
  scale_color_grey(breaks = c("France", "United States"), start = 0.2, end = 0.8) +
  ggsave(file.path(loc_dev, "dev_multiple1080.png"), width = scale_graph*5, height = scale_graph*5/2)

## Color version
dev_multiple1080 +
  scale_color_manual(breaks = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)]) +
  ggsave(file.path(loc_dev, "dev_multiple1080_color.png"), width = scale_graph*5, height = scale_graph*5/2)

```

```{r clean_dev}

# Clean the environment of all "dev_" graphs
rm(list = ls(pattern = "dev_"))

```


### Redistribution

I only consider France in the fillgap specification, so the one with a break in the regime of the elasticity of substitution. I also consider the baseline specification for the United-States.

```{r redistribution}

# Location save graphs
loc_redis = file.path(loc_result, "redistribution")

# Data selection
redis = baseline %>%
  rbind(fillgap) %>% 
  mutate(from = interaction(Specification, Country)) %>%
  subset(from != "baseline.France") %>% 
  select(-from) %>% 
  group_by(Country) %>% 
  
  mutate(
    # Step 1
    wL = w*L,
    rK = r*K,
    # Step 2
    wL_net = (1-tau)*wL,
    rK_net = (1-tau)*rK,
    gov_rev = tau*Y,
    # Step 3
    unemp_ben = b*u*Ny,
    health_spen = h*No,
    # Step 4
    C1 = 1/(1+alpha*p1)*(wL_net+unemp_ben),
    Saving = alpha*p1/(1+alpha*p1)*(wL_net+unemp_ben),
    C2 = rK_net,
    # Incomes
    inc_y = wL_net + unemp_ben,
    inc_o = rK_net,
    # Labor share
    theta = wL/Y
    ) %>% 
  select(Country, Year, wL, rK, wL_net, rK_net, gov_rev, unemp_ben, health_spen,
         C1, Saving, C2, inc_y, inc_o, Y, theta, eta) %>% 
  ungroup()

```

```{r redis_step1}

## Core
redis_step1 = redis %>% 
  mutate(wL_bis = wL) %>% 
  select(Country, Year, rK, wL, wL_bis) %>% 
  melt(id.vars = c("Country", "Year", "wL_bis")) %>% 
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable)) +
  geom_line(aes(y = wL_bis), linetype = "dashed", color = "black") +
  facet_wrap(factor(Country,levels=c("United States","France")) ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_classic(base_size = 14) +
  theme(legend.position = "bottom", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(), axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
redis_step1 +
  scale_fill_grey(name = "", 
                  breaks = c("rK", "wL"), labels = c("Capital income", "Labor income"), 
                  start = 0.5, end = 0.9)

## Color version
redis_step1 +
  scale_fill_manual(name = "",
                    breaks = c("rK", "wL"), labels = c("Capital income", "Labor income"),
                    values = brewer.pal(11, "Set3")[c(4,5)], na.value = "black")

```


```{r redis_step1_stacked}

## Core
redis_step1_stacked = redis %>% 
  mutate(wL = wL/Y,
         rK = rK/Y) %>% 
  select(Country, Year, rK, wL, theta) %>% 
  melt(id.vars = c("Country", "Year", "theta")) %>% 
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable)) +
  geom_line(aes(y = theta), linetype = "dashed", color = "black") +
  facet_wrap(factor(Country,levels=c("United States","France")) ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_classic(base_size = 14) +
  theme(legend.position = "bottom", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank()) +
  labs(x = "", y = "Share of GDP")

## Paper version
redis_step1_stacked +
  scale_fill_grey(name = "", 
                  breaks = c("rK", "wL"), labels = c("Capital income", "Labor income"), 
                  start = 0.5, end = 0.9) +
  ggsave(file.path(loc_redis, "redis_step1_stacked.png"), width = scale_graph*5, height = scale_graph*5/2)

## Color version
redis_step1_stacked +
  scale_fill_manual(name = "",
                    breaks = c("rK", "wL"), labels = c("Capital income", "Labor income"),
                    values = brewer.pal(11, "Set3")[c(4,5)], na.value = "black") +
  ggsave(file.path(loc_redis, "redis_step1_stacked_color.png"), width = scale_graph*5, height = scale_graph*5/2)

```

```{r redis_step2}

## Core
redis_step2 = redis %>% 
  select(Country, Year, rK_net, gov_rev, wL_net, wL) %>% 
  melt(id.vars = c("Country", "Year", "wL")) %>% 
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable)) +
  geom_line(aes(y = wL), linetype = "dashed", color = "black") +
  facet_wrap(factor(Country,levels=c("United States","France")) ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_classic(base_size = 14) +
  theme(legend.position = "bottom", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(), axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
redis_step2 +
  scale_fill_grey(name = "", 
                  breaks = c("rK_net", "gov_rev", "wL_net"), 
                  labels = c("Net capital income", "Government revenue", "Net labor income"), 
                  start = 0.5, end = 0.9)

## Color version
redis_step2 + 
  scale_fill_manual(name = "", 
                    breaks = c("rK_net", "gov_rev", "wL_net"), 
                    labels = c("Net capital income", "Government revenue", "Net labor income"),
                    values = brewer.pal(11, "Set3")[c(4,7,5)], na.value = "black")

```


```{r redis_step2_stacked}

## Core
redis_step2_stacked = redis %>% 
  mutate(wL_net = wL_net/Y,
         gov_rev = gov_rev/Y,
         rK_net = rK_net/Y) %>% 
  select(Country, Year, rK_net, gov_rev, wL_net, theta) %>% 
  melt(id.vars = c("Country", "Year", "theta")) %>% 
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable)) +
  geom_line(aes(y = theta), linetype = "dashed", color = "black") +
  facet_wrap(factor(Country,levels=c("United States","France")) ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_classic(base_size = 14) +
  theme(legend.position = "bottom", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank()) +
  labs(x = "", y = "Share of GDP")

## Paper version
redis_step2_stacked +
  scale_fill_grey(name = "", 
                  breaks = c("rK_net", "gov_rev", "wL_net"), 
                  labels = c("Net capital income", "Government revenue", "Net labor income"), 
                  start = 0.5, end = 0.9)
  ggsave(file.path(loc_redis, "redis_step2_stacked.png"), width = scale_graph*5, height = scale_graph*5/2)

## Color version
redis_step2_stacked +
  scale_fill_manual(name = "", 
                    breaks = c("rK_net", "gov_rev", "wL_net"), 
                    labels = c("Net capital income", "Government revenue", "Net labor income"),
                    values = brewer.pal(11, "Set3")[c(4,7,5)], na.value = "black") +
  ggsave(file.path(loc_redis, "redis_step2_stacked_color.png"), width = scale_graph*5, height = scale_graph*5/2)

```

```{r redis_step3}

## Core
redis_step3 = redis %>% 
  select(Country, Year, rK_net, health_spen, unemp_ben, wL_net, wL) %>% 
  melt(id.vars = c("Country", "Year", "wL")) %>% 
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable)) +
  geom_line(aes(y = wL), linetype = "dashed", color = "black") +
  facet_wrap(factor(Country,levels=c("United States","France")) ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_classic(base_size = 14) +
  theme(legend.position = "bottom", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(), axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
redis_step3 +
  scale_fill_grey(name = "", 
                  breaks = c("rK_net", "health_spen", "unemp_ben", "wL_net"),
                  labels = c("Net capital income", "Health spending", 
                             "Unemployment spending", "Net labor income"),
                  start = 0.5, end = 0.9)

## Color version
redis_step3 + 
  scale_fill_manual(name = "", 
                  breaks = c("rK_net", "health_spen", "unemp_ben", "wL_net"),
                  labels = c("Net capital income", "Health spending", 
                             "Unemployment spending", "Net labor income"),
                    values = brewer.pal(11, "Set3")[c(4,6,3,5)], na.value = "black")

```


```{r redis_step3_stacked}

## Core
redis_step3_stacked = redis %>% 
  mutate(wL_net = wL_net/Y,
         unemp_ben = unemp_ben/Y,
         health_spen = health_spen/Y,
         rK_net = rK_net/Y) %>% 
  select(Country, Year, rK_net, health_spen, unemp_ben, wL_net, theta) %>% 
  melt(id.vars = c("Country", "Year", "theta")) %>%
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable)) +
  geom_line(aes(y = theta), linetype = "dashed", color = "black") +
  facet_wrap(factor(Country,levels=c("United States","France")) ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_classic(base_size = 14) +
  theme(legend.position = "bottom", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank()) +
  labs(x = "", y = "Share of GDP")

## Paper version
redis_step3_stacked +
  scale_fill_grey(name = "", 
                  breaks = c("rK_net", "health_spen", "unemp_ben", "wL_net"),
                  labels = c("Net capital income", "Health spending", 
                             "Unemployment spending", "Net labor income"),
                  start = 0.5, end = 0.9)
  ggsave(file.path(loc_redis, "redis_step3_stacked.png"), width = scale_graph*5, height = scale_graph*5/2)

## Color version
redis_step3_stacked +
  scale_fill_manual(name = "", 
                    breaks = c("rK_net", "health_spen", "unemp_ben", "wL_net"), 
                    labels = c("Net capital income", "Health spending", 
                               "Unemployment spending", "Net labor income"),
                    values = brewer.pal(11, "Set3")[c(4,6,3,5)], na.value = "black") +
  ggsave(file.path(loc_redis, "redis_step3_stacked_color.png"), width = scale_graph*5, height = scale_graph*5/2)

```

```{r redis_step4}
## Core
redis_step3 = redis %>% 
  select(Country, Year, C2, health_spen, Saving, C1, wL) %>% 
  melt(id.vars = c("Country", "Year", "wL")) %>% 
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable)) +
  geom_line(aes(y = wL), linetype = "dashed", color = "black") +
  facet_wrap(factor(Country,levels=c("United States","France")) ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_classic(base_size = 14) +
  theme(legend.position = "bottom", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(), axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
redis_step3 +
  scale_fill_grey(name = "", 
                  breaks = c("C2", "health_spen", "Saving", "C1"),
                  labels = c("Old HH. cons.", "Health spending", "Savings", "Young HH. cons."),
                  start = 0.5, end = 0.9)

## Color version
redis_step3 + 
  scale_fill_manual(name = "", 
                  breaks = c("C2", "health_spen", "Saving", "C1"),
                  labels = c("Old HH. cons.", "Health spending", "Savings", "Young HH. cons."),
                  values = brewer.pal(11, "Set3")[c(4,6,8,10)], na.value = "black")

```



```{r redis_step4_stacked}

## Core
redis_step4_stacked = redis %>% 
  mutate(C2 = C2/Y,
         health_spen = health_spen/Y,
         Saving = Saving/Y,
         C1 = C1/Y) %>% 
  select(Country, Year, C2, health_spen, Saving, C1, theta) %>% 
  melt(id.vars = c("Country", "Year", "theta")) %>% 
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable)) +
  geom_line(aes(y = theta), linetype = "dashed", color = "black") +
  facet_wrap(factor(Country,levels=c("United States","France")) ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_classic(base_size = 14) +
  theme(legend.position = "bottom", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank()) +
  labs(x = "", y = "Share of GDP")

## Paper version
redis_step4_stacked +
  scale_fill_grey(name = "", 
                  breaks = c("C2", "health_spen", "Saving", "C1"),
                  labels = c("Old HH. cons.", "Health spending", "Savings", "Young HH. cons."),
                  start = 0.5, end = 0.9)
  ggsave(file.path(loc_redis, "redis_step4_stacked.png"), width = scale_graph*5, height = scale_graph*5/2)

## Color version
redis_step4_stacked +
  scale_fill_manual(name = "", 
                  breaks = c("C2", "health_spen", "Saving", "C1"),
                  labels = c("Old HH. cons.", "Health spending", "Savings", "Young HH. cons."),
                  values = brewer.pal(11, "Set3")[c(4,6,8,10)], na.value = "black") +
  ggsave(file.path(loc_redis, "redis_step4_stacked_color.png"), width = scale_graph*5, height = scale_graph*5/2)

```

```{r ls_raw_vs_net}

## Core
ls_raw_vs_net = redis %>% 
  mutate(net_ls = (wL_net + unemp_ben)/(Y - health_spen)) %>% 
  select(Country, Year, theta, net_ls) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = variable, color = Country)) +
  geom_line() +
  facet_wrap(factor(Country,levels=c("United States","France")) ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  scale_linetype_manual(name = "Labor share", breaks = c("theta", "net_ls"),
                        labels = c("Raw", "Net"), values = c("solid", "dashed"), 
                        guide = FALSE) +
  theme_classic(base_size = 14) +
  labs(x = "", y = "") +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(), axis.title.y = element_blank())

## Paper version
ls_raw_vs_net +
  scale_color_manual(name = "", breaks = c("France", "United States"),
                     labels = c("France", "United States"), values = c("black", "black"), 
                     guide = FALSE) +
  ggsave(file.path(loc_redis, "ls_raw_vs_net.png"), width = scale_graph*5, height = scale_graph*5/2)
  
## Color version
ls_raw_vs_net +
  scale_color_manual(name = "", breaks = c("France", "United States"),
                     labels = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)], 
                     guide = FALSE) +
  ggsave(file.path(loc_redis, "ls_raw_vs_net_color.png"), width = scale_graph*5, height = scale_graph*5/2)
  
```

```{r dev_ls_raw_vs_net}

## Core
dev_ls_raw_vs_net = redis %>% 
  group_by(Country) %>% 
  mutate(
    net_ls = (wL_net + unemp_ben)/(Y),
    theta = theta/theta[Year == 1970] -1,
    net_ls = net_ls/net_ls[Year == 1970] -1,
    ) %>% 
  select(Country, Year, theta, net_ls) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  mutate(Country = factor(Country, levels = c("United States","France"))) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = variable, color = Country)) +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  facet_wrap(Country ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  scale_linetype_manual(name = "Labor share", breaks = c("theta", "net_ls"),
                        labels = c("Raw", "Net"), values = c("solid", "dashed"),
                        guide = FALSE) +
  theme_classic(base_size = 14) +
  labs(x = "", y = "") +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(), axis.title.y = element_blank())

## Paper version
dev_ls_raw_vs_net +
  scale_color_manual(name = "", breaks = c("United States", "France"),
                     labels = c("United States", "France"), values = c("black", "black"),
                     guide = FALSE) +
  ggsave(file.path(loc_redis, "dev_ls_raw_vs_net.png"), width = scale_graph*5, height = scale_graph*5/2)

## Color version
dev_ls_raw_vs_net +
  scale_color_manual(name = "", breaks = c("France", "United States"),
                     labels = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)],
                     guide = FALSE) +
  ggsave(file.path(loc_redis, "dev_ls_raw_vs_net_color.png"), width = scale_graph*5, height = scale_graph*5/2)


```

```{r incratio_raw_vs_net}

## Core
incratio_raw_vs_net = redis %>% 
  select(Country, Year, inc_y, inc_o, wL, rK, health_spen, eta) %>% 
  mutate(inc_ratio = inc_y/inc_o,
         inc_ratio_with_h = inc_y/(inc_o + health_spen),
         lab_to_cap_ratio = wL/rK) %>% 
  select(Country, Year, lab_to_cap_ratio, inc_ratio, inc_ratio_with_h) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = variable)) +
  geom_line() +
  facet_wrap(factor(Country, levels = c("United States","France")) ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  scale_linetype_manual(name = "", breaks = c("lab_to_cap_ratio", "inc_ratio", "inc_ratio_with_h"),
                        labels = c("Labor-to-capital income ratio",
                                   "Young-to-old income ratio",
                                   "Young-to-old income ratio (with health spending)"),
                        values = c("solid", "dashed", "dotted")) +
  theme_classic(base_size = 14) +
  labs(x = "", y = "") +
  theme(legend.position = "none", panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(), axis.title.y = element_blank())

## Paper version
incratio_raw_vs_net +
  scale_color_manual(name = "", breaks = c("France", "United States"),
                     labels = c("France", "United States"), values = c("black", "black"), 
                     guide = FALSE) +
  ggsave(file.path(loc_redis, "incratio_raw_vs_net.png"), width = scale_graph*5, height = scale_graph*5/2)
  
## Color version
incratio_raw_vs_net +
  scale_color_manual(name = "", breaks = c("France", "United States"),
                     labels = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)], 
                     guide = FALSE) +
  ggsave(file.path(loc_redis, "incratio_raw_vs_net_color.png"), width = scale_graph*5, height = scale_graph*5/2)

```

```{r dev_incratio_raw_vs_net}

## Core
dev_incratio_raw_vs_net = redis %>% 
  select(Country, Year, inc_y, inc_o, wL, rK, health_spen, eta) %>% 
  group_by(Country) %>% 
  mutate(inc_ratio = inc_y/inc_o,
         #inc_ratio_with_h = inc_y/(inc_o + health_spen),
         lab_to_cap_ratio = wL/rK,
         # Deviations
         inc_ratio = inc_ratio/inc_ratio[Year == 1970] -1,
         #inc_ratio_with_h = inc_ratio_with_h/inc_ratio_with_h[Year == 1970] -1,
         lab_to_cap_ratio = lab_to_cap_ratio/lab_to_cap_ratio[Year == 1970] -1,) %>% 
  select(Country, Year, lab_to_cap_ratio, inc_ratio) %>% 
  melt(id.vars = c("Country", "Year")) %>% 
  mutate(Country = factor(Country, levels = c("United States", "France"))) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = variable, color = Country)) +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dotted") +
  facet_wrap(Country ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  scale_linetype_manual(name = "Income ratio", breaks = c("lab_to_cap_ratio",
                                              "inc_ratio"),
                          labels = c("Labor-to-capital",
                                     "Young-to-old"),
                        values = c("solid", "dashed", "dotted")) +
  theme_classic(base_size = 14) +
  labs(x = "", y = "") +
  theme(legend.position = c(0.99, 0.99), legend.justification = c("right", "top"), panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(), axis.title.y = element_blank())

## Paper version
dev_incratio_raw_vs_net +
  scale_color_manual(name = "", breaks = c("France", "United States"),
                     labels = c("France", "United States"), values = c("black", "black"),
                     guide = FALSE) +
  ggsave(file.path(loc_redis, "dev_incratio_raw_vs_net.png"), width = scale_graph*5, height = scale_graph*5/2)

## Color version
dev_incratio_raw_vs_net +
  scale_color_manual(name = "", breaks = c("France", "United States"),
                     labels = c("France", "United States"), values = brewer.pal(8, "Set1")[c(1,2)],
                     guide = FALSE) +
  ggsave(file.path(loc_redis, "dev_incratio_raw_vs_net_color.png"),
         width = scale_graph*5, height = scale_graph*5/2)

```

### Counterfactual and Decomposition

#### Simulation

```{r decomp_sim}

# Re initialize result data frame
result = result[0,]

# Define break_year
break_year = 1970

## Aging effect decomposition : Survival rate versus Population growth
  for(sr in c("TSR", "FSR")){
    for(pg in c("TPG", "FPG")){
      
      spe = paste0("counter_", break_year, "_", pg, ".", sr, ".", "TDE", ".", "TIE")
      
      # Prepare data
      data = data_base %>% 
      # No biased technical change
      mutate(AK = 1, AL = 1) %>% 
      # Add parameters
      merge(param) %>% 
      # Demography
      demo_changer(break_year = break_year, p1_equals_p_fix = FALSE, PG = pg, SR = sr) %>% 
      # Define specification model
      mutate(Specification = spe) %>%
      # Reorder variables
      select(Specification, everything())
      
      
      # Simulate the model for each country
      for(country in country_set){
          
          result = data %>%
            subset(Country == country) %>% 
            model(time = 3) %>% 
            rbind(result, .)
          
      }
    }
  }

## Aging effect decomposition : Direct effect versus Indirect effect
  for(de in c("TDE", "FDE")){
    for(ie in c("TIE", "FIE")){
      
      spe = paste0("counter_", break_year, "_", "TPG", ".", "TSR", ".", de, ".", ie)
      
      # Prepare data
      data = data_base %>% 
      # No biased technical change
      mutate(AK = 1, AL = 1) %>% 
      # Add parameters
      merge(param) %>% 
      # Demography
      demo_changer(break_year = break_year, p1_equals_p_fix = FALSE, DE = de, IE = ie) %>% 
      # Define specification model
      mutate(Specification = spe) %>%
      # Reorder variables
      select(Specification, everything())
      
      
      # Simulate the model for each country
      for(country in country_set){
          
          result = data %>%
            subset(Country == country) %>% 
            model(time = 3) %>% 
            rbind(result, .)
          
      }
    }
  }

# Remove duplicates
final = distinct(result)

# Model specification details
final = final %>% mutate(PG = ifelse(grepl("TPG", Specification), "TPG", "FPG"),
                 SR = ifelse(grepl("TSR", Specification), "TSR", "FSR"),
                 DE = ifelse(grepl("TDE", Specification), "TDE", "FDE"),
                 IE = ifelse(grepl("TIE", Specification), "TIE", "FIE"),
                 break_year = as.numeric(gsub("[^0-9]", "\\1", Specification))) %>% 
  select(Specification, break_year, PG, SR, DE, IE, everything())

# Write final_counter
write.csv(final, file.path(loc_sim, paste0("final_", "counter", ".csv")), row.names = FALSE)

```

##### Counterfactual

```{r counter_data_prep}

# Decomposition / Counter location
loc_decomp = file.path(loc_result, "decomposition")

# Reshape dataframe
decomp = final %>% 
  select(Country, Specification, Year, theta) %>% 
  rbind(., 
        df %>% 
          mutate(Specification = paste0("data_", break_year)) %>%
          select(Specification, Country, Year, theta))  %>% 
  mutate(from = ifelse(!grepl("data", Specification), "sim", "data")) %>%
  filter(complete.cases(.)) %>% 
  mutate(PG = ifelse(from == "data", NA, ifelse(grepl("TPG", Specification), "TPG", "FPG")),
         SR = ifelse(from == "data", NA, ifelse(grepl("TSR", Specification), "TSR", "FSR")),
         DE = ifelse(from == "data", NA, ifelse(grepl("TDE", Specification), "TDE", "FDE")),
         IE = ifelse(from == "data", NA, ifelse(grepl("TIE", Specification), "TIE", "FIE")),
         break_year = as.numeric(gsub("[^0-9]", "\\1", Specification))) %>% 
  select(Specification, break_year, PG, SR, DE, IE, everything())

```

```{r counter_pgsr}

## Core
counter_pgsr = decomp %>% 
  subset(DE %in% c("TDE", NA) & IE %in% c("TIE", NA)) %>%
  subset(break_year == break_year) %>% 
  mutate(PGSR = as.character(interaction(PG, SR)),
         PGSR = ifelse(from == "data", "data", PGSR),
         PGSR = as.factor(PGSR)) %>% 
  
  ggplot(aes(x = Year, y = theta, color = PGSR, linetype = PGSR)) +
  facet_wrap(factor(Country, levels = c("United States","France")) ~ .) +
  geom_line() +
  # geom_label_repel(aes(label = round(theta, 3)),
  #                  data = subset(decomp, Year == 2080 & DE == "TDE" & IE == "TIE" &
  #                                  break_year == 1970), 
  #                  nudge_x = 0, na.rm = TRUE,
  #                  segment.color = "transparent") +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_classic(base_size = 14) +
  theme(legend.position = c(0.49, 0.99), legend.justification = c("right", "top"),
        legend.direction = "vertical",
        axis.title.x = element_blank(), axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
counter_pgsr +
  scale_linetype_manual(breaks = c("data","TPG.TSR", "TPG.FSR",
                                "FPG.TSR", "FPG.FSR"),
                        labels = c("Data", "Benchmark", expression(p[1970]),
                                expression(n[1970]), expression(p[1970]*", "*n[1970])),
                        values = c("solid", "dashed", "twodash", "dotted", "solid") %>% 
                       setNames(c("TPG.TSR", "TPG.FSR", "FPG.TSR", "FPG.FSR", "data")),
                     name = element_blank()) +
  scale_color_manual(breaks = c("data","TPG.TSR", "TPG.FSR", "FPG.TSR", "FPG.FSR"), 
                   labels = c("Data", "Benchmark", expression(p[1970]), 
                              expression(n[1970]), expression(p[1970]*", "*n[1970])),
                   values = c("grey", rep("black", 4)),
                     name = element_blank()) +
  ggsave(file.path(loc_decomp, "counter_PGSR.png"), width = scale_graph*5, height = scale_graph*5/2)

## Color version
counter_pgsr +
  scale_linetype_manual(breaks = c("data","TPG.TSR", "TPG.FSR", "FPG.TSR", "FPG.FSR"),
                        labels = c("Data", "Benchmark", expression(p[1970]),
                                expression(n[1970]), expression(p[1970]*", "*n[1970])),
                        values = c(rep("dashed", 4), "solid") %>% 
                       setNames(c("TPG.TSR", "TPG.FSR", "FPG.TSR", "FPG.FSR", "data")),
                     name = element_blank()) +
  scale_color_manual(breaks = c("data","TPG.TSR", "TPG.FSR", "FPG.TSR", "FPG.FSR"),
                   labels = c("Data", "Benchmark", expression(p[1970]),
                              expression(n[1970]), expression(p[1970]*", "*n[1970])),
                   values = c(brewer.pal(8, "Set1")[c(1:4)], "black") %>% 
                       setNames(c("TPG.TSR", "TPG.FSR", "FPG.TSR", "FPG.FSR", "data")),
                     name = element_blank(),) +
  ggsave(file.path(loc_decomp, "counter_PGSR_color.png"), width = scale_graph*5, height = scale_graph*5/2)

```

```{r counter_deie}

## Core
counter_deie = decomp %>% 
  subset(PG %in% c("TPG", NA) & SR %in% c("TSR", NA)) %>%
  subset(break_year == break_year) %>% 
  mutate(DEIE = as.character(interaction(DE, IE)),
         DEIE = ifelse(from == "data", "data", DEIE),
         DEIE = as.factor(DEIE)) %>% 
  
  ggplot(aes(x = Year, y = theta, color = DEIE, linetype = DEIE)) +
  facet_wrap(factor(Country, levels = c("United States","France")) ~ .) +
  geom_line() +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_classic(base_size = 14) +
  theme(legend.position = c(0.49, 0.99), legend.justification = c("right", "top"),
        legend.direction = "vertical",
        axis.title.x = element_blank(), axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
counter_deie +
  scale_linetype_manual(breaks = c("data","TDE.TIE", "TDE.FIE", "FDE.TIE", "FDE.FIE"),
                     labels = c("Data", "Benchmark", 
                                expression(eta[1970]),
                                expression(p[1970]*", "*n[1970]),
                                expression(p[1970]*", "*n[1970]*", "*eta[1970])),
                     values = c("solid", "dashed", "twodash", "dotted", "solid") %>% 
                       setNames(c("TDE.TIE", "TDE.FIE", "FDE.TIE", "FDE.FIE", "data")),
                     name = element_blank()) +
  scale_color_manual(breaks = c("data","TDE.TIE", "TDE.FIE", "FDE.TIE", "FDE.FIE"),
                     labels = c("Data", "Benchmark", 
                                expression(eta[1970]),
                                expression(p[1970]*", "*n[1970]),
                                expression(p[1970]*", "*n[1970]*", "*eta[1970])),
                   values = c(rep("black", 4), "grey") %>% 
                       setNames(c("TDE.TIE", "TDE.FIE", "FDE.TIE", "FDE.FIE", "data")),
                     name = element_blank()) +
  ggsave(file.path(loc_decomp, "counter_DEIE.png"), width = scale_graph*5, height = scale_graph*5/2)

# Color version
counter_deie +
  scale_linetype_manual(breaks = c("data","TDE.TIE", "TDE.FIE", "FDE.TIE", "FDE.FIE"),
                     labels = c("Data", "Benchmark", 
                                expression(eta[1970]),
                                expression(p[1970]*", "*n[1970]),
                                expression(p[1970]*", "*n[1970]*", "*eta[1970])),
                     values = c(rep("dashed", 4), "solid") %>% 
                       setNames(c("TDE.TIE", "TDE.FIE", "FDE.TIE", "FDE.FIE", "data")),
                     name = element_blank(),) +
  scale_color_manual(breaks = c("data","TDE.TIE", "TDE.FIE", "FDE.TIE", "FDE.FIE"),
                     labels = c("Data", "Benchmark", 
                                expression(eta[1970]),
                                expression(p[1970]*", "*n[1970]),
                                expression(p[1970]*", "*n[1970]*", "*eta[1970])),
                   values = c(brewer.pal(8, "Set1")[c(1,5,8,4)], "black") %>% 
                       setNames(c("TDE.TIE", "TDE.FIE", "FDE.TIE", "FDE.FIE", "data")),
                     name = element_blank(),) +
  ggsave(file.path(loc_decomp, "counter_DEIE_color.png"), width = scale_graph*5, height = scale_graph*5/2)

```

#### Decomposition

```{r decomp_data_prep}

decomp2 = final %>% 
  select(Country, Specification, Year, theta) %>% 
  mutate(PG = ifelse(Specification == "data", NA,
                     ifelse(grepl("TPG", Specification), "TPG", "FPG")),
         SR = ifelse(Specification == "data", NA, 
                     ifelse(grepl("TSR", Specification), "TSR", "FSR")),
         DE = ifelse(Specification == "data", NA, 
                     ifelse(grepl("TDE", Specification), "TDE", "FDE")),
         IE = ifelse(Specification == "data", NA, 
                     ifelse(grepl("TIE", Specification), "TIE", "FIE")),
         break_year = as.numeric(gsub("[^0-9]", "\\1", Specification)),
         Spe_PGSR = interaction(PG, SR),
         Spe_DEIE = interaction(DE, IE)) %>% 
  select(Country, Year, break_year, Spe_PGSR, Spe_DEIE, theta) %>% 
  dcast(Country + Year + break_year ~ Spe_PGSR + Spe_DEIE, value.var = "theta") %>% 
  setNames(c("Country", "Year", "break_year",
             "FPG.FSR", "TPG.FSR", "FPG.TSR", 
             "FDE.FIE", "TDE.FIE", "FDE.TIE",
             "benchmark")) %>% 
  mutate(FPG.TSR = (benchmark - FPG.TSR)*100,
         TPG.FSR = (benchmark - TPG.FSR)*100,
         FPG.FSR = (benchmark - FPG.FSR)*100,
         FPG.FSR = FPG.FSR - FPG.TSR - TPG.FSR,
         position_PGSR = (FPG.TSR + TPG.FSR + FPG.FSR),
         FPG.TSR.share = abs(FPG.TSR)/(abs(FPG.TSR) + abs(TPG.FSR) + abs(FPG.FSR)),
         TPG.FSR.share = abs(TPG.FSR)/(abs(FPG.TSR) + abs(TPG.FSR) + abs(FPG.FSR)),
         FPG.FSR.share = abs(FPG.FSR)/(abs(FPG.TSR) + abs(TPG.FSR) + abs(FPG.FSR)),
         FDE.TIE = (benchmark - FDE.TIE)*100,
         TDE.FIE = (benchmark - TDE.FIE)*100,
         FDE.FIE = (benchmark - FDE.FIE)*100,
         FDE.FIE = FDE.FIE - FDE.TIE - TDE.FIE,
         position_DEIE = (FDE.TIE + TDE.FIE + FDE.FIE),
         FDE.TIE.share = abs(FDE.TIE)/(abs(FDE.TIE) + abs(TDE.FIE) + abs(FDE.FIE)),
         TDE.FIE.share = abs(TDE.FIE)/(abs(FDE.TIE) + abs(TDE.FIE) + abs(FDE.FIE)),
         FDE.FIE.share = abs(FDE.FIE)/(abs(FDE.TIE) + abs(TDE.FIE) + abs(FDE.FIE))) %>% 
  melt(id.vars = c("Country", "Year", "break_year", "position_PGSR", "position_DEIE"))

```

```{r decomp_pgsr}

## Core
decomp_pgsr = decomp2 %>% 
  subset(break_year == break_year) %>% 
  subset(variable %in% c("FPG.TSR", "TPG.FSR", "FPG.FSR")) %>% 
  mutate(Country = factor(Country, levels = c("United States","France"))) %>% 
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable), alpha = .5) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  facet_wrap(Country ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  # scale_y_continuous(limits = c(-4,6)) +
  theme_classic(base_size = 14) +
  theme(legend.direction = "horizontal", legend.box = "horizontal", legend.position = "bottom",
        axis.title.x = element_blank()) +
  labs(x = "", y = "Difference with counterfactual (in pp.)")
  
## Paper version
decomp_pgsr + 
  geom_line(aes(y = position_PGSR), color = "black") +
  scale_fill_grey(breaks = c("FPG.TSR", "TPG.FSR", "FPG.FSR"),
                  labels = c("Population growth effect", "Survival rate effect", "Interaction effect"),
                  start = 0.2, end = 0.8,
                     name = element_blank()) +
  ggsave(file.path(loc_decomp, "decomp_PGSR.png"), width = scale_graph*5, height = scale_graph*5/2)

## Color version
decomp_pgsr + 
  geom_line(aes(y = position_PGSR), color = brewer.pal(8, "Set1")[1]) +
  scale_fill_manual(breaks = c("FPG.TSR", "TPG.FSR", "FPG.FSR"),
                  labels = c("Population growth effect", "Survival rate effect", "Interaction effect"),
                  values = brewer.pal(8, "Set1")[c(2:4)] %>% setNames(c("TPG.FSR", "FPG.TSR", "FPG.FSR")),
                     name = element_blank()) +
  ggsave(file.path(loc_decomp, "decomp_PGSR_color.png"), width = scale_graph*5, height = scale_graph*5/2)

```


```{r decomp_deie}

## Core
decomp_deie = decomp2 %>% 
  subset(variable %in% c("FDE.TIE", "TDE.FIE", "FDE.FIE")) %>% 
  mutate(Country = factor(Country, levels = c("United States","France"))) %>% 
  subset(break_year == break_year) %>% 
  
  ggplot(aes(x = Year)) +
  geom_col(aes(y = value, fill = variable), alpha = .5) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  facet_wrap(Country ~ .) +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  # scale_y_continuous(limits = c(-4,6)) +
  theme_classic(base_size = 14) +
  theme(legend.direction = "horizontal", legend.box = "horizontal",
        legend.position = "bottom", axis.title.x = element_blank()) +
  labs(x = "", y = "Difference with counterfactual (in pp.)")

## Paper version
decomp_deie +
  geom_line(aes(y = position_DEIE), color = "black") +
  scale_fill_grey(breaks = c("FDE.TIE", "TDE.FIE", "FDE.FIE"), 
                  labels = c("Direct cohort effect", "Indirect cohort effect", "Interaction effect"),
                  start = 0.2, end = 0.8,
                     name = element_blank()) +
  ggsave(file.path(loc_decomp, "decomp_DEIE.png"), width = scale_graph*5, height = scale_graph*5/2)

## Color version
decomp_deie +
  geom_line(aes(y = position_DEIE), color = "black") +
  scale_fill_manual(breaks = c("FDE.TIE", "TDE.FIE", "FDE.FIE"), 
                  labels = c("Direct cohort effect", "Indirect cohort effect", "Interaction effect"),
                  values = brewer.pal(8, "Set1")[c(8,5,4)] %>% setNames(c("FDE.TIE", "TDE.FIE", "FDE.FIE")),
                     name = element_blank()) +
  ggsave(file.path(loc_decomp, "decomp_DEIE_color.png"), width = scale_graph*5, height = scale_graph*5/2)
  
    
```

```{r exp_power}

# Compute the share of each effect/channel for two sub_periods 1980-2010 & 2020-2050
decomp_mean.period = decomp2 %>% 
  select(-contains("position")) %>% 
  dcast(Country + Year + break_year ~ variable) %>% 
  mutate(Country_break = interaction(break_year, Country, sep = " - "),
         Period = ifelse(Year %in% c(1970:2010), "P1",
                         ifelse(Year %in% c(2020:2050), "P2", "P3"))) %>% 
  subset(Period != "P3") %>% 
  group_by(Country_break, Period) %>% 
  select(Country_break, Period, TPG.FSR.share, FPG.TSR.share, FPG.FSR.share,
         FDE.TIE.share, TDE.FIE.share, FDE.FIE.share) %>% 
  summarise_at(vars(TPG.FSR.share:FDE.FIE.share), mean, na.rm = TRUE)

# Visualization
decomp_mean.period

```


```{r decomp_country_period}

## Core
decomp_country_period = decomp_mean.period %>% 
  melt(id.vars = c("Country_break", "Period")) %>% 
  mutate(value = value*100) %>% 
  subset(Country_break %in% c("1970 - France", "1970 - United States")) %>% 
  mutate(Country = ifelse(Country_break == "1970 - France", "France", "United States"),
         effect = factor(ifelse(variable %>% grepl(pattern = "PG", .), "first", "second")),
         Period = ifelse(Period == "P1", "1980-2010", "2020-2050")) %>% 
  mutate(Country = factor(Country, levels = c("United States","France"))) %>% 
  
  ggplot(aes(x = effect, y = value, fill = variable)) +
  facet_grid(Period ~ Country) +
  scale_x_discrete(breaks = c("first", "second"), labels = c("Determinants", "Channels")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "bottom", axis.title.x = element_blank()) +
  labs(x = "", y = "Percent")

## Paper version
decomp_country_period +
  geom_bar(stat = "identity", position = position_dodge(), color = "black") +
  scale_fill_manual(name = "",
                    breaks = c("TPG.FSR.share", "FPG.TSR.share",
                               "FDE.TIE.share", "TDE.FIE.share", "FDE.FIE.share"),
                    labels = c("Survival rate", "Population growth",
                               "Direct cohort", "Indirect cohort", "Interaction"),
                    values = c("#191919", "#7C7C7C", "#E6E6E6", "#A8A8A8", "#CACACA", "#E6E6E6") %>% 
                      setNames(c("TPG.FSR.share", "FPG.TSR.share", "FPG.FSR.share",
                               "FDE.TIE.share", "TDE.FIE.share", "FDE.FIE.share"))) +
  ggsave(file.path(loc_decomp, "decomp_country_period.png"),
         width = scale_graph*5, height = scale_graph*5/2)

## Color version
decomp_country_period +
  geom_bar(stat = "identity", position = position_dodge(), alpha = 0.5, color = "black") +
  scale_fill_manual(name = "",
                    breaks = c("TPG.FSR.share", "FPG.TSR.share",
                               "FDE.TIE.share", "TDE.FIE.share", "FDE.FIE.share"),
                    labels = c("Survival rate", "Population growth",
                               "Direct cohort", "Indirect cohort", "Interaction"),
                    values = brewer.pal(8, "Set1")[c(2,3,4,8,5,4)] %>% 
                      setNames(c("TPG.FSR.share", "FPG.TSR.share", "FPG.FSR.share",
                                 "FDE.TIE.share", "TDE.FIE.share", "FDE.FIE.share"))) +
  ggsave(file.path(loc_decomp, "decomp_country_period_color.png"),
         width = scale_graph*5, height = scale_graph*5/2)

```


### Retirement age

```{r retage_init}

# Define break_year
break_year = 2020
# Define first years after the reform
first_years = seq(break_year+10, (break_year+40), by = 10)

# Location retirement
loc_ret = file.path(loc_result, "retirement")

# Reset ret_age
ret_age = NULL
```


#### Specification 1 

```{r sim_retage_spe1}

# Re initialize result data frame
result = result[0,]

# Size of the shock (in %)
shock = -1/10

# Specification
ret_spe = 1
spe = paste0("ret_age_", break_year, "_spe", ret_spe)

# Prepare data
data = data_base %>% 
  # No biased technical change
  mutate(AK = 1, AL = 1) %>% 
  # Add parameters
  merge(param) %>% 
  # Demography
  demo_changer(break_year = break_year, p1_equals_p_fix = FALSE) %>% 
  # Define specification model
  mutate(Specification = spe) %>%
  # Reorder variables
  select(Specification, everything()) %>% 
  
  ## Modification of demographic data
  
  group_by(Country, Sequence) %>% 
  mutate(# New p, p1 and n
         p.new = ifelse(Year > break_year, p*(1+shock), p),
         p1.new = ifelse(Year > break_year, p1*(1+shock), p1),
         n.new = ifelse(Year %in% first_years, n*(1-shock), n),
         #*(1-1/40*(Year-break_year-10))
         # Compute Ny and No for the affected periods
         Ny.new = ifelse(Year %in% first_years, Ny*(1-shock), NA),
         No.new = ifelse(Year %in% first_years, No*(1+shock), NA),
         
         # Compute Ny and No for last sequence/periods
         Ny.new = ifelse(Year > max(first_years), lag(Ny.new,1)*n, Ny.new),
         No.new = ifelse(Year > max(first_years), lag(Ny.new,1)*p.new, No.new),
         
         # Recompute eta
         eta.new = n.new/p.new*(1+alpha*p1.new)/omega,
         
         # Replace values
         Ny = ifelse(is.na(Ny.new), Ny, Ny.new),
         No = ifelse(is.na(No.new), No, No.new),
         n = n.new,
         p = p.new,
         p1 = p1.new,
         eta = eta.new,
         
         ) %>% 
  select(Specification, Country, Year, Sequence, Period, Ny, No, n, p, p1, 
         eta, everything(), -contains("new"), ) %>%
  ungroup()

# Simulate the model for each country
for(country in country_set){
  result = data %>%
  subset(Country == country) %>% 
  model(time = 3) %>% 
  rbind(result, .)
}

# Remove duplicates
ret_age = distinct(result)

```

#### Specification 2

```{r sim_retage_spe2}

# Re initialize result data frame
result = result[0,]

# Fraction
frac = 0

# Specification
ret_spe = 2
spe = paste0("ret_age_", break_year, "_spe", ret_spe)

# Prepare data
data = data_base %>% 
  # No biased technical change
  mutate(AK = 1, AL = 1) %>% 
  # Add parameters
  merge(param) %>% 
  # Demography
  demo_changer(break_year = break_year, p1_equals_p_fix = FALSE) %>% 
  # Define specification model
  mutate(Specification = spe) %>%
  # Reorder variables
  select(Specification, everything()) %>% 
  # Merge witj break year
  merge(., data_base %>% 
          subset(Year == break_year) %>%
          select(Country, p_fix = p), by = "Country") %>% 
  
  ## Modification of demographic data
  
  group_by(Country, Sequence) %>% 
  mutate(
         p1_to_p_dist = p1 - p,
         # New p and p1
         p.new = ifelse(Year > break_year, frac*(p-p_fix) + p_fix, p),
         p1.new = ifelse(Year > break_year & Period < 3, dplyr::lead(p.new,1),
                         ifelse(Period == 3, p.new + p1_to_p_dist*frac, p1)),
         # Scale for the affected periods
         shock = (p.new - p)/p,
         # New n
         n.new = ifelse(Year %in% first_years, n*(1-shock), n),
         #*(1-1/40*(Year-break_year-10))
         # Compute Ny and No for the affected periods
         Ny.new = ifelse(Year %in% first_years, Ny*(1-shock), NA),
         No.new = ifelse(Year %in% first_years, No*(1+shock), NA),
         
         # Compute Ny and No for last sequence/periods
         Ny.new = ifelse(Year > max(first_years), lag(Ny.new,1)*n, Ny.new),
         No.new = ifelse(Year > max(first_years), lag(Ny.new,1)*p.new, No.new),
         
         # Recompute eta
         eta.new = n.new/p.new*(1+alpha*p1.new)/omega,
         
         # Replace values
         Ny = ifelse(is.na(Ny.new), Ny, Ny.new),
         No = ifelse(is.na(No.new), No, No.new),
         n = n.new,
         p = p.new,
         p1 = p1.new,
         eta = eta.new,
         
         ) %>% 
  select(Specification, Country, Year, Sequence, Period, Ny, No, n, p, p1, 
         eta, everything(), -contains("new"), -shock, -p_fix, -p1_to_p_dist ) %>%
  ungroup()

# Simulate the model for each country
for(country in country_set){
  result = data %>%
  subset(Country == country) %>% 
  model(time = 3) %>% 
  rbind(result, .)
}


# Remove duplicates
ret_age = rbind(ret_age, distinct(result))

```

#### Specification 3

```{r sim_retage_spe3}

# Re initialize result data frame
result = result[0,]

# Fraction
frac = 0.5

# Specification
ret_spe = 3
spe = paste0("ret_age_", break_year, "_spe", ret_spe)

# Prepare data
data  = data_base %>% 
  # No biased technical change
  mutate(AK = 1, AL = 1) %>% 
  # Add parameters
  merge(param) %>% 
  # Demography
  demo_changer(break_year = break_year, p1_equals_p_fix = FALSE) %>% 
  # Define specification model
  mutate(Specification = spe) %>%
  # Reorder variables
  select(Specification, everything()) %>% 
  # Merge witj break year
  merge(., data_base %>% 
          subset(Year == break_year) %>%
          select(Country, p_fix = p), by = "Country") %>% 
  
  ## Modification of demographic data
  
  group_by(Country, Sequence) %>% 
  mutate(
         p1_to_p_dist = p1 - p,
         # New p and p1
         p.new = ifelse(Year > break_year, frac*(p-p_fix) + p_fix, p),
         p1.new = ifelse(Year > break_year & Period < 3, dplyr::lead(p.new,1),
                         ifelse(Period == 3, p.new + p1_to_p_dist*frac, p1)),
         # Scale for the affected periods
         shock = (p.new - p)/p,
         # New n
         n.new = ifelse(Year %in% first_years, n*(1-shock), n),
         
         # Compute Ny and No for the affected periods
         Ny.new = ifelse(Year %in% first_years, Ny*(1-shock), NA),
         No.new = ifelse(Year %in% first_years, No*(1+shock), NA),
         
         # Compute Ny and No for last sequence/periods
         Ny.new = ifelse(Year > max(first_years), lag(Ny.new,1)*n, Ny.new),
         No.new = ifelse(Year > max(first_years), lag(Ny.new,1)*p.new, No.new),
         
         # Recompute eta
         eta.new = n.new/p.new*(1+alpha*p1.new)/omega,
         
         # Replace values
         Ny = ifelse(is.na(Ny.new), Ny, Ny.new),
         No = ifelse(is.na(No.new), No, No.new),
         n = n.new,
         p = p.new,
         p1 = p1.new,
         eta = eta.new,
         
         ) %>% 
  select(Specification, Country, Year, Sequence, Period, Ny, No, n, p, p1, 
         eta, everything(), -contains("new"), -shock, -p_fix, -p1_to_p_dist ) %>%
  ungroup()

# Simulate the model for each country
for(country in country_set){
  result = data %>%
  subset(Country == country) %>% 
  model(time = 3) %>% 
  rbind(result, .)
}


# Remove duplicates
ret_age = rbind(ret_age, distinct(result))

```

#### Summary RetAge

```{r retage_save}

# Write ret_age
write.csv(ret_age, file.path(loc_sim, "ret_age.csv"), row.names = FALSE)

```

```{r retage_ls_all}

## Core
retage_ls_all = fillgap %>%
  rbind(., baseline %>% subset(Country == "United States")) %>% 
  mutate(Specification = "base2") %>% 
  select(Specification, Country, Year, theta) %>% 
  melt(id.vars = c("Specification" ,"Country", "Year")) %>% 
  rbind(.,
        df %>% 
          mutate(Specification = "data") %>%
          select(Specification, Country, Year, theta) %>%
          setNames(c("Specification","Country", "Year", "data")) %>% 
          melt(id.vars = c("Specification", "Country", "Year"))
        ) %>%
  filter(complete.cases(.)) %>% 
  subset(Year %in% c(1970:2080)) %>%
  # Trick to put data line under others
  mutate(variable = as.character(variable),
         variable = ifelse(variable == "data", "a.data", variable),
         variable = as.factor(variable)) %>% 
  
  rbind(., ret_age %>% 
          select(Specification, Country, Year, theta) %>%
          melt(id.vars = c("Specification" ,"Country", "Year"))) %>% 
  mutate(Country = factor(Country, levels = c("United States","France"))) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Specification)) +
  geom_line() +
  facet_wrap(Country ~ ., scales = "fixed") +
  scale_x_continuous(breaks = breaks_10_years, labels = labs_20_years) +
  theme_classic(base_size = 14) +
  theme(legend.position = c(0.49, 0.99), legend.justification = c("right", "top"),
        legend.direction = "vertical",
        legend.box = "horizontal",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.text.align = 0) +
  labs(x = "", y = "") 

## Paper version
retage_ls_all +
  scale_color_manual(name = "",
                     breaks = c("data", "base2", "ret_age_2020_spe1", "ret_age_2020_spe2",
                                "ret_age_2020_spe3"),
                     labels = c("Data", "Benchmark", "Shift -10%", "Constant", "Half growth"),
                     values = c("grey", rep("black", 4)) %>%
                       setNames(c("data","base2", "ret_age_2020_spe1", "ret_age_2020_spe2",
                                "ret_age_2020_spe3"))) +
  scale_linetype_manual(name = "",
                        breaks = c("data", "base2", "ret_age_2020_spe1", "ret_age_2020_spe2",
                                "ret_age_2020_spe3"),
                        labels = c("Data", "Benchmark", "Shift -10%", "Constant", "Half growth"),
                        values = c("solid", "solid", "dashed", "dotdash", "dotted") %>% 
                          setNames(c("data","base2", "ret_age_2020_spe1", "ret_age_2020_spe2",
                                "ret_age_2020_spe3"))) +
  ggsave(file.path(loc_ret, "retage_ls_all.png"), width = scale_graph*5, height = scale_graph*5/2)

## Color version
retage_ls_all +
  aes(color = interaction(variable, Country)) +
  scale_color_manual(name = "",
                     breaks = c("a.data.France", "a.data.United States",
                                "theta.France", "theta.United States"),
                     values = c(rep("black", 2), brewer.pal(8, "Set1")[c(1,2)]) %>%
                       setNames(c("a.data.France", "a.data.United States",
                                "theta.France", "theta.United States")),
                     guide = FALSE) +
  scale_linetype_manual(name = "",
                        breaks = c("base2", "ret_age_2020_spe1", "ret_age_2020_spe2",
                                "ret_age_2020_spe3"),
                        labels = c("Benchmark", "Shift -10%", "Constant", "Half growth"),
                        values = c("solid", "solid", "dashed", "dotdash", "dotted") %>% 
                          setNames(c("data","base2", "ret_age_2020_spe1", "ret_age_2020_spe2",
                                "ret_age_2020_spe3"))) +
  ggsave(file.path(loc_ret, "retage_ls_all_color.png"), width = scale_graph*5, height = scale_graph*5/2)

```

```{r retage_p}

## Core
retage_p = fillgap %>%
  rbind(., baseline %>% subset(Country == "United States")) %>% 
  mutate(Specification = "base2") %>% 
  select(Specification, Country, Year, p, p1) %>% 
  melt(id.vars = c("Specification" ,"Country", "Year")) %>% 
  subset(Year %in% c(1970:2080)) %>%
  
  rbind(., ret_age %>% 
          select(Specification, Country, Year, p, p1) %>%
          melt(id.vars = c("Specification" ,"Country", "Year"))) %>% 
  subset(Year >= 2020) %>% 
  mutate(Country = factor(Country, levels = c("United States", "France"))) %>% 
  
  ggplot(aes(x = Year, y = value, color = Specification, linetype = variable)) +
  geom_line() +
  facet_wrap(Country ~ ., scales = "fixed") +
  scale_x_continuous(breaks = seq(2020, 2080, 10),
                     labels = c("2020", "", "2040", "", "2060", "", "2080")) +
  theme_classic(base_size = 14) +
  theme(legend.position = c(0.01, 0.99), legend.justification = c("left", "top"),
        legend.direction = "vertical",
        legend.box = "horizontal",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.text.align = 0) +
  labs(x = "Year", y = "Labor share") +
  guides(linetype = guide_legend(order = 1), color = guide_legend(order = 2))

## Paper version
retage_p +
  aes(color = variable, linetype = Specification) +
  scale_linetype_manual(breaks = c("base2", "ret_age_2020_spe1", "ret_age_2020_spe2", "ret_age_2020_spe3"), 
                        labels = c("Benchmark", "Shift -10%", "Constant", "Half growth"),
                        values = c("solid", "dashed", "dotdash", "dotted") %>% 
                          setNames(c("base2", "ret_age_2020_spe1", "ret_age_2020_spe2", "ret_age_2020_spe3")),
                     name = element_blank()) +
  scale_color_grey(breaks = c("p", "p1"),  labels = c(expression(p[t]), expression(p[t+1])),
                     name = element_blank(),
                   start = 0, end = 0.6) +
  ggsave(file.path(loc_ret, "retage_p.png"), width = scale_graph*5, height = scale_graph*5/2)

## Color version
retage_p +
  scale_color_manual(breaks = c("base2", "ret_age_2020_spe1", "ret_age_2020_spe2", "ret_age_2020_spe3"),
                     labels = c("Benchmark", "Shift -10%", "Constant", "Half growth"),
                    values = c("black", brewer.pal(8, "Set1")[c(1:3)]) %>% 
                      setNames(c("base2", "ret_age_2020_spe1", "ret_age_2020_spe2",
                                "ret_age_2020_spe3")),
                     name = element_blank()) +
  scale_linetype_manual(breaks = c("p", "p1"),
                     labels = c(expression(p[t]), expression(p[t+1])),
                        values = c("solid", "dashed") %>% setNames(c("p", "p1")),
                     name = element_blank()) +
  ggsave(file.path(loc_ret, "retage_p_color.png"), width = scale_graph*5, height = scale_graph*5/2)

```



```{r retage_ls}

## Core
retage_ls = fillgap %>%
  rbind(., baseline %>% subset(Country == "United States")) %>% 
  mutate(Specification = "base2") %>% 
  select(Specification, Country, Year, theta) %>% 
  melt(id.vars = c("Specification" ,"Country", "Year")) %>% 
  subset(Year %in% c(1970:2080)) %>%
  
  rbind(., ret_age %>% 
          select(Specification, Country, Year, theta) %>%
          melt(id.vars = c("Specification" ,"Country", "Year"))) %>% 
  subset(Year >= 2020) %>% 
  mutate(Country = factor(Country, levels = c("United States", "France"))) %>% 
  
  ggplot(aes(x = Year, y = value, color = Specification, linetype = Specification)) +
  geom_line() +
  facet_wrap(Country ~ ., scales = "fixed") +
  scale_x_continuous(breaks = seq(2020, 2080, 10),
                     labels = c("2020", "", "2040", "", "2060", "", "2080")) +
  theme_classic(base_size = 14) +
  theme(legend.position = c(0.49, 0.99), legend.justification = c("right", "top"),
        legend.direction = "vertical",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.text.align = 0) +
  labs(x = "Year", y = "Labor share")

## Paper version
retage_ls +
  scale_color_manual(name = "",
                     breaks = c("base2", "ret_age_2020_spe1", "ret_age_2020_spe2",
                                "ret_age_2020_spe3"),
                     labels = c("Benchmark", "Shift -10%",
                                "Constant", "Half growth"),
                     values = c(rep("black", 4)) %>% 
                       setNames(c("base2", "ret_age_2020_spe1", "ret_age_2020_spe2",
                                "ret_age_2020_spe3"))) +
  scale_linetype_manual(name = "",
                        breaks = c("base2", "ret_age_2020_spe1", "ret_age_2020_spe2",
                                "ret_age_2020_spe3"),
                        labels = c("Benchmark", "Shift -10%",
                                "Constant", "Half growth"),
                        values = c("solid", "dashed", "dotdash", "dotted") %>% 
                          setNames(c("base2", "ret_age_2020_spe1", "ret_age_2020_spe2",
                                "ret_age_2020_spe3"))) +
  ggsave(file.path(loc_ret, "retage_ls.png"), width = scale_graph*5, height = scale_graph*5/2)

## Color version
retage_ls +
  scale_color_manual(name = "",
                     breaks = c("base2", "ret_age_2020_spe1", "ret_age_2020_spe2",
                                "ret_age_2020_spe3"),
                     labels = c("Benchmark", "Shift -10%",
                                "Constant", "Half growth"),
                     values = c("black", brewer.pal(8, "Set1")[c(1:3)]) %>% 
                       setNames(c("base2", "ret_age_2020_spe1", "ret_age_2020_spe2",
                                "ret_age_2020_spe3"))) +
  scale_linetype_manual(name = "",
                        breaks = c("base2", "ret_age_2020_spe1", "ret_age_2020_spe2",
                                "ret_age_2020_spe3"),
                        labels = c("Benchmark", "Shift -10%",
                                "Constant", "Half growth"),
                        values = c("solid", "dashed", "dashed", "dashed") %>% 
                          setNames(c("base2", "ret_age_2020_spe1", "ret_age_2020_spe2",
                                "ret_age_2020_spe3"))) +
  ggsave(file.path(loc_ret, "retage_ls_color.png"), width = scale_graph*5, height = scale_graph*5/2)

```

```{r retage_others}
## Core
retage_others = fillgap %>%
  rbind(., baseline %>% subset(Country == "United States")) %>% 
  mutate(Specification = "base2") %>% 
  rbind(ret_age) %>% 
  mutate(source = ifelse(Specification == "base2", "base2","ret_age"),
         from = interaction(Specification, Country)) %>% 
  group_by(from) %>% 
  mutate(
    "YL" = Y/L,
    `b share` = b*u*Ny/tau/Y,
    `h share` = h*No/tau/Y,
    bh = b/h,
    net = 1-tau,
    outside = b/(1-tau),
    # Demography
    "n" = n/n[Year == 2020] -1,
    "p" = p/p[Year == 2020] -1,
    "p[+1]" = p1/p1[Year == 2020] -1,
    "eta" = eta/eta[Year == 2020] -1,
    # Public
    "tau" = tau/tau[Year == 2020] -1,
    # "b" = b/b[Year == 2020]-1,
    # "h" = h/h[Year == 2020]-1,
    "`b share`" = `b share`/`b share`[Year == 2020]-1,
    "`h share`" = `h share`/`h share`[Year == 2020]-1,
    # "b/h" = bh/bh[Year == 2020]-1,
    # Outside option
    "b" = b/b[Year == 2020] -1,
    "b/(1-tau)" = outside/outside[Year == 2020] -1,
    # Bargaining
    "w" = w/w[Year == 2020] -1,
    "X" = X/X[Year == 2020] -1,
    # Production
    "K" = K/K[Year == 2020] -1,
    "L" = L/L[Year == 2020] -1,
    "Y" = Y/Y[Year == 2020] -1,
    # Unemployment
    "N^y" = Ny/Ny[Year == 2020] -1,
    "u" = u/u[Year == 2020] -1,
    # Labor share
    "Y/L" = YL/YL[Year == 2020] -1,
    "theta" = theta/theta[Year == 2020] -1) %>% 
  ungroup() %>% 
  select(from, source, Specification, Country , Year,
         "Population~growth~(n)"= "n", 
         "Survival~rate~(p)"= "p", 
         "Exp.~survival~rate~(p[+1])"= "p[+1]", 
         "Youth~political~weight~(eta)" = "eta",
         "Tax~rate~(tau)" = "tau", 
         "Unemp.~benefits~share" = "`b share`",
         "Unemp.~benefits~(b)" = "b", 
         "Outside~option" = "b/(1-tau)",
         "Wage~rate~(w)" = "w", 
         "Job~value~added~(X)" = "X",
         #"Capital~stock~(K)" = "K", 
         "Labor~(L)" = "L", 
         "Production~(Y)" = "Y",
         "Young~households~(N^y)" = "N^y",
         "Unemployment~rate~(u)" = "u",
         "Prod.~per~worker~(Y/L)" = "Y/L", 
         "Labor~share~(theta)" = "theta") %>% 
  subset(Year %in% c(2020:2080)) %>% 
  melt(id.vars = c("from", "source", "Specification", "Country", "Year"))

```


```{r retage_others_fr}

## Core
retage_others_fr = retage_others %>% 
  subset(Country == "France") %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Specification)) +
  geom_hline(yintercept = 0, linetype = "dotted", alpha = 0.5) +
  geom_line() +
  facet_wrap(.~variable, ncol = 4, labeller = label_parsed) +
  scale_x_continuous(breaks = seq(2020, 2080, 10),
                     labels = c("2020", "", "2040", "", "2060", "", "2080")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "bottom", legend.direction = "horizontal",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
retage_others_fr +
  scale_linetype_manual(name = "",
                        breaks = c("base2", "ret_age_2020_spe1",
                                "ret_age_2020_spe2", "ret_age_2020_spe3"),
                        labels = c("Benchmark", "Shift -10%", "Constant", "Half growth"),
                        values = c("solid", "dashed", "dotdash", "dotted")) +
  scale_color_manual(name = "",
                     breaks = c("base2", "ret_age_2020_spe1",
                                "ret_age_2020_spe2", "ret_age_2020_spe3"),
                     labels = c("Benchmark", "Shift -10%", "Constant", "Half growth"),
                     values = rep("black",4)) +
  ggsave(file.path(loc_ret, "retage_others_fr.png"), width = scale_graph*5, height = scale_graph*5)

## Color version
retage_others_fr +
  scale_linetype_manual(name = "",
                        breaks = c("base2", "ret_age_2020_spe1",
                                "ret_age_2020_spe2", "ret_age_2020_spe3"),
                        labels = c("Benchmark", "Shift -10%", "Constant", "Half growth"),
                        values = c("solid", "dashed", "dotdash", "dotted")) +
  scale_color_manual(name = "",
                     breaks = c("base2", "ret_age_2020_spe1",
                                "ret_age_2020_spe2", "ret_age_2020_spe3"),
                     labels = c("Benchmark", "Shift -10%", "Constant", "Half growth"),
                     values = c("black", brewer.pal(8, "Set1")[c(1:3)])) +
  ggsave(file.path(loc_ret, "retage_others_fr_color.png"), width = scale_graph*5, height = scale_graph*5)

```

```{r retage_others_us}

## Core
retage_others_us = retage_others %>% 
  subset(Country == "United States") %>% 
  
  ggplot(aes(x = Year, y = value, linetype = Specification, color = Specification)) +
  geom_hline(yintercept = 0, linetype = "dotted", alpha = 0.5) +
  geom_line() +
  facet_wrap(.~variable, ncol = 4, labeller = label_parsed) +
  scale_x_continuous(breaks = seq(2020, 2080, 10),
                     labels = c("2020", "", "2040", "", "2060", "", "2080")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "bottom", legend.direction = "horizontal",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "")

## Paper version
retage_others_us +
  scale_linetype_manual(name = "",
                        breaks = c("base2", "ret_age_2020_spe1",
                                "ret_age_2020_spe2", "ret_age_2020_spe3"),
                        labels = c("Benchmark", "Shift -10%", "Constant", "Half growth"),
                        values = c("solid", "dashed", "dotdash", "dotted")) +
  scale_color_manual(name = "",
                     breaks = c("base2", "ret_age_2020_spe1",
                                "ret_age_2020_spe2", "ret_age_2020_spe3"),
                     labels = c("Benchmark", "Shift -10%", "Constant", "Half growth"),
                     values = rep("black",4)) +
  ggsave(file.path(loc_ret, "retage_others_us.png"), width = scale_graph*5, height = scale_graph*5)

## Color version
retage_others_us +
  scale_linetype_manual(name = "",
                        breaks = c("base2", "ret_age_2020_spe1",
                                "ret_age_2020_spe2", "ret_age_2020_spe3"),
                        labels = c("Benchmark", "Shift -10%", "Constant", "Half growth"),
                        values = c("solid", "dashed", "dotdash", "dotted")) +
  scale_color_manual(name = "",
                     breaks = c("base2", "ret_age_2020_spe1",
                                "ret_age_2020_spe2", "ret_age_2020_spe3"),
                     labels = c("Benchmark", "Shift -10%", "Constant", "Half growth"),
                     values = c("black", brewer.pal(8, "Set1")[c(1:3)])) +
  ggsave(file.path(loc_ret, "retage_others_us_color.png"), width = scale_graph*5, height = scale_graph*5)

```




```{r Other variables, echo = FALSE}

fillgap %>%
  rbind(., baseline %>% subset(Country == "United States")) %>% 
  mutate(Specification = "base2") %>% 
  rbind(ret_age) %>% 
  mutate(source = ifelse(Specification == "base2", "base2","ret_age"),
         from = interaction(Specification, Country)) %>% 
  group_by(from) %>% 
  mutate(`b share` = b*u*Ny/tau/Y,
         `h share` = h*No/tau/Y,
         bh = b/h,
    # Deviation from the 2020 steady state
         "eta" = eta/eta[Year == 2020] -1,
         "tau" = tau/tau[Year == 2020] -1,
         "b" = b/b[Year == 2020]-1,
         "h" = h/h[Year == 2020]-1,
         "`b share`" = `b share`/`b share`[Year == 2020]-1,
         "`h share`" = `h share`/`h share`[Year == 2020]-1,
         "b/h" = bh/bh[Year == 2020]-1,
    # Rename countries
         Country = ifelse(Country == "France", "France", "United~States")) %>% 
  ungroup() %>% 
  select(from, source, Specification, Country , Year, c("eta", "tau", "`b share`")) %>% 
  subset(Year %in% c(2020:2080)) %>% 
  melt(id.vars = c("from", "source", "Specification", "Country", "Year")) %>% 
  
  ggplot(aes(x = Year, y = value, linetype = source, color = Specification)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line() +
  facet_grid(Country ~ variable, scale = "free", labeller = label_parsed) +
  scale_x_continuous(breaks = seq(2020, 2080, 10),
                     labels = c("2020", "", "2040", "", "2060", "", "2080")) +
  scale_linetype_manual(breaks = c("base2", "ret_age"), values = c("solid", "dashed")) +
  scale_color_manual(breaks = c("base2", "ret_age_2020_spe1",
                                "ret_age_2020_spe2", "ret_age_2020_spe3"),
                     values = c("black", brewer.pal(8, "Set1")[c(1:3)])) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none", legend.direction = "vertical",
        panel.spacing.x = unit(1.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  labs(x = "", y = "")

```

<!--chapter:end:main.Rmd-->

---
title: "X & Sigma condition"
author: "Fabien Petit"
date: "11/06/2019"
output: 
  github_document:	
    pandoc_args: --webtex
---

```{r init}	

# Load packages
packages <- c("dplyr", "ggplot2", "ggrepel", "RColorBrewer", "reshape2", "extrafont", "latex2exp")
lapply(packages, require, character.only = TRUE)
rm(packages)

# Define paths
loc_final = file.path("data", "final")
loc_result = file.path("result")

# Define country set
# country_set = c("Australia", "Canada", "France", "Italy", "Japan", "United States")
country_set = c("France", "United States")

# Graphic parameter
scale_graph = 1920/1080

```	

In the model, I obtain a condition on the capital-labor elasticity of substitution $\sigma$ and the unemployment replacement rate which ensures a positive capital-to-labor ratio and therefore a positive wage. This condition is the following :
$$
\frac{1}{\sigma} > X_t \equiv \ln\left[\frac{(1-\tau_t)w_t}{b_t}\right]
$$
where $X_t$ is the value-added to have a job in utility terms, $w_t$ is the wage rate, $tau_t$ the tax rate and $b_t$ the unemployment benefits per capita. Thus, it is possible to rewrite this condition such that :
$$
e^{-\frac{1}{\sigma}} < \frac{b_t}{(1-\tau_t)w_t}
$$
The right hand side of this inequality corresponds to the unemployment replacement rate. Hence, I check whether this constraint is feasible for OECD countries and particulary those considered in the simulation (i.e. France and United States).

Let plot the function $f(\sigma) = e^{-\frac{1}{\sigma}}$ for likely values of $\sigma$, so an interval between 0 and 3 :

```{r sigma_bar_plot}

# Define function
sigma = function(urep){
  F1 = - log(urep)^(-1)
  return(F1)
}

# Interval between 0 and 3 for feasible values of urep
interval = seq(0.001, 0.8, by = 0.001)

# Compute sigma values
xsigma = data.frame("Function", interval, sigma(interval)) %>% 
  setNames(c("Country", "interval", "sigma_values"))

## Add latex
xsigma %>% 
  ggplot(aes(x = interval, y = sigma_values)) +
  geom_line(size = 1) +
  theme_classic(base_size = 14) +
  labs(x = "Unemployment Replacement Rate", y = "Max Capital-labor elasticity of substitution")

```

```{r unemp_rep_rate}
# Load CWED data
cwed = read.csv(file.path(loc_final, "cwed.csv"), header = TRUE)

# Average, min and first value of Unemployment Replacement Rate
cwed = cwed %>% 
  group_by(Country) %>% 
  summarise(US100_min = min(US100.lin_inter, na.rm = TRUE),
         UC1000_min = min(UC1000.lin_inter, na.rm = TRUE),
         US100_mean = mean(US100.lin_inter, na.rm = TRUE),
         UC1000_mean = mean(UC1000.lin_inter, na.rm = TRUE),
         US100_first = first(na.omit(US100.lin_inter)),
         UC1000_first = first(na.omit(UC1000.lin_inter)))

# Visualization
cwed

```


```{r x_min}
# Country set
country_set = c("France", "United States")

# Select Min for France and US
min_x = cwed %>% 
  subset(Country %in% country_set) %>% 
  select(Country, US100_min) %>% 
  setNames(c("Country", "interval")) %>%
mutate(sigma_values = -log(interval)^(-1))

min_x
```


```{r xsigmacdt_plot}

### Plot

## Add latex
xsigma %>% 
  
  ggplot(aes(x = interval, y = sigma_values)) +
  geom_line() +
  # geom_label_repel(data = min_x,
  #                  aes(label = round(sigma_values,3), color = Country),
  #                  segment.color = "transparent") +
  # Horizontal line
  geom_segment(aes(x = 0, 
                   xend = min_x %>% 
                     subset(Country == "France") %>% pull("interval"),
                   y = min_x %>% 
                     subset(Country == "France") %>% pull("sigma_values"),
                   yend = min_x %>% 
                     subset(Country == "France") %>% pull("sigma_values")),
               linetype = "dashed") +
  # Horizontal line
  geom_segment(aes(x = 0,
                   xend = min_x %>% 
                     subset(Country == "United States") %>% pull("interval"),
                   y = min_x %>% 
                     subset(Country == "United States") %>% pull("sigma_values"),
                   yend = min_x %>% 
                     subset(Country == "United States") %>% pull("sigma_values")),
               linetype = "dashed") +
  # Vertical line
  geom_segment(aes(x = min_x %>% 
                     subset(Country == "France") %>% pull("interval"),
                   xend = min_x %>% 
                     subset(Country == "France") %>% pull("interval"),
                   y = 0,
                   yend = min_x %>% 
                     subset(Country == "France") %>% pull("sigma_values")),
               linetype = "dashed") +
  # Vertical line
  geom_segment(aes(x = min_x %>% 
                     subset(Country == "United States") %>% pull("interval"),
                   xend = min_x %>% 
                     subset(Country == "United States") %>% pull("interval"),
                   y = 0,
                   yend = min_x %>% 
                     subset(Country == "United States") %>% pull("sigma_values")),
               linetype = "dashed") + 
  annotate("text", x = 0.2, y = 0.3 + min_x %>% subset(Country == "France") %>% pull("sigma_values"),
           label = TeX(paste0('$\\bar{\\sigma}_{FR} = ',
           min_x %>% subset(Country == "France") %>% pull("sigma_values") %>% round(3), '$')),
           size = 5) +
  annotate("text", x = 0.2, y = -0.3 + min_x %>% subset(Country == "United States") %>% pull("sigma_values"),
           label = TeX(paste0('$\\bar{\\sigma}_{US} = ',
           min_x %>% subset(Country == "United States") %>% pull("sigma_values") %>% round(3), '$')),
           size = 5) +
  scale_x_continuous(expand = c(0,0),
                     breaks = c(0, 0.2, 0.4, min_x %>% 
                     subset(Country == "United States") %>% 
                       pull("interval"), min_x %>% 
                     subset(Country == "France") %>% 
                       pull("interval"), 0.6, 0.8),
                     labels = c("0.0", "0.2", "0.4", TeX("x_{US}"), TeX("x_{FR}"), "", "0.8")
                     )+
  scale_y_continuous(expand = c(0,0)) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none") +
  labs(x = "Unemployment Replacement Rate", y = "Capital-Labor Elasticity of Substitution") +
  ggsave(file.path(loc_result, "xsigma.png"), width = scale_graph*5, height = 5)

```









<!--chapter:end:xsigmacdt.Rmd-->

